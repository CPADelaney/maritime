<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Maritime MVP — Port Call Intelligence Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind + Alpine (ok for dev; use a proper build for production) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    @keyframes slideUp { from { transform: translateY(8px); opacity:.0 } to { transform: translateY(0); opacity:1 } }
    .animate-slide-up { animation: slideUp .25s ease-out forwards }
    .glass { background: rgba(255,255,255,.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px) }
    .card { border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,.06) }
    .chip { border-radius: 999px; padding: .125rem .5rem; font-size: .75rem; white-space: nowrap }
    .btn { border-radius: .5rem; font-weight: 600; }
    .btn-primary { background:#4f46e5; color:#fff }
    .btn-primary:hover { background:#4338ca }
    .btn-soft { background:#eef2ff; color:#4338ca }
    .btn-soft:hover { background:#e0e7ff }
    .btn-outline { border:1px solid #e5e7eb; background:#fff }
    .btn-outline:hover { background:#f9fafb }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .75rem; background:#f3f4f6; padding:.125rem .375rem; border-radius:.375rem; border:1px solid #e5e7eb }
    .badge { display:inline-flex; align-items:center; gap:.375rem; padding:.25rem .5rem; border-radius:999px; font-size:.75rem; background:#f1f5f9; color:#334155 }
    .field { border:1px solid #e5e7eb; border-radius:.5rem; padding:.5rem .75rem }
    .field:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.15) }
    .list-scroll { max-height: 240px; overflow-y:auto }
    .line-clamp-3 { display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-white min-h-screen text-slate-900">

  <script>
    // 1) Default to same-origin API; 2) set OVERRIDE_API_BASE to hard-code a remote API if needed.
    const OVERRIDE_API_BASE = ""; // e.g., "https://maritime-ee6i.onrender.com"
    const API_BASE = OVERRIDE_API_BASE || window.location.origin;
  </script>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6" x-data="portCallApp()" x-init="init()">

    <!-- Topbar -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold">⛴</div>
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold">Port Call Intelligence Platform</h1>
          <p class="text-slate-600 text-sm">Vessel search, fee estimation, and live compliance checks</p>
        </div>
      </div>
      <div class="text-sm text-right">
        <div>API: <span class="font-medium" :class="apiStatus === 'Online' ? 'text-green-600' : 'text-red-600'" x-text="apiStatus"></span></div>
        <div class="text-slate-500">Cache: <span x-text="cacheStats"></span></div>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Left Column -->
      <div class="space-y-4">

        <!-- Vessel Search -->
        <div class="glass card p-5 animate-slide-up">
          <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-5.5-5.5M10 18a8 8 0 100-16 8 8 0 000 16z"/></svg>
            Vessel Search
          </h2>

          <div class="space-y-3">
            <div class="flex gap-2">
              <input
                x-model="vesselQuery"
                @keyup.enter="searchVessel(1)"
                class="w-full field"
                placeholder="Enter vessel name…"
                :disabled="searchLoading"
              />
              <button
                @click="searchVessel(1)"
                :disabled="searchLoading || !vesselQuery.trim()"
                class="btn btn-primary px-3 py-2 disabled:opacity-50">
                <span x-show="!searchLoading">Search</span>
                <span x-show="searchLoading" class="inline-flex items-center gap-1">
                  <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                  Loading
                </span>
              </button>
            </div>

            <!-- Results -->
            <div x-show="vesselResults.length > 0" class="list-scroll space-y-2">
              <template x-for="(v, idx) in vesselResults" :key="v.VesselID ?? v.vesselid ?? idx">
                <button
                  @click="selectVessel(v)"
                  class="w-full text-left border border-gray-200 rounded-lg px-3 py-2 hover:bg-indigo-50 hover:border-indigo-300 transition-colors">
                  <div class="font-medium" x-text="v.VesselName || v.vesselname || '(unnamed)'"></div>
                  <div class="text-xs text-gray-500">
                    <span x-text="v.CallSign || '—'"></span> •
                    <span x-text="v.Flag || '—'"></span> •
                    <span x-text="v.VesselType || '—'"></span>
                  </div>
                </button>
              </template>
            </div>

            <!-- Empty / Error -->
            <div x-show="!searchLoading && vesselResults.length === 0 && vesselSearched" class="text-sm text-gray-500">
              No vessels found.
            </div>
            <div x-show="searchError" class="text-sm text-red-600" x-text="searchError"></div>

            <!-- Summary + Pagination -->
            <div class="flex items-center justify-between">
              <div x-show="vesselTotal > 0" class="text-xs text-gray-500">
                Showing <span x-text="vesselStart"></span>–<span x-text="vesselEnd"></span> of
                <span x-text="vesselTotal"></span>
              </div>
              <div x-show="vesselPages > 1" class="flex items-center gap-2">
                <button @click="prevVesselPage" :disabled="vesselPage <= 1" class="btn btn-outline px-2 py-1 disabled:opacity-50">Prev</button>
                <template x-if="vesselPage > 3"><button @click="goToVesselPage(1)" class="btn btn-outline px-2 py-1">1</button></template>
                <template x-if="vesselPage > 4"><span class="text-gray-400">…</span></template>
                <template x-for="p in pageWindow()" :key="p">
                  <button @click="goToVesselPage(p)" class="px-2 py-1 btn-outline btn"
                          :class="p === vesselPage ? 'bg-indigo-600 text-white border-indigo-600' : ''" x-text="p"></button>
                </template>
                <template x-if="vesselPage < vesselPages - 3"><span class="text-gray-400">…</span></template>
                <template x-if="vesselPage < vesselPages - 2">
                  <button @click="goToVesselPage(vesselPages)" class="btn btn-outline px-2 py-1" x-text="vesselPages"></button>
                </template>
                <button @click="nextVesselPage" :disabled="vesselPage >= vesselPages" class="btn btn-outline px-2 py-1 disabled:opacity-50">Next</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Selected Vessel -->
        <div x-show="selectedVessel" class="glass card p-5 animate-slide-up">
          <h3 class="text-lg font-semibold mb-3">Selected Vessel</h3>
          <div class="space-y-2 text-sm">
            <div><span class="text-gray-500">Name:</span> <span class="font-medium" x-text="selectedVessel ? (selectedVessel.VesselName || '—') : '—'"></span></div>
            <div><span class="text-gray-500">Call Sign:</span> <span x-text="selectedVessel ? (selectedVessel.CallSign || '—') : '—'"></span></div>
            <div><span class="text-gray-500">Flag:</span> <span x-text="selectedVessel ? (selectedVessel.Flag || '—') : '—'"></span></div>
            <div><span class="text-gray-500">Type:</span> <span x-text="selectedVessel ? (selectedVessel.VesselType || '—') : '—'"></span></div>
            <div x-show="selectedVessel && selectedVessel.YearBuilt"><span class="text-gray-500">Year Built:</span> <span x-text="selectedVessel ? (selectedVessel.YearBuilt || '') : ''"></span></div>
            <div x-show="selectedVessel && selectedVessel.PrimaryIdentification"><span class="text-gray-500">Identification:</span> <span x-text="selectedVessel ? (selectedVessel.PrimaryIdentification || '') : ''"></span></div>
            <div x-show="selectedVessel && selectedVessel.GrossTonnage"><span class="text-gray-500">Gross Tonnage:</span> <span x-text="selectedVessel ? (selectedVessel.GrossTonnage || '') : ''"></span></div>
            <div x-show="selectedVessel && selectedVessel.LOA_m"><span class="text-gray-500">LOA:</span> <span x-text="selectedVessel ? (Number(selectedVessel.LOA_m || 0).toFixed(2) + ' m') : ''"></span></div>
            <div x-show="selectedVessel && selectedVessel.Beam_m"><span class="text-gray-500">Beam:</span> <span x-text="selectedVessel ? (Number(selectedVessel.Beam_m || 0).toFixed(2) + ' m') : ''"></span></div>
            <div x-show="selectedVessel && selectedVessel.Draft_m"><span class="text-gray-500">Draft:</span> <span x-text="selectedVessel ? (Number(selectedVessel.Draft_m || 0).toFixed(2) + ' m') : ''"></span></div>
          </div>
        </div>

        <!-- Port & ETA + v1/v2 controls -->
        <div class="glass card p-5">
          <h3 class="text-lg font-semibold mb-3">Port & ETA</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Port (internal)</label>
              <div class="relative" @click.away="showPortDropdown = false">
                <input
                  x-model="portQuery"
                  @input="searchPorts(false, 'single')"
                  @focus="searchPorts(true)"
                  @keydown.enter.prevent="selectFirstPortResult()"
                  class="w-full field pr-16"
                  placeholder="Search zone, port, or terminal…"
                />
                <button
                  type="button"
                  class="absolute inset-y-0 right-0 px-3 text-sm font-medium text-indigo-600 hover:text-indigo-700"
                  x-show="portQuery"
                  @click="clearPortQuery"
                >
                  Clear
                </button>
                <div
                  x-show="showPortDropdown"
                  class="absolute z-20 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg list-scroll"
                >
                  <template x-for="p in filteredPorts" :key="`single-${p.type}-${p.zoneCode}-${p.portCode || ''}-${p.terminalCode || p.terminalName || ''}`">
                    <button
                      type="button"
                      class="w-full text-left px-3 py-2 hover:bg-indigo-50"
                      @click="selectPort(p)"
                    >
                      <div class="font-medium text-slate-800" x-text="portResultTitle(p)"></div>
                      <div class="text-xs text-slate-500 mt-1" x-text="portResultDescription(p)"></div>
                      <div class="mt-1 flex flex-wrap gap-1 text-[11px] text-slate-500">
                        <span class="chip bg-indigo-50 text-indigo-600" x-show="p.zoneCode" x-text="p.zoneCode"></span>
                        <span class="chip bg-slate-100" x-show="p.portCode" x-text="p.portCode"></span>
                        <span class="chip bg-slate-100" x-show="p.terminalCode" x-text="p.terminalCode"></span>
                      </div>
                      <div class="text-[11px] text-slate-400 mt-0.5" x-show="p.operator" x-text="p.operator"></div>
                    </button>
                  </template>
                </div>
              </div>
              <div class="text-xs text-slate-500 mt-1">
                Selects the zone code required for downstream APIs. Try “Bellingham” or “Los Angeles”.
              </div>

              <div x-show="selectedPortContext" class="mt-2 text-xs text-slate-600 space-y-1">
                <div class="flex items-center gap-2">
                  <span class="font-semibold" x-text="selectedPortContext.zoneName"></span>
                  <span class="chip bg-indigo-50 text-indigo-600" x-text="selectedPortContext.zoneCode"></span>
                </div>
                <template x-if="selectedPortContext.portName">
                  <div>
                    <span class="text-slate-500">Port:</span>
                    <span class="font-medium" x-text="selectedPortContext.portName"></span>
                    <span class="chip bg-slate-100 ml-1" x-text="selectedPortContext.portCode"></span>
                  </div>
                </template>
                <template x-if="selectedPortContext.terminalName">
                  <div>
                    <span class="text-slate-500">Terminal:</span>
                    <span class="font-medium" x-text="selectedPortContext.terminalName"></span>
                    <span class="chip bg-slate-100 ml-1" x-text="selectedPortContext.terminalCode || '—'"></span>
                  </div>
                </template>
                <template x-if="selectedPortContext.operator">
                  <div class="text-[11px] text-slate-500">Operator: <span x-text="selectedPortContext.operator"></span></div>
                </template>
                <div class="text-[11px] text-slate-400" x-show="selectedPortContext.description" x-text="selectedPortContext.description"></div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ETA</label>
              <input x-model="eta" type="date" class="w-full field" />
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Arrival Type (v1)</label>
                <select x-model="arrivalType" class="w-full field">
                  <option value="FOREIGN">FOREIGN</option>
                  <option value="COASTWISE">COASTWISE</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Net Tonnage (v1)</label>
                <input
                  x-model="netTonnage"
                  type="number"
                  class="w-full field"
                  placeholder="Optional"
                  @input="autoNT=false"
                  :readonly="!!selectedVessel"
                />
                <span x-show="autoNT" class="chip bg-emerald-100 text-emerald-700 mt-1 inline-block">Autofilled</span>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">YTD CBP Paid</label>
              <input x-model="ytdCbpPaid" type="number" step="0.01" class="w-full field" placeholder="0.00" />
            </div>

            <div class="pt-3 border-t">
              <div class="flex items-center gap-2 mb-3">
                <input id="useV2" type="checkbox" x-model="useV2" class="h-4 w-4">
                <label for="useV2" class="text-sm">Use comprehensive v2 estimator</label>
                <span class="kbd ml-2">New</span>
              </div>

              <div x-show="useV2" class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Previous Port (UN/LOCODE)</label>
                  <div class="relative">
                    <input x-model="previousPortCode" @input.debounce.250ms="searchUnloc('prev')" placeholder="e.g., USLAX or CNSHA" class="w-full field">
                    <button x-show="previousPortCode" @click="previousPortCode=''; unlocPrev=[]" type="button"
                            class="absolute right-2 top-2 text-gray-400 hover:text-gray-600" aria-label="Clear previous port">×</button>
                    <div x-show="unlocPrev.length" class="absolute z-10 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg w-full">
                      <template x-for="p in unlocPrev" :key="p.locode">
                        <div @click="previousPortCode = p.locode; unlocPrev=[]" class="px-3 py-2 hover:bg-gray-50 cursor-pointer text-sm">
                          <span class="font-medium" x-text="p.port_name"></span>
                          <span class="ml-2 chip bg-slate-100" x-text="p.locode"></span>
                          <span class="ml-2 text-xs text-gray-500" x-text="p.country_code"></span>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Next Port (UN/LOCODE)</label>
                  <div class="relative">
                    <input x-model="nextPortCode" @input.debounce.250ms="searchUnloc('next')" placeholder="Optional" class="w-full field">
                    <button x-show="nextPortCode" @click="nextPortCode=''; unlocNext=[]" type="button"
                            class="absolute right-2 top-2 text-gray-400 hover:text-gray-600" aria-label="Clear next port">×</button>
                    <div x-show="unlocNext.length" class="absolute z-10 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg w-full">
                      <template x-for="p in unlocNext" :key="p.locode">
                        <div @click="nextPortCode = p.locode; unlocNext=[]" class="px-3 py-2 hover:bg-gray-50 cursor-pointer text-sm">
                          <span class="font-medium" x-text="p.port_name"></span>
                          <span class="ml-2 chip bg-slate-100" x-text="p.locode"></span>
                          <span class="ml-2 text-xs text-gray-500" x-text="p.country_code"></span>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ETD (optional)</label>
                    <input x-model="etd" type="date" class="w-full field" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Days Alongside</label>
                    <input x-model.number="daysAlongside" min="1" type="number" class="w-full field" />
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Vessel Type</label>
                  <select x-model="vesselType" class="w-full field">
                    <option value="general_cargo">General Cargo</option>
                    <option value="container">Container</option>
                    <option value="tanker">Tanker</option>
                    <option value="bulk_carrier">Bulk Carrier</option>
                    <option value="cruise">Cruise</option>
                    <option value="roro">Ro-Ro</option>
                    <option value="lng">LNG</option>
                    <option value="vehicle_carrier">Vehicle Carrier</option>
                  </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gross Tonnage</label>
                    <input
                      x-model.number="grossTonnage"
                      type="number"
                      step="1"
                      class="w-full field"
                      @input="autoGT=false"
                      :readonly="!!selectedVessel"
                    />
                    <span x-show="autoGT" class="chip bg-emerald-100 text-emerald-700 mt-1 inline-block">Autofilled</span>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Net Tonnage</label>
                    <input
                      x-model.number="netTonnage"
                      type="number"
                      step="1"
                      class="w-full field"
                      @input="autoNT=false"
                      :readonly="!!selectedVessel"
                    />
                    <span x-show="autoNT" class="chip bg-emerald-100 text-emerald-700 mt-1 inline-block">Autofilled</span>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">LOA (m)</label>
                    <input
                      x-model.number="loaMeters"
                      type="number"
                      step="0.1"
                      class="w-full field"
                      @input="autoLOA=false"
                      :readonly="!!selectedVessel"
                    />
                    <span x-show="autoLOA" class="chip bg-emerald-100 text-emerald-700 mt-1 inline-block">Autofilled</span>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Beam (m)</label>
                    <input
                      x-model.number="beamMeters"
                      type="number"
                      step="0.1"
                      class="w-full field"
                      @input="autoBeam=false"
                      :readonly="!!selectedVessel"
                    />
                    <span x-show="autoBeam" class="chip bg-emerald-100 text-emerald-700 mt-1 inline-block">Autofilled</span>
                  </div>
                </div>

                <div class="grid sm:grid-cols-3 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">FWD Draft (m)</label>
                    <input x-model.number="draftForwardMeters" type="number" step="0.1" class="w-full field" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">AFT Draft (m)</label>
                    <input x-model.number="draftAftMeters" type="number" step="0.1" class="w-full field" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Air Draft (m)</label>
                    <input x-model.number="airDraftMeters" type="number" step="0.1" class="w-full field" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <button
            @click="useV2 ? getEstimateV2() : getEstimate()"
            :disabled="!selectedPort || !eta || !previousPortCode.trim() || estimateLoading || (useV2 && (!Number(grossTonnage) || !Number(netTonnage)))"
            class="w-full mt-4 px-4 py-2 btn btn-primary disabled:opacity-50">
            <span x-show="!estimateLoading">Calculate Estimate</span>
            <span x-show="estimateLoading">Calculating…</span>
          </button>
        </div>
      </div>

      <!-- Right Column -->
      <div class="lg:col-span-2 space-y-4">

        <!-- Alerts -->
        <div x-show="liveData && liveData.alerts && liveData.alerts.length" class="bg-amber-50 border-l-4 border-amber-400 rounded-lg p-4 animate-slide-up">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-amber-800">Compliance Alerts</h4>
            <span class="badge">live</span>
          </div>
          <ul class="text-sm text-amber-800 space-y-1 mt-1">
            <template x-for="a in (liveData && liveData.alerts ? liveData.alerts : [])" :key="a"><li x-text="a"></li></template>
          </ul>
        </div>

        <!-- Estimate v1 -->
        <template x-if="estimate && !estimateV2">
          <div class="glass card p-6 animate-slide-up">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold">Fee Estimate (v1)</h3>
              <div class="flex gap-2">
                <button @click="clientExport('csv')" class="text-sm btn btn-outline px-3 py-1.5">Export CSV</button>
                <button @click="clientExport('json')" class="text-sm btn btn-outline px-3 py-1.5">Export JSON</button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Fee</th>
                    <th class="px-4 py-2 text-right text-xs font-semibold text-gray-600 uppercase">Amount</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <template x-for="item in (estimate && estimate.line_items ? estimate.line_items : [])" :key="item.code">
                    <tr>
                      <td class="px-4 py-2">
                        <div class="font-medium" x-text="item.name"></div>
                        <div class="text-xs text-gray-500" x-text="item.code"></div>
                      </td>
                      <td class="px-4 py-2 text-right font-mono" x-text="`$${item.amount}`"></td>
                    </tr>
                  </template>
                </tbody>
                <tfoot class="border-t-2 border-gray-300">
                  <tr>
                    <td class="px-4 py-2 font-semibold">Total Mandatory</td>
                    <td class="px-4 py-2 text-right font-bold text-lg" x-text="estimate ? (`$${estimate.total}`) : ''"></td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div x-show="estimate && estimate.optional_services && estimate.optional_services.length" class="mt-4 pt-4 border-t">
              <h4 class="font-semibold mb-2">Optional Services (Estimates)</h4>
              <div class="space-y-2">
                <template x-for="s in (estimate && estimate.optional_services ? estimate.optional_services : [])" :key="s.service">
                  <div class="flex justify-between text-sm">
                    <span>
                      <span x-text="s.service"></span>
                      <span class="text-xs text-gray-500" x-text="`(${s.note})`"></span>
                    </span>
                    <span class="font-mono" x-text="`$${Number(s.estimated_low).toLocaleString()} - $${Number(s.estimated_high).toLocaleString()}`"></span>
                  </div>
                </template>
              </div>
              <p class="mt-3 text-xs text-gray-500">
                Legacy launch/crew boat services are no longer included in this quick estimate.
              </p>
              <div class="mt-3 pt-3 border-t flex justify-between font-semibold" x-show="estimate">
                <span>Total with Optional</span>
                <span x-text="estimate ? (`$${estimate.total_with_optional_low} - $${estimate.total_with_optional_high}`) : ''"></span>
              </div>
            </div>

            <p class="text-xs text-gray-500 mt-4" x-text="estimate ? (estimate.disclaimer || '') : ''"></p>
          </div>
        </template>

        <!-- Estimate v2 -->
        <template x-if="!!estimateV2">
          <div class="glass card p-6 animate-slide-up">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold">Fee Estimate (v2)</h3>
              <div class="text-xs text-slate-500">
                conf ~ <span x-text="estimateV2?.confidence"></span>
              </div>
            </div>

            <div class="text-sm text-gray-600 mb-3 grid sm:grid-cols-2 gap-x-6">
              <div>
                <div><span class="font-medium">Arrival:</span> <span x-text="estimateV2?.port?.name"></span> (<span x-text="estimateV2?.port?.resolved_internal_code"></span>)</div>
                <div><span class="font-medium">LOCODE:</span> <span x-text="estimateV2?.port?.arrival_unlocode || 'internal only'"></span></div>
              </div>
              <div>
                <div><span class="font-medium">Prev → Arr → Next:</span>
                  <span x-text="estimateV2?.voyage?.previous_port"></span> →
                  <span x-text="estimateV2?.voyage?.arrival_port"></span> →
                  <span x-text="estimateV2?.voyage?.next_port || '—'"></span>
                </div>
                <div><span class="font-medium">ETA:</span> <span x-text="estimateV2?.voyage?.eta"></span></div>
              </div>
            </div>

            <div class="divide-y">
              <template x-for="c in (estimateV2?.calculations || [])" :key="c.code">
                <div class="py-2 flex items-start justify-between">
                  <div class="pr-4">
                    <div class="font-medium" x-text="c.name"></div>
                    <div class="text-xs text-gray-500" x-text="c.details"></div>
                  </div>
                  <div class="text-right">
                    <div class="font-mono" x-text="'$' + c.final_amount"></div>
                    <div class="text-xs text-gray-500">conf: <span x-text="c.confidence"></span></div>
                  </div>
                </div>
              </template>
            </div>

            <div class="mt-3 border-t pt-3 space-y-1">
              <div class="flex justify-between"><span>Mandatory</span><span class="font-mono" x-text="'$' + (estimateV2?.totals?.mandatory || '0.00')"></span></div>
              <div class="flex justify-between"><span>Optional (low)</span><span class="font-mono" x-text="'$' + (estimateV2?.totals?.optional_low || '0.00')"></span></div>
              <div class="flex justify-between"><span>Optional (high)</span><span class="font-mono" x-text="'$' + (estimateV2?.totals?.optional_high || '0.00')"></span></div>
              <div class="flex justify-between font-bold border-t pt-2">
                <span>Total (low)</span><span class="font-mono" x-text="'$' + (estimateV2?.totals?.total_low || '0.00')"></span>
              </div>
              <div class="flex justify-between font-bold">
                <span>Total (high)</span><span class="font-mono" x-text="'$' + (estimateV2?.totals?.total_high || '0.00')"></span>
              </div>
            </div>

            <p class="text-xs text-gray-500 mt-4" x-text="estimateV2?.disclaimer"></p>
          </div>
        </template>

        <!-- Multi-Port Voyage Planner -->
        <div class="glass card p-6 animate-slide-up">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-xl font-semibold">Multi-Port Voyage Planner</h3>
            <span class="badge">new</span>
          </div>

          <div class="grid sm:grid-cols-2 gap-3">
            <div class="sm:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Vessel Name</label>
              <input x-model="mpVesselName" class="w-full field" placeholder="Defaults to selected vessel name if blank" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
              <input x-model="mpStartDate" type="date" class="w-full field" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Days in Port</label>
              <input x-model.number="mpDaysInPort" type="number" min="1" class="w-full field" />
            </div>
          </div>

          <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Ports (zone selections)</label>
            <div class="flex gap-2">
              <div class="relative flex-1" @click.away="showMpDropdown = false">
                <input
                  x-model="mpPortInput"
                  @input="searchPorts(false, 'multi')"
                  @focus="searchPorts(true, 'multi')"
                  @keydown.enter.prevent="addMpPort()"
                  placeholder="Search zone, port, or terminal…"
                  class="w-full field pr-16"
                />
                <button
                  type="button"
                  class="absolute inset-y-0 right-0 px-3 text-sm text-indigo-600 hover:text-indigo-700"
                  x-show="mpPortInput"
                  @click="mpPortInput=''; searchPorts(true, 'multi')"
                >
                  Clear
                </button>
                <div
                  x-show="showMpDropdown"
                  class="absolute z-20 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg list-scroll"
                >
                  <template x-for="p in mpFilteredPorts" :key="`multi-${p.type}-${p.zoneCode}-${p.portCode || ''}-${p.terminalCode || p.terminalName || ''}`">
                    <button
                      type="button"
                      class="w-full text-left px-3 py-2 hover:bg-indigo-50"
                      @click="addMpPort(p)"
                    >
                      <div class="font-medium text-slate-800" x-text="portResultTitle(p)"></div>
                      <div class="text-xs text-slate-500 mt-1" x-text="portResultDescription(p)"></div>
                      <div class="mt-1 flex flex-wrap gap-1 text-[11px] text-slate-500">
                        <span class="chip bg-indigo-50 text-indigo-600" x-show="p.zoneCode" x-text="p.zoneCode"></span>
                        <span class="chip bg-slate-100" x-show="p.portCode" x-text="p.portCode"></span>
                        <span class="chip bg-slate-100" x-show="p.terminalCode" x-text="p.terminalCode"></span>
                      </div>
                      <div class="text-[11px] text-slate-400 mt-0.5" x-show="p.operator" x-text="p.operator"></div>
                    </button>
                  </template>
                </div>
              </div>
              <button @click="addMpPort()" class="btn btn-soft px-3 py-1.5">Add</button>
            </div>

            <div class="text-xs text-slate-500 mt-1">Reuse the same zone lookup—selections are sent as internal zone codes.</div>

            <div class="mt-3 space-y-2">
              <template x-for="(item, i) in mpPorts" :key="`${item.zoneCode}-${i}`">
                <div class="flex items-start justify-between bg-slate-100 rounded-lg px-3 py-2 text-slate-700">
                  <div>
                    <div class="font-medium" x-text="item.label"></div>
                    <div class="text-[11px] text-slate-500" x-show="item.description" x-text="item.description"></div>
                  </div>
                  <div class="flex items-center gap-2">
                    <div class="flex flex-wrap gap-1 text-[11px] text-slate-500">
                      <span class="chip bg-indigo-50 text-indigo-600" x-text="item.zoneCode"></span>
                      <span class="chip bg-slate-100" x-show="item.portCode" x-text="item.portCode"></span>
                    </div>
                    <button @click="removeMpPort(i)" class="text-slate-500 hover:text-slate-700" aria-label="remove">×</button>
                  </div>
                </div>
              </template>
              <div x-show="mpPorts.length === 0" class="text-xs text-slate-400">No ports added yet.</div>
            </div>
          </div>

          <div class="mt-3 grid sm:grid-cols-3 gap-3">
            <div>
              <label class="block text-xs font-medium mb-1">Vessel Type</label>
              <select x-model="vesselType" class="w-full field">
                <option value="general_cargo">General Cargo</option>
                <option value="container">Container</option>
                <option value="tanker">Tanker</option>
                <option value="bulk_carrier">Bulk Carrier</option>
                <option value="cruise">Cruise</option>
                <option value="roro">Ro-Ro</option>
                <option value="lng">LNG</option>
                <option value="vehicle_carrier">Vehicle Carrier</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-medium mb-1">GT</label>
              <input x-model.number="grossTonnage" type="number" step="1" class="w-full field" @input="autoGT=false" :readonly="!!selectedVessel"/>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">NT</label>
              <input x-model.number="netTonnage" type="number" step="1" class="w-full field" @input="autoNT=false" :readonly="!!selectedVessel"/>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">LOA (m)</label>
              <input x-model.number="loaMeters" type="number" step="0.1" class="w-full field" @input="autoLOA=false" :readonly="!!selectedVessel"/>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Beam (m)</label>
              <input x-model.number="beamMeters" type="number" step="0.1" class="w-full field" @input="autoBeam=false" :readonly="!!selectedVessel"/>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">FWD Draft (m)</label>
              <input x-model.number="draftForwardMeters" type="number" step="0.1" class="w-full field" />
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">AFT Draft (m)</label>
              <input x-model.number="draftAftMeters" type="number" step="0.1" class="w-full field" />
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Air Draft (m)</label>
              <input x-model.number="airDraftMeters" type="number" step="0.1" class="w-full field" />
            </div>
          </div>

          <div class="mt-3 flex items-center gap-2">
            <button @click="submitMultiPort" :disabled="mpPorts.length < 2" class="btn btn-primary px-3 py-1.5 disabled:opacity-50">Plan Voyage</button>
            <span class="text-xs text-slate-500">Add at least two zones to build a voyage.</span>
          </div>

          <div x-show="mpResult" class="mt-4">
            <div class="text-sm text-slate-600 mb-2">
              <div><span class="font-medium">Legs:</span> <span x-text="mpResult?.voyage_summary?.total_legs"></span> ·
                   <span class="font-medium">Port Days:</span> <span x-text="mpResult?.voyage_summary?.total_days_in_port"></span></div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50"><tr>
                  <th class="px-3 py-2 text-left">Leg</th>
                  <th class="px-3 py-2 text-left">From → To</th>
                  <th class="px-3 py-2 text-left">ETA / ETD</th>
                  <th class="px-3 py-2 text-right">Mandatory</th>
                  <th class="px-3 py-2 text-right">With Optional</th>
                </tr></thead>
                <tbody class="divide-y divide-gray-200">
                  <template x-for="leg in (mpResult?.legs || [])" :key="leg.leg">
                    <tr>
                      <td class="px-3 py-2" x-text="leg.leg"></td>
                      <td class="px-3 py-2" x-text="`${leg.from_port} → ${leg.to_port}`"></td>
                      <td class="px-3 py-2"><div x-text="leg.eta"></div><div class="text-xs text-slate-500" x-text="leg.etd"></div></td>
                      <td class="px-3 py-2 text-right" x-text="`$${Number(leg.fees?.mandatory || 0).toLocaleString()}`"></td>
                      <td class="px-3 py-2 text-right" x-text="`$${(Number(leg.fees?.mandatory||0)+Number(leg.fees?.optional_high||0)).toLocaleString()}`"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <div class="mt-3 border-t pt-3 flex items-center justify-between">
              <div class="text-sm">
                <div class="font-medium">Total Mandatory:
                  <span class="font-mono" x-text="`$${Number(mpResult?.total_voyage_cost?.mandatory || 0).toLocaleString()}`"></span>
                </div>
                <div>Total with Optional:
                  <span class="font-mono" x-text="`$${Number(mpResult?.total_voyage_cost?.with_optional || 0).toLocaleString()}`"></span>
                </div>
              </div>

              <div class="text-sm max-w-md text-slate-600">
                <div class="font-medium mb-1">Suggestions</div>
                <ul class="list-disc list-inside">
                  <template x-for="s in (mpResult?.optimization_suggestions || [])" :key="s">
                    <li x-text="s"></li>
                  </template>
                </ul>
              </div>
            </div>

          </div>
        </div>

        <!-- Quick Actions -->
        <div class="flex gap-2 justify-end">
          <button @click="refreshAll" class="text-sm btn btn-outline px-3 py-1.5">Refresh All Data</button>
          <button @click="clearCache" class="text-sm btn btn-outline px-3 py-1.5">Clear Cache</button>
        </div>
      </div>
    </div>

    <footer class="mt-12 pt-8 border-t border-gray-200 text-center text-sm text-gray-500">
      <p>Maritime MVP v2.x | Data sources: USCG PSIX, CBP, APHIS, CA SLC</p>
      <p class="mt-1">Estimates are for reference only. Verify with official sources.</p>
    </footer>
  </div>

  <!-- Single, clean JS block -->
  <script>
    function portCallApp() {
      return {
        // status
        apiStatus: 'Checking…',
        cacheStats: '',
  
        // search & paging
        vesselQuery: '',
        vesselSearched: false,
        searchLoading: false,
        searchError: null,
        vesselResults: [],
        vesselPage: 1,
        vesselLimit: 25,
        vesselPages: 1,
        vesselTotal: 0,
        vesselStart: 0,
        vesselEnd: 0,
  
        // selection & forms
        selectedVessel: null,
        zones: [],
        portSearchIndex: [],
        zoneLookup: {},
        portLookup: {},
        terminalLookup: {},
        zoneLabels: {},
        portLabels: {},
        terminalLabels: {},
        selectedPortContext: null,
        selectedPort: '',
        portQuery: '',
        filteredPorts: [],
        mpFilteredPorts: [],
        showPortDropdown: false,
        showMpDropdown: false,
        portSearchTimeout: null,
        mpPortSearchTimeout: null,
        eta: new Date().toISOString().split('T')[0],
        arrivalType: 'FOREIGN',
        netTonnage: '',
        ytdCbpPaid: '0',
  
        // v2 fields
        useV2: false,
        previousPortCode: '',
        nextPortCode: '',
        etd: '',
        daysAlongside: 2,
        vesselType: 'general_cargo',
        grossTonnage: 0,
        loaMeters: 0,
        beamMeters: 0,
        draftForwardMeters: 0,
        draftAftMeters: 0,
        airDraftMeters: 0,

        // autofill flags (for badges)
        autoGT: false,
        autoNT: false,
        autoLOA: false,
        autoBeam: false,
  
        // UN/LOCODE suggestions
        unlocPrev: [],
        unlocNext: [],
  
        // multi-port
        mpVesselName: '',
        mpStartDate: new Date().toISOString().split('T')[0],
        mpDaysInPort: 2,
        mpPortInput: '',
        mpPorts: [],
        mpResult: null,
  
        // results
        estimate: null,
        estimateV2: null,
        estimateLoading: false,
        liveData: null,
        activeTab: 'documents',
  
        async init() {
          await this.checkHealth();
          await this.loadPorts();
        },
  
        async checkHealth() {
          try {
            const r = await fetch(`${API_BASE}/health`);
            const d = await r.json();
            this.apiStatus = d.ok ? 'Online' : 'Offline';
            this.cacheStats = d.cache_stats ? `${d.cache_stats.active_entries} cached` : '';
          } catch (e) {
            this.apiStatus = 'Error';
            console.error('Health failed:', e);
          }
        },
  
        async loadPorts() {
          try {
            const r = await fetch(`${API_BASE}/ports`);
            const zones = await r.json();
            this.buildPortCaches(Array.isArray(zones) ? zones : []);
            this.filteredPorts = [];
            this.mpFilteredPorts = [];
            this.showPortDropdown = false;
            this.showMpDropdown = false;
            this.syncPortQueryWithSelection();
          } catch (e) {
            console.error('Ports load failed:', e);
          }
        },

        buildPortCaches(zones) {
          const tokenize = (...values) => {
            const tokens = new Set();
            const push = (value) => {
              if (Array.isArray(value)) {
                value.forEach(push);
                return;
              }
              if (value == null) return;
              String(value)
                .toLowerCase()
                .split(/[^a-z0-9]+/i)
                .filter(Boolean)
                .forEach((token) => tokens.add(token));
            };
            values.forEach(push);
            return Array.from(tokens).join(' ');
          };

          this.zones = zones;
          this.zoneLookup = {};
          this.portLookup = {};
          this.terminalLookup = {};
          this.zoneLabels = {};
          this.portLabels = {};
          this.terminalLabels = {};

          const index = [];

          for (const zone of zones) {
            const zoneCode = String(zone?.zone_code || '').trim().toUpperCase();
            const zoneName = zone?.zone_name || zoneCode || 'Unknown Zone';
            this.zoneLookup[zoneCode] = zone;
            this.zoneLabels[zoneCode] = zoneCode ? `${zoneName} (${zoneCode})` : zoneName;

            const zoneTokenCollector = [
              zoneCode,
              zoneName,
              zone?.region,
              zone?.primary_state,
              zone?.country,
            ];

            const zoneEntries = [];
            const ports = Array.isArray(zone?.ports) ? zone.ports : [];
            for (const port of ports) {
              const portCode = String(port?.code || '').trim().toUpperCase();
              const portName = port?.name || portCode || 'Unnamed Port';
              if (portCode) this.portLookup[portCode] = { zoneCode, zoneName, port };
              if (portCode) this.portLabels[`${zoneCode}::${portCode}`] = `${zoneName} • ${portName}`;

              zoneTokenCollector.push(portCode, portName, port?.state, port?.country, port?.region);

              const location = [
                port?.state || zone?.primary_state,
                port?.country || zone?.country,
              ].filter(Boolean).join(', ');

              const portEntry = {
                type: 'port',
                zoneCode,
                zoneName,
                portCode,
                portName,
                terminalCode: null,
                terminalName: null,
                zone,
                port,
                terminal: null,
                label: `${zoneName} • ${portName}`,
                description: [
                  zoneCode ? `Zone ${zoneCode}` : null,
                  portCode ? `Port ${portCode}` : null,
                  location || null,
                ].filter(Boolean).join(' · '),
                operator: '',
                haystack: tokenize(
                  zoneCode,
                  zoneName,
                  zone?.region,
                  zone?.primary_state,
                  zone?.country,
                  portCode,
                  portName,
                  port?.state,
                  port?.country,
                  port?.region,
                ),
              };
              zoneEntries.push(portEntry);

              const terminals = Array.isArray(port?.public_terminals) ? port.public_terminals : [];
              for (const term of terminals) {
                const termCodeRaw = term?.code ? String(term.code).trim() : '';
                const termCode = termCodeRaw.toUpperCase();
                const termName = term?.name || termCode || 'Terminal';
                const operator = term?.operator_name || '';
                const notes = term?.notes || '';

                zoneTokenCollector.push(termCode, termName, operator);

                const terminalEntry = {
                  type: 'terminal',
                  zoneCode,
                  zoneName,
                  portCode,
                  portName,
                  terminalCode: termCode || null,
                  terminalName: termName,
                  zone,
                  port,
                  terminal: term,
                  label: `${zoneName} • ${portName} • ${termName}`,
                  description: [
                    zoneCode ? `Zone ${zoneCode}` : null,
                    portCode ? `Port ${portCode}` : null,
                    termCode ? `Terminal ${termCode}` : null,
                    operator || null,
                    location || null,
                  ].filter(Boolean).join(' · '),
                  operator,
                  haystack: tokenize(
                    zoneCode,
                    zoneName,
                    zone?.region,
                    zone?.primary_state,
                    zone?.country,
                    portCode,
                    portName,
                    port?.state,
                    port?.country,
                    port?.region,
                    termCode,
                    termName,
                    operator,
                    notes,
                  ),
                };
                zoneEntries.push(terminalEntry);

                if (termCode) {
                  this.terminalLookup[`${zoneCode}::${termCode}`] = { zoneCode, portCode, terminal: term, port, zone };
                  this.terminalLabels[`${zoneCode}::${termCode}`] = terminalEntry.label;
                }
                if (termName) {
                  this.terminalLookup[`${zoneCode}::name::${termName.toLowerCase()}`] = { zoneCode, portCode, terminal: term, port, zone };
                }
              }
            }

            const portCount = ports.length;
            const zoneEntry = {
              type: 'zone',
              zoneCode,
              zoneName,
              portCode: null,
              portName: null,
              terminalCode: null,
              terminalName: null,
              zone,
              port: null,
              terminal: null,
              label: zoneName,
              description: [
                zoneCode ? `Zone ${zoneCode}` : null,
                [zone?.primary_state, zone?.country].filter(Boolean).join(', ') || null,
                portCount ? `${portCount} port${portCount === 1 ? '' : 's'}` : null,
              ].filter(Boolean).join(' · '),
              operator: '',
              haystack: tokenize(zoneTokenCollector),
            };

            index.push(zoneEntry, ...zoneEntries);
          }

          this.portSearchIndex = index;
        },

        makeSelectionContext(entry) {
          if (!entry) return null;
          const zone = this.zoneLookup[entry.zoneCode] || entry.zone || null;
          const port = entry.port || (entry.portCode ? this.portLookup[entry.portCode]?.port : null);
          let terminal = entry.terminal || null;
          if (!terminal && entry.terminalCode && port) {
            terminal = (Array.isArray(port?.public_terminals) ? port.public_terminals : []).find(
              (t) => String(t?.code || '').trim().toUpperCase() === entry.terminalCode
            ) || null;
          }
          const labelParts = [entry.zoneName || entry.zoneCode];
          if (entry.portName) labelParts.push(entry.portName);
          if (entry.terminalName) labelParts.push(entry.terminalName);
          const descriptionParts = [
            entry.zoneCode ? `Zone ${entry.zoneCode}` : null,
            entry.portCode ? `Port ${entry.portCode}` : null,
            entry.terminalCode ? `Terminal ${entry.terminalCode}` : null,
            [port?.state || zone?.primary_state, port?.country || zone?.country].filter(Boolean).join(', ') || null,
          ].filter(Boolean);
          if (terminal?.operator_name) descriptionParts.push(terminal.operator_name);

          return {
            ...entry,
            zone,
            port,
            terminal,
            label: labelParts.join(' • '),
            description: descriptionParts.join(' · '),
            operator: terminal?.operator_name || entry.operator || '',
          };
        },

        portResultTitle(entry) {
          return entry ? (entry.label || '') : '';
        },

        portResultDescription(entry) {
          return entry ? (entry.description || '') : '';
        },

        syncPortQueryWithSelection() {
          if (!this.selectedPort) {
            this.selectedPortContext = null;
            this.portQuery = '';
            return;
          }
          if (!this.selectedPortContext || this.selectedPortContext.zoneCode !== this.selectedPort) {
            const fallback = this.portSearchIndex.find(
              (entry) => entry.zoneCode === this.selectedPort && entry.type === 'zone'
            );
            this.selectedPortContext = this.makeSelectionContext(fallback ?? null);
          }
          if (this.selectedPortContext) {
            this.portQuery = this.selectedPortContext.label;
          } else {
            this.portQuery = this.zoneLabels[this.selectedPort] || this.selectedPort;
          }
        },

        clearPortQuery() {
          if (this.portSearchTimeout) {
            clearTimeout(this.portSearchTimeout);
            this.portSearchTimeout = null;
          }
          this.portQuery = '';
          this.filteredPorts = [];
          this.showPortDropdown = false;
          if (this.selectedPort) {
            this.selectedPort = '';
            this.selectedPortContext = null;
          }
        },

        rankPortMatches(tokens) {
          const matches = [];
          for (const entry of this.portSearchIndex) {
            if (!entry?.haystack) continue;
            const haystack = entry.haystack;
            const allMatch = tokens.every((token) => haystack.includes(token));
            if (!allMatch) continue;
            let score = 0;
            const qExact = (value) => value && tokens.length === 1 && value === tokens[0];
            if (qExact(entry.zoneCode?.toLowerCase())) score += 6;
            if (qExact(entry.portCode?.toLowerCase())) score += 5;
            if (qExact(entry.terminalCode?.toLowerCase())) score += 5;
            const primaryMatches = [entry.zoneName, entry.portName, entry.terminalName]
              .map((value) => (value || '').toLowerCase());
            for (const token of tokens) {
              if (entry.zoneCode?.toLowerCase().includes(token)) score += 2;
              if (entry.portCode?.toLowerCase().includes(token)) score += 2;
              if ((entry.terminalCode || '').toLowerCase().includes(token)) score += 2;
              if (primaryMatches.some((v) => v && v.includes(token))) score += 1;
            }
            if (entry.type === 'zone') score += 1;
            if (entry.type === 'port') score += 2;
            if (entry.type === 'terminal') score += 3;
            matches.push({ entry, score });
          }
          matches.sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            return (a.entry.label || '').localeCompare(b.entry.label || '');
          });
          return matches.slice(0, 12).map((m) => m.entry);
        },

        searchPorts(immediate = false, target = 'single') {
          const configs = {
            single: {
              getQuery: () => this.portQuery,
              clear: () => {
                this.filteredPorts = [];
                this.showPortDropdown = false;
              },
              apply: (matches) => {
                this.filteredPorts = matches;
                this.showPortDropdown = matches.length > 0;
              },
              timeoutProp: 'portSearchTimeout',
            },
            multi: {
              getQuery: () => this.mpPortInput,
              clear: () => {
                this.mpFilteredPorts = [];
                this.showMpDropdown = false;
              },
              apply: (matches) => {
                this.mpFilteredPorts = matches;
                this.showMpDropdown = matches.length > 0;
              },
              timeoutProp: 'mpPortSearchTimeout',
            },
          };

          const cfg = configs[target] || configs.single;
          if (!Array.isArray(this.portSearchIndex) || this.portSearchIndex.length === 0) {
            cfg.clear();
            return;
          }

          if (this[cfg.timeoutProp]) {
            clearTimeout(this[cfg.timeoutProp]);
            this[cfg.timeoutProp] = null;
          }

          const run = () => {
            this[cfg.timeoutProp] = null;
            const query = (cfg.getQuery() || '').trim().toLowerCase();
            if (!query) {
              cfg.clear();
              return;
            }
            const tokens = query.split(/[^a-z0-9]+/g).filter(Boolean);
            if (!tokens.length) {
              cfg.clear();
              return;
            }
            const matches = this.rankPortMatches(tokens);
            cfg.apply(matches);
          };

          if (immediate) run();
          else this[cfg.timeoutProp] = setTimeout(run, 180);
        },

        selectFirstPortResult(target = 'single') {
          const results = target === 'multi' ? this.mpFilteredPorts : this.filteredPorts;
          if (results.length) {
            if (target === 'multi') this.addMpPort(results[0]);
            else this.selectPort(results[0]);
          }
        },

        selectPort(entry) {
          if (!entry) return;
          const context = this.makeSelectionContext(entry);
          this.selectedPortContext = context;
          this.selectedPort = context?.zoneCode || '';
          this.portQuery = context?.label || '';
          this.filteredPorts = [];
          this.showPortDropdown = false;
          if (this.selectedPort) this.loadLiveData();
        },

        // ---------- Normalizer (no out-before-init) ----------
        augment(v) {
          const src = (v && typeof v === 'object') ? { ...v } : {};
        
          const scanDeep = (obj, keyRegex, accept = (val) => (
            (typeof val === 'string' && val.trim() !== '') || typeof val === 'number'
          ), depth = 0) => {
            if (!obj || depth > 4) return null;
            for (const [k, val] of Object.entries(obj)) {
              if (val == null) continue;
              if (keyRegex.test(k)) {
                const s = String(val).trim();
                if (accept(s)) return s;
              }
              if (val && typeof val === 'object' && !Array.isArray(val)) {
                const found = scanDeep(val, keyRegex, accept, depth + 1);
                if (found != null) return found;
              }
            }
            return null;
          };
          const scan = (re, accept) => scanDeep(src, re, accept);
        
          const pick = (...cands) => {
            for (const c of cands) {
              if (c in src && src[c] != null) {
                const s = String(src[c]).trim();
                if (s && s.toLowerCase() !== 'none') return s;
              }
            }
            return null;
          };
        
          const toNumber = (val) => {
            if (val == null) return null;
            const n = Number(String(val).replace(/[^0-9.+-]/g, ''));
            return Number.isFinite(n) ? n : null;
          };
        
          const toMetersGeneric = (val) => {
            if (val == null) return null;
            const s = String(val).toLowerCase();
            const n = toNumber(s);
            if (n == null) return null;
            if (s.includes('ft') || s.includes('feet') || s.includes("'")) return n * 0.3048;
            return n; // assume meters if unitless
          };
        
          // Feet→meters helper when we *know* the source is feet (e.g., LengthInFeet)
          const feetToMeters = (val) => {
            const n = toNumber(val);
            return n == null ? null : n * 0.3048;
          };
        
          const num7 = (x) => (x ? String(x).match(/\b\d{6,7}\b/)?.[0] : null);
        
          // Identity / descriptors
          const VesselID   = pick('VesselID','vesselid','VesselId','ID','id') ?? scan(/(^|[\W_])vessel\s*id$/i);
          const VesselName = pick('VesselName','vesselname','Name','name') ?? scan(/vessel.*name|^name$/i);
          const CallSign   = pick('VesselCallSign','CallSign','Call_Sign','RadioCallSign','radio_callsign','callSign')
                          ?? scan(/call.?sign|radio.?call/i);
          const Flag       = pick('CountryLookupName','Flag','FlagName','FlagOfRegistry','FlagState','FlagCountry','FlagCode','flag')
                          ?? scan(/(flag|country)(.*(name|lookup|state|country))?/i, v => isNaN(v));
          const VesselType = pick('ServiceType','VesselType','VesselTypeDescription','VesselService','Service','ShipType','vesseltype')
                          ?? scan(/(service|type)/i, v => isNaN(v) && String(v).length < 80);
        
          // IDs
          const imoRaw = pick('IMONumber','IMO','ImoNumber','IMO_Number','IMONo','IMOShipNo','imo')
                      || pick('PrimaryVesselNumber','Primary_Vessel_Number','Primary_Vessel_No')
                      || scanDeep(src, /(^|[\W_])imo([\W_]|$)/i, v => /\d{6,7}/.test(String(v)));
          const IMONumber = num7(imoRaw);
        
          const OfficialNumber = pick('OfficialNumber','OfficialNumberText','Official_No','USOfficialNumber','US_Official_Number')
                              ?? scan(/official.?number/i);
        
          const YearBuilt = (() => {
            const y = pick('ConstructionCompletedYear','YearBuilt','BuildYear','build_year')
                   ?? scan(/(year.*built|build.*year|construction.*(year|completed))/i);
            const n = Number(String(y ?? '').replace(/\D/g,''));
            return Number.isFinite(n) ? n : null;
          })();
        
          // Tonnage (broaden common aliases)
          const gtRaw = pick(
            'GrossTonnage','GrossRegisteredTonnage','GrossTons','GT','Gross_Tonnage','grosstonnage'
          ) ?? scan(/gross.*ton|(^|\b)gt\b/i);
          const ntRaw = pick(
            'NetTonnage','NetRegisteredTonnage','NetTons','NT','Net_Tonnage','nettonnage'
          ) ?? scan(/net.*ton|(^|\b)nt\b/i);
          const GrossTonnage = (toNumber(gtRaw) ?? gtRaw) ?? null;
          const NetTonnage   = (toNumber(ntRaw) ?? ntRaw) ?? null;
        
          // ---------- Dimensions ----------
          // Prefer explicit meters, else explicit feet, else generic text (unit-detected)
          // Length/LOA
          const lenMetersRaw = pick('LOA_m','LengthInMeters','LOAInMeters','OverallLengthInMeters','loa_m','length_m');
          const lenFeetRaw   = pick('LengthInFeet','LOAInFeet','OverallLengthInFeet','Length (ft)');
          const lenGeneric   = pick('LOA','Length','LengthOverall','OverallLength','loa','length_overall') ?? scan(/(length|loa)/i);
          const LOA_m = toNumber(lenMetersRaw)
            ?? (feetToMeters(lenFeetRaw))
            ?? toMetersGeneric(lenGeneric);
        
          // Beam/Breadth
          const beamMetersRaw = pick('Beam_m','BreadthInMeters','BeamInMeters','OverallBreadthInMeters','MouldedBreadthInMeters','beam_m','breadth_m');
          const beamFeetRaw   = pick('BreadthInFeet','BeamInFeet','OverallBreadthInFeet','MouldedBreadthInFeet','Breadth (ft)');
          const beamGeneric   = pick('Beam','Breadth','MouldedBreadth','MoldedBreadth','Width','beam','breadth') ?? scan(/(beam|breadth|width)/i);
          const Beam_m = toNumber(beamMetersRaw)
            ?? (feetToMeters(beamFeetRaw))
            ?? toMetersGeneric(beamGeneric);
        
          // Depth (NOT Draft)
          const depthMetersRaw = pick('Depth_m','DepthInMeters','MouldedDepthInMeters','depth_m');
          const depthFeetRaw   = pick('DepthInFeet','MouldedDepthInFeet','Depth (ft)');
          const depthGeneric   = pick('Depth','depth') ?? scan(/(^|\b)depth\b/i);
          const Depth_m = toNumber(depthMetersRaw)
            ?? (feetToMeters(depthFeetRaw))
            ?? toMetersGeneric(depthGeneric);
        
          // Draft (optional, distinct from Depth)
          const draftFwdMetersRaw = pick('DraftForward_m','ForwardDraft_m','ForwardDraftInMeters','ForwardDraftMeters','forward_draft_m','draft_forward_meters');
          const draftFwdFeetRaw   = pick('ForwardDraftInFeet','ForwardDraftFeet','forward_draft_ft');
          const draftFwdGeneric   = scan(/forward.*draft/i);
          const DraftForward_m = toNumber(draftFwdMetersRaw)
            ?? (feetToMeters(draftFwdFeetRaw))
            ?? toMetersGeneric(draftFwdGeneric);

          const draftAftMetersRaw = pick('DraftAft_m','AftDraft_m','AftDraftInMeters','AftDraftMeters','aft_draft_m','draft_aft_meters');
          const draftAftFeetRaw   = pick('AftDraftInFeet','AftDraftFeet','aft_draft_ft');
          const draftAftGeneric   = scan(/aft.*draft|draft.*aft/i);
          const DraftAft_m = toNumber(draftAftMetersRaw)
            ?? (feetToMeters(draftAftFeetRaw))
            ?? toMetersGeneric(draftAftGeneric);

          const airDraftMetersRaw = pick('AirDraft_m','AirDraftInMeters','AirDraftMeters','air_draft_m');
          const airDraftFeetRaw   = pick('AirDraftInFeet','AirDraftFeet','air_draft_ft');
          const airDraftGeneric   = scan(/air.*draft/i);
          const AirDraft_m = toNumber(airDraftMetersRaw)
            ?? (feetToMeters(airDraftFeetRaw))
            ?? toMetersGeneric(airDraftGeneric);

          const draftMetersRaw = pick('Draft_m','DraftInMeters','MaxDraftInMeters','draft_m');
          const draftFeetRaw   = pick('DraftInFeet','MaxDraftInFeet','Draft (ft)');
          const draftGeneric   = pick('Draft','SummerDraft','draft') ?? scan(/(^|\b)draft\b|(^|\b)summer.*draft\b/i);
          const Draft_m = toNumber(draftMetersRaw)
            ?? (feetToMeters(draftFeetRaw))
            ?? toMetersGeneric(draftGeneric);

          return {
            ...src,
            VesselID, VesselName, CallSign, Flag, VesselType,
            IMONumber, OfficialNumber, YearBuilt,
            GrossTonnage, NetTonnage,
            LOA_m, Beam_m, Draft_m, Depth_m,
            DraftForward_m, DraftAft_m, AirDraft_m
          };
        }, // ← close augment

  
        // --- Vessel search with server pagination + augmentation ---
        async searchVessel(page = 1) {
          if (!this.vesselQuery.trim()) return;
  
          this.vesselSearched = true;
          this.searchLoading = true;
          this.searchError = null;
          this.vesselPage = page;
  
          try {
            const params = new URLSearchParams({
              name: this.vesselQuery,
              page: String(this.vesselPage),
              limit: String(this.vesselLimit),
            });
  
            const r = await fetch(`${API_BASE}/vessels/search?${params}`);
            if (!r.ok) throw new Error('Search failed');
            const data = await r.json();
  
            this._lastSearchPayload = data;
  
            const raw = Array.isArray(data?.Table) ? data.Table
                      : Array.isArray(data?.rows)  ? data.rows
                      : Array.isArray(data)        ? data
                      : [];
  
            const augmented = raw.map(this.augment.bind(this));
  
            console.log('[search] first row keys:', raw[0] ? Object.keys(raw[0]) : '(no rows)');
  
            this.vesselTotal = (typeof data.total === 'number') ? data.total : augmented.length;
            this.vesselPages = (typeof data.pages === 'number')
              ? data.pages
              : Math.max(Math.ceil(this.vesselTotal / this.vesselLimit), 1);
  
            this.vesselResults = augmented;
  
            const startIdx = (this.vesselPage - 1) * this.vesselLimit;
            this.vesselStart = this.vesselTotal ? (data.start ?? startIdx + 1) : 0;
            this.vesselEnd = data.end ?? Math.min(startIdx + this.vesselResults.length, this.vesselTotal);
  
            if (this.vesselResults.length === 0) this.searchError = 'No vessels found';
          } catch (e) {
            this.searchError = e.message || 'Search failed';
            console.error('Vessel search failed:', e);
          } finally {
            this.searchLoading = false;
          }
        },
  
        prevVesselPage() { if (this.vesselPage > 1) this.searchVessel(this.vesselPage - 1); },
        nextVesselPage() { if (this.vesselPage < this.vesselPages) this.searchVessel(this.vesselPage + 1); },
        goToVesselPage(p) { if (p >= 1 && p <= this.vesselPages) this.searchVessel(p); },
        pageWindow() {
          const win = 2;
          const start = Math.max(1, this.vesselPage - win);
          const end = Math.min(this.vesselPages, this.vesselPage + win);
          const arr = [];
          for (let i = start; i <= end; i++) arr.push(i);
          return arr;
        },
  
        async selectVessel(v) {
          const prevSelected = this.selectedVessel || null;
          const makeToken = (obj) => {
            if (!obj) return '';
            const parts = [
              obj.VesselID ?? obj.vessel_id ?? obj.id ?? '',
              obj.CallSign ?? obj.VesselCallSign ?? '',
              obj.VesselName ?? obj.Name ?? ''
            ].map(val => String(val || '').trim().toUpperCase()).filter(Boolean);
            return parts.join('|');
          };
          const prevToken = makeToken(prevSelected);

          const normalized = this.augment(v) || {};
          const nextToken = makeToken(normalized) || makeToken(v);
          const vesselChanged = !prevSelected || prevToken !== nextToken;

          this._rawSelected = v;
          this.selectedVessel = normalized;
          this._selectedVesselToken = nextToken;

          console.log('[select] raw row:', v);
          console.log('[select] normalized:', normalized);

          // reset badges for locked particulars when vessel changes
          if (vesselChanged) {
            this.autoGT = false;
            this.autoNT = false;
            this.autoLOA = false;
            this.autoBeam = false;
            this.grossTonnage = null;
            this.netTonnage = null;
            this.loaMeters = null;
            this.beamMeters = null;
            this.draftForwardMeters = null;
            this.draftAftMeters = null;
            this.airDraftMeters = null;
          }

          // quick type guess
          const s = (normalized.VesselType || '').toLowerCase();
          const guess =
            s.includes('container') ? 'container' :
            s.includes('tanker')    ? 'tanker' :
            s.includes('bulk')      ? 'bulk_carrier' :
            (s.includes('cruise') || s.includes('passenger')) ? 'cruise' :
            (s.includes('roro') || s.includes('ro-ro')) ? 'roro' :
            s.includes('lng')       ? 'lng' :
            (s.includes('vehicle') || s.includes('car carrier')) ? 'vehicle_carrier' :
            'general_cargo';
          if (this.vesselType === 'general_cargo' && guess !== 'general_cargo') this.vesselType = guess;

          // prefill from search row
          const prefer = (field, next, flag, dp = 2) => {
            const curr = this[field];
            const n = Number(next);
            const currNum = Number(curr);
            const currValid = Number.isFinite(currNum) && currNum > 0;
            const nextValid = Number.isFinite(n) && n > 0;

            if (!nextValid) return curr;
            if (vesselChanged) {
              this[flag] = true;
              return dp ? Number(n.toFixed(dp)) : n;
            }
            if (!currValid || this[flag]) {
              this[flag] = true;
              return dp ? Number(n.toFixed(dp)) : n;
            }
            return curr;
          };
          if (normalized.GrossTonnage != null) this.grossTonnage = prefer('grossTonnage', normalized.GrossTonnage, 'autoGT', 0);
          if (normalized.NetTonnage   != null) this.netTonnage   = prefer('netTonnage',   normalized.NetTonnage,   'autoNT', 0);
          if (normalized.LOA_m        != null) this.loaMeters    = prefer('loaMeters',    normalized.LOA_m,        'autoLOA', 2);
          if (normalized.Beam_m       != null) this.beamMeters   = prefer('beamMeters',   normalized.Beam_m,       'autoBeam', 2);

          const setDraftField = (field, value, dp = 2) => {
            const n = Number(value);
            if (!Number.isFinite(n) || n <= 0) return;
            if (!vesselChanged && Number(this[field]) > 0) return;
            this[field] = dp ? Number(n.toFixed(dp)) : n;
          };
          setDraftField('draftForwardMeters', normalized.DraftForward_m ?? normalized.Draft_m);
          setDraftField('draftAftMeters', normalized.DraftAft_m ?? normalized.Draft_m);
          setDraftField('airDraftMeters', normalized.AirDraft_m);

          await this.enrichVesselDimensions();
          if (this.selectedPort) this.loadLiveData();
        },
  
        // ----- v1 estimator (GET /estimate) -----
        async getEstimate() {
          if (!this.selectedPort || !this.eta) return;
          if (!this.previousPortCode.trim()) {
            alert('Previous port UN/LOCODE is required.');
            return;
          }
          this.estimateLoading = true;
          this.estimate = null;
          this.estimateV2 = null;

          const params = new URLSearchParams({
            port_code: this.selectedPort,
            eta: this.eta,
            arrival_type: this.arrivalType,
            include_optional: 'true'
          });
          params.set('previous_port_code', this.previousPortCode.trim().toUpperCase());
          if (this.netTonnage) params.set('net_tonnage', this.netTonnage);
          if (this.ytdCbpPaid) params.set('ytd_cbp_paid', this.ytdCbpPaid);
  
          try {
            const r = await fetch(`${API_BASE}/estimate?${params}`);
            if (!r.ok) throw new Error('Estimate failed');
            this.estimate = await r.json();
            if (this.selectedVessel) await this.loadLiveData();
          } catch (e) {
            console.error('Estimate failed:', e);
            alert('Failed to calculate estimate: ' + (e.message || 'request error'));
          } finally {
            this.estimateLoading = false;
          }
        },
  
        // ----- v2 estimator (POST /v2/estimate) -----
        async getEstimateV2() {
          if (!this.selectedPort || !this.eta || !this.previousPortCode.trim()) {
            alert('Previous port (UN/LOCODE), arrival port, and ETA are required for v2.');
            return;
          }
          this.estimateLoading = true;
          this.estimate = null;
          this.estimateV2 = null;
  
          const fwdDraft = Number(this.draftForwardMeters) || 0;
          const aftDraft = Number(this.draftAftMeters) || 0;
          const airDraft = Number(this.airDraftMeters) || 0;
          const draftSamples = [fwdDraft, aftDraft].filter(v => v > 0);
          const representativeDraft = draftSamples.length
            ? Number((draftSamples.reduce((sum, v) => sum + v, 0) / draftSamples.length).toFixed(2))
            : (fwdDraft || aftDraft || 0);
          const draftString = (val) => (val > 0 ? String(val) : null);

          const body = {
            vessel_name: this.selectedVessel?.VesselName || this.vesselQuery || 'Unknown Vessel',
            vessel_type: this.vesselType,
            gross_tonnage: String(this.grossTonnage || 0),
            net_tonnage: String(this.netTonnage || 0),
            loa_meters: String(this.loaMeters || 0),
            draft_meters: String(representativeDraft || 0),
            beam_meters: String(this.beamMeters || 0),
            forward_draft_meters: draftString(fwdDraft),
            aft_draft_meters: draftString(aftDraft),
            air_draft_meters: draftString(airDraft),
            previous_port_code: this.previousPortCode.trim().toUpperCase(),
            arrival_port_code: this.selectedPort,
            next_port_code: this.nextPortCode ? this.nextPortCode.trim().toUpperCase() : null,
            eta: this.eta ? new Date(this.eta).toISOString() : null,
            etd: this.etd ? new Date(this.etd).toISOString() : null,
            days_alongside: Number(this.daysAlongside) || 2,
            ytd_cbp_paid: String(this.ytdCbpPaid || 0),
            tonnage_year_paid: "0"
          };
  
          try {
            const r = await fetch(`${API_BASE}/v2/estimate`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });
            if (!r.ok) {
              const t = await r.text();
              throw new Error(t || 'v2 estimate failed');
            }
            this.estimateV2 = await r.json();
            if (this.selectedVessel) await this.loadLiveData();
          } catch (e) {
            console.error('v2 estimate failed:', e);
            alert('Failed to calculate v2 estimate.');
          } finally {
            this.estimateLoading = false;
          }
        },
  
        // ----- NEW: PSIX-first enrichment flow -----
        async enrichVesselDimensions() {
          const hasDraftInfo = (Number(this.draftForwardMeters) > 0) || (Number(this.draftAftMeters) > 0) || (Number(this.airDraftMeters) > 0);
          const needsDims = !(Number(this.loaMeters) > 0 && Number(this.beamMeters) > 0) || !hasDraftInfo;
          const needsTons = !(Number(this.grossTonnage) > 0) || !(Number(this.netTonnage) > 0);
          if (!needsDims && !needsTons) return;
        
          const sv = this.selectedVessel || {};
          const selToken = (sv.VesselID || sv.VesselName || '') + ':' + (sv.CallSign || '');
          const stillSelected = () =>
            ((this.selectedVessel?.VesselID || this.selectedVessel?.VesselName || '') + ':' + (this.selectedVessel?.CallSign || '')) === selToken;
        
          const setIf = (curr, next, flag, dp = 2) => {
            if (Number(curr) > 0) return curr;
            const n = Number(next);
            if (Number.isFinite(n) && n > 0) { this[flag] = true; return dp ? Number(n.toFixed(dp)) : n; }
            return curr;
          };
          const setDraftIf = (field, value, dp = 2) => {
            if (Number(this[field]) > 0) return;
            const n = Number(value);
            if (Number.isFinite(n) && n > 0) {
              this[field] = dp ? Number(n.toFixed(dp)) : n;
              updated = true;
            }
          };
        
          const qs = (obj) => Object.entries(obj).map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
          const unify = (payload) => {
            // Accept common shapes: {Table:[...]}, {rows:[...]}, [...], {data:{...}} …
            if (!payload) return [];
            if (Array.isArray(payload?.Table)) return payload.Table;
            if (Array.isArray(payload?.rows)) return payload.rows;
            if (Array.isArray(payload)) return payload;
            if (Array.isArray(payload?.data?.rows)) return payload.data.rows;
            if (payload?.data && typeof payload.data === 'object') return [payload.data];
            if (payload?.result && typeof payload.result === 'object') return [payload.result];
            return [payload];
          };
        
          const tryFetch = async (urls) => {
            for (const u of urls) {
              try {
                const r = await fetch(u);
                if (!r.ok) continue;
                const j = await r.json();
                console.info('[enrich] ✅', u);
                return j;
              } catch (_) { /* keep trying */ }
            }
            return null;
          };
        
          // -------------------------
          // 1) Resolve VesselID via our backend (no /psix/* calls)
          // -------------------------
          let vesselId = sv.VesselID || null;
          if (!vesselId) {
            const idParamSets = [{ id: sv.id }, { vessel_id: sv.id }, { VesselID: sv.id }].filter(p => Object.values(p)[0]);
            const keyParamSets = [];
            const cs = (sv.CallSign || sv.VesselCallSign || '').trim();
            const nm = (sv.VesselName || '').trim();
        
            if (cs) keyParamSets.push({ callsign: cs }, { CallSign: cs }, { call_sign: cs });
            if (nm) keyParamSets.push({ vessel_name: nm }, { name: nm }, { VesselName: nm });
        
            const idUrls = [];
            for (const p of idParamSets) {
              idUrls.push(`${API_BASE}/vessels/summary?${qs(p)}`);
              idUrls.push(`${API_BASE}/vessels/details?${qs(p)}`);
              idUrls.push(`${API_BASE}/api/v2/vessels/details?${qs(p)}`);
            }
        
            let summary = idUrls.length ? await tryFetch(idUrls) : null;
            if (!summary && keyParamSets.length) {
              const keyUrls = [];
              for (const p of keyParamSets) {
                keyUrls.push(`${API_BASE}/vessels/summary?${qs(p)}`);
                keyUrls.push(`${API_BASE}/vessels/details?${qs(p)}`);
                keyUrls.push(`${API_BASE}/api/v2/vessels/details?${qs(p)}`);
              }
              summary = await tryFetch(keyUrls);
            }
        
            const rows = unify(summary);
            if (rows.length) {
              // Prefer exact callsign match if available
              const row = (cs && rows.find(r => String(r.VesselCallSign || r.CallSign || '').trim().toUpperCase() === cs.toUpperCase())) || rows[0];
              vesselId = row?.VesselID ?? row?.vessel_id ?? row?.ID ?? null;
              if (vesselId && !sv.VesselID) this.selectedVessel.VesselID = vesselId; // cache it for later calls
            }
          }
        
          if (!stillSelected()) return;
        
          // -------------------------
          // 2) Pull details (with or without an ID) and merge
          // -------------------------
          const detailUrls = [];
          if (vesselId) {
            detailUrls.push(`${API_BASE}/vessels/details?${qs({ vessel_id: vesselId })}`);
            detailUrls.push(`${API_BASE}/api/v2/vessels/details?${qs({ vessel_id: vesselId })}`);
            detailUrls.push(`${API_BASE}/vessels/summary?${qs({ vessel_id: vesselId })}`);
          } else {
            // No ID: query by callsign/name directly against details endpoints
            const cs = (sv.CallSign || sv.VesselCallSign || '').trim();
            const nm = (sv.VesselName || '').trim();
            if (cs) {
              detailUrls.push(`${API_BASE}/vessels/details?${qs({ callsign: cs })}`);
              detailUrls.push(`${API_BASE}/api/v2/vessels/details?${qs({ callsign: cs })}`);
            }
            if (nm) {
              detailUrls.push(`${API_BASE}/vessels/details?${qs({ vessel_name: nm })}`);
              detailUrls.push(`${API_BASE}/api/v2/vessels/details?${qs({ name: nm })}`);
              detailUrls.push(`${API_BASE}/api/v2/vessels/details?${qs({ vessel_name: nm, service: 'ALL' })}`);
            }
          }
        
          let merged = {};
          for (const u of detailUrls) {
            try {
              const r = await fetch(u);
              if (!r.ok) continue;
              const j = await r.json();
              const rows = unify(j);
              if (!rows.length) continue;
              // Prefer a row with dimensions/tonnage
              const pickRow = rows.find(rw => rw.LengthInFeet || rw.GrossTonnage || rw.NetTonnage || rw.LOA_m || rw.Beam_m || rw.Draft_m) || rows[0];
              // Convert PSIX feet if present (never infer Draft from Depth)
              const extra = {};
              if (pickRow.LengthInFeet != null)  extra.LOA_m  = Number(pickRow.LengthInFeet)  * 0.3048;
              if (pickRow.BreadthInFeet != null) extra.Beam_m = Number(pickRow.BreadthInFeet) * 0.3048;
              if (pickRow.DepthInFeet != null)   extra.Depth_m = Number(pickRow.DepthInFeet)  * 0.3048;
              if (pickRow.ForwardDraftInFeet != null) extra.DraftForward_m = Number(pickRow.ForwardDraftInFeet) * 0.3048;
              if (pickRow.ForwardDraftInMeters != null) extra.DraftForward_m = Number(pickRow.ForwardDraftInMeters);
              if (pickRow.AftDraftInFeet != null) extra.DraftAft_m = Number(pickRow.AftDraftInFeet) * 0.3048;
              if (pickRow.AftDraftInMeters != null) extra.DraftAft_m = Number(pickRow.AftDraftInMeters);
              if (pickRow.AirDraftInFeet != null) extra.AirDraft_m = Number(pickRow.AirDraftInFeet) * 0.3048;
              if (pickRow.AirDraftInMeters != null) extra.AirDraft_m = Number(pickRow.AirDraftInMeters);

              merged = { ...merged, ...pickRow, ...extra };
              // If we still didn’t have VesselID, try to grab it from this payload
              if (!vesselId) vesselId = pickRow.VesselID ?? pickRow.vessel_id ?? pickRow.ID ?? vesselId;
            } catch (_) {}
          }
        
          if (!stillSelected()) return;
        
          // -------------------------
          // 3) Normalize + apply
          // -------------------------
          const aug = this.augment(merged || {});
          let updated = false;
        
          if (needsTons) {
            const bGT = this.grossTonnage, bNT = this.netTonnage;
            this.grossTonnage = setIf(this.grossTonnage, aug.GrossTonnage, 'autoGT', 0);
            this.netTonnage   = setIf(this.netTonnage,   aug.NetTonnage,   'autoNT', 0);
            updated ||= (this.grossTonnage !== bGT || this.netTonnage !== bNT);
          }
          if (needsDims) {
            const bL = this.loaMeters, bB = this.beamMeters;
            const bF = this.draftForwardMeters, bA = this.draftAftMeters, bAir = this.airDraftMeters;
            this.loaMeters  = setIf(this.loaMeters,  aug.LOA_m,  'autoLOA', 2);
            this.beamMeters = setIf(this.beamMeters, aug.Beam_m, 'autoBeam', 2);
            // Only set real drafts if present (never from Depth)
            setDraftIf('draftForwardMeters', aug.DraftForward_m ?? aug.Draft_m, 2);
            setDraftIf('draftAftMeters', aug.DraftAft_m ?? aug.Draft_m, 2);
            setDraftIf('airDraftMeters', aug.AirDraft_m, 2);
            updated ||= (
              this.loaMeters !== bL ||
              this.beamMeters !== bB ||
              this.draftForwardMeters !== bF ||
              this.draftAftMeters !== bA ||
              this.airDraftMeters !== bAir
            );
          }
        
          console.info(updated ? '[enrich] Populated from /vessels/* details' : '[enrich] Details fetched, nothing new');
        },


  
        // Live bundle (pilotage, marine exchange, docs, COFR, MISP)
        async loadLiveData() {
          if (!this.selectedVessel || !this.selectedPort) return;
  
          const params = new URLSearchParams({
            vessel_name: this.selectedVessel.VesselName || '',
            port_code: this.selectedPort
          });
          const vid = this.selectedVessel.VesselID;
          if (vid) params.set('vessel_id', vid);
  
          try {
            const r = await fetch(`${API_BASE}/live/portbundle?${params}`);
            if (!r.ok) throw new Error('Live data failed');
            this.liveData = await r.json();
          } catch (e) {
            console.error('Live data failed:', e);
          }
        },
  
        // UN/LOCODE typeahead for previous/next/mp ports
        async searchUnloc(current = 'prev') {
          const base = current === 'prev' ? this.previousPortCode : this.nextPortCode;
          const q = (base || '').trim();
          if (q.length < 2) {
            if (current === 'prev') this.unlocPrev = [];
            else this.unlocNext = [];
            return;
          }
          try {
            const r = await fetch(`${API_BASE}/imo_ports/search?q=${encodeURIComponent(q)}&limit=8`);
            if (!r.ok) throw new Error('UN/LOCODE search failed');
            const rows = await r.json();
            if (current === 'prev') this.unlocPrev = rows;
            else this.unlocNext = rows;
          } catch (e) {
            console.error('UN/LOCODE search error:', e);
          }
        },
  
        // Client-side export (CSV/JSON) of the current estimate
        clientExport(format = 'csv') {
          if (this.estimateV2) {
            if (format === 'json') {
              const blob = new Blob([JSON.stringify(this.estimateV2, null, 2)], { type: 'application/json' });
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = `estimate_v2_${this.selectedPort}_${this.eta}.json`;
              a.click();
              return;
            }
            const rows = [['Code','Name','Final Amount','Base','Confidence','Optional','Details']];
            for (const c of (this.estimateV2.calculations || [])) {
              rows.push([
                c.code, c.name, c.final_amount, c.base_amount, c.confidence,
                c.is_optional ? 'yes' : 'no',
                (c.details || '').replace(/\n/g, ' ')
              ]);
            }
  
            const t = this.estimateV2?.totals || {};
            if (t && Object.keys(t).length) {
              rows.push(['', 'TOTAL MANDATORY', t.mandatory ?? '', '', '', '', '']);
              rows.push(['', 'TOTAL LOW', t.total_low ?? '', '', '', '', '']);
              rows.push(['', 'TOTAL HIGH', t.total_high ?? '', '', '', '', '']);
            }
  
            const q = this.estimateV2?.quick_totals || {};
            if (q && Object.keys(q).length) {
              rows.push(['', 'QUICK MANDATORY', q.mandatory ?? '', '', '', '', '']);
              rows.push(['', 'QUICK WITH OPTIONAL LOW', q.with_optional_low ?? '', '', '', '', '']);
              rows.push(['', 'QUICK WITH OPTIONAL HIGH', q.with_optional_high ?? '', '', '', '', '']);
            }
  
            const csv = rows.map(r => r.map(x => `"${String(x ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `estimate_v2_${this.selectedPort}_${this.eta}.csv`;
            a.click();
            return;
          }
  
          if (!this.estimate) return;
          if (format === 'json') {
            const blob = new Blob([JSON.stringify(this.estimate, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `estimate_v1_${this.selectedPort}_${this.eta}.json`;
            a.click();
            return;
          }
          const rows = [['Code','Name','Amount']];
          for (const item of (this.estimate.line_items || [])) {
            rows.push([item.code, item.name, item.amount]);
          }
          rows.push(['TOTAL','','' + (this.estimate.total || '0.00')]);
          const csv = rows.map(r => r.map(x => `"${String(x ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `estimate_v1_${this.selectedPort}_${this.eta}.csv`;
          a.click();
        },
  
        // Multi-port methods
        addMpPort(entry = null) {
          let context = entry ? this.makeSelectionContext(entry) : null;
          if (!context) {
            if (this.mpFilteredPorts.length) {
              context = this.makeSelectionContext(this.mpFilteredPorts[0]);
            } else {
              const direct = (this.mpPortInput || '').trim().toUpperCase();
              if (direct && this.zoneLookup[direct]) {
                const fallback = this.portSearchIndex.find(
                  (item) => item.zoneCode === direct && item.type === 'zone'
                );
                context = this.makeSelectionContext(fallback ?? null);
              }
            }
          }
          if (!context) return;
          this.mpPorts.push(context);
          this.mpPortInput = '';
          this.mpFilteredPorts = [];
          this.showMpDropdown = false;
        },
        removeMpPort(i) { this.mpPorts.splice(i, 1); },
        async submitMultiPort() {
          if (this.mpPorts.length < 2) { alert('Add at least two zones or ports.'); return; }
  
          const mpFwdDraft = Number(this.draftForwardMeters) || 0;
          const mpAftDraft = Number(this.draftAftMeters) || 0;
          const mpAirDraft = Number(this.airDraftMeters) || 0;
          const mpDrafts = [mpFwdDraft, mpAftDraft].filter(v => v > 0);
          const mpRepresentativeDraft = mpDrafts.length
            ? Number((mpDrafts.reduce((sum, v) => sum + v, 0) / mpDrafts.length).toFixed(2))
            : (mpFwdDraft || mpAftDraft || 0);
          const toDraftString = (val) => (val > 0 ? String(val) : null);

          const vessel = {
            name: this.mpVesselName || this.selectedVessel?.VesselName || 'Unknown Vessel',
            imo_number: this.selectedVessel?.IMONumber || null,
            vessel_type: this.vesselType,
            gross_tonnage: String(this.grossTonnage || 0),
            net_tonnage: String(this.netTonnage || 0),
            loa_meters: String(this.loaMeters || 0),
            beam_meters: String(this.beamMeters || 0),
            draft_meters: String(mpRepresentativeDraft || 0),
            forward_draft_meters: toDraftString(mpFwdDraft),
            aft_draft_meters: toDraftString(mpAftDraft),
            air_draft_meters: toDraftString(mpAirDraft),
          };
          const request = {
            vessel_name: vessel.name,
            ports: this.mpPorts.map((p) => p.zoneCode),
            start_date: this.mpStartDate,
            days_in_port: Number(this.mpDaysInPort) || 2,
          };
  
          try {
            const r = await fetch(`${API_BASE}/api/v2/voyage/multi-port`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ request, vessel })
            });
            if (!r.ok) throw new Error(await r.text());
            this.mpResult = await r.json();
          } catch (e) {
            console.error('Multi-port failed:', e);
            alert('Failed to calculate multi-port voyage.');
          }
        },
  
        async refreshAll() {
          await this.checkHealth();
          if (this.selectedPort && this.eta) {
            if (this.useV2) await this.getEstimateV2();
            else await this.getEstimate();
          }
        },
  
        async clearCache() {
          try {
            const r = await fetch(`${API_BASE}/admin/cache/clear`, { method: 'POST' });
            if (r.ok) {
              await this.checkHealth();
              alert('Cache cleared successfully');
            }
          } catch (e) {
            console.error('Clear cache failed:', e);
          }
        }
      }
    }
  </script>


</body>
</html>
