<!doctype html>
<html lang="en" class="antialiased">
<head>
  <meta charset="utf-8" />
  <title>Maritime MVP â€” Port Call Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Tailwind Config for Maritime Theme -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            ocean: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              800: '#075985',
              900: '#0c4a6e',
              950: '#082f49',
            }
          },
          zIndex: {
            '60': '60',
            '70': '70',
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Styles */
    body { background-color: #f1f5f9; color: #0f172a; }
    [x-cloak] { display: none !important; }

    /* Smooth Fade In */
    .animate-enter { animation: enter 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
    @keyframes enter { to { opacity: 1; transform: translateY(0); } }

    /* Card Styling */
    .card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
      transition: box-shadow 0.2s;
      position: relative;
    }
    .card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }

    /* Inputs */
    .label-text { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #64748b; margin-bottom: 0.35rem; display: block; }
    .field {
      width: 100%;
      background-color: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 0.6rem 0.75rem;
      font-size: 0.875rem;
      color: #1e293b;
      transition: all 0.15s ease-in-out;
    }
    .field:focus {
      outline: none;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
      z-index: 10;
    }
    .field:disabled { background-color: #f8fafc; color: #94a3b8; cursor: not-allowed; }

    /* Custom Scrollbar */
    .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Print Styles */
    @media print {
      body { background: white; }
      .no-print { display: none !important; }
      .card { border: none; box-shadow: none; }
      .print-only { display: block !important; }
    }
    .print-only { display: none; }
  </style>
</head>
<body class="min-h-screen pb-12" x-data="portCallApp()" x-init="init()">

  <script>
    const OVERRIDE_API_BASE = ""; 
    const API_BASE = OVERRIDE_API_BASE || window.location.origin;
  </script>

  <!-- Top Navigation Bar -->
  <nav class="bg-ocean-950 text-white border-b border-ocean-800 sticky top-0 z-50 no-print">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-ocean-500 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-ocean-900/50">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          </div>
          <div>
            <h1 class="font-bold text-lg tracking-tight">Maritime MVP</h1>
            <div class="text-[10px] text-ocean-200 uppercase tracking-wider font-medium">Port Call Intelligence</div>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-ocean-900/50 border border-ocean-800 text-xs">
            <span class="w-2 h-2 rounded-full animate-pulse" :class="apiStatus === 'Online' ? 'bg-emerald-400' : 'bg-red-400'"></span>
            <span class="font-medium text-ocean-100" x-text="apiStatus"></span>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <!-- LEFT COLUMN: Inputs (Span 4) -->
      <div class="lg:col-span-4 space-y-6 no-print">

        <!-- 1. Vessel Selector -->
        <div class="card p-5 animate-enter z-30">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-bold text-slate-800 flex items-center gap-2">
              <svg class="w-5 h-5 text-ocean-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
              Vessel Selection
            </h2>
            <button x-show="selectedVessel" @click="selectedVessel = null; vesselQuery = ''" class="text-xs text-slate-400 hover:text-red-500">Clear</button>
          </div>

          <!-- Search Input -->
          <div class="relative">
            <input
              x-model="vesselQuery"
              @keyup.enter="searchVessel(1)"
              class="field pl-9"
              placeholder="Search by Name, IMO, or Callsign..."
              :disabled="searchLoading"
            />
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400">
              <svg x-show="!searchLoading" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <svg x-show="searchLoading" class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
              </svg>
            </div>
          </div>

          <!-- Dropdown Results -->
          <div x-show="vesselResults.length > 0" class="absolute left-0 right-0 mt-1 mx-5 border border-slate-200 rounded-lg overflow-hidden max-h-60 custom-scroll overflow-y-auto shadow-xl z-50 bg-white">
            <template x-for="(v, idx) in vesselResults" :key="v.VesselID ?? idx">
              <button
                @click="selectVessel(v); vesselResults = []"
                class="w-full text-left px-4 py-3 hover:bg-ocean-50 border-b border-slate-100 last:border-0 transition-colors flex items-center justify-between group">
                <div>
                  <div class="font-semibold text-slate-800 group-hover:text-ocean-700" x-text="v.VesselName || '(unnamed)'"></div>
                  <div class="text-xs text-slate-500 font-mono mt-0.5">IMO: <span x-text="v.IMO || v.IMONumber || 'N/A'"></span></div>
                </div>
                <span class="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded" x-text="v.VesselType || 'Unknown'"></span>
              </button>
            </template>
          </div>

          <!-- Selected Vessel "Ticket" -->
          <div x-show="selectedVessel" class="mt-4 bg-ocean-50 border border-ocean-100 rounded-xl p-4 relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-16 h-16 bg-ocean-500/10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
            <div class="relative z-10">
              <div class="flex justify-between items-start">
                <div>
                  <div class="text-[10px] uppercase tracking-wider text-ocean-600 font-bold mb-1">Selected Vessel</div>
                  <h3 class="font-bold text-ocean-900 text-lg leading-tight" x-text="selectedVessel?.VesselName"></h3>
                  <div class="text-xs font-mono text-ocean-700 mt-1" x-text="selectedVessel?.CallSign || 'No Callsign'"></div>
                </div>
                <div class="text-right">
                  <div class="text-2xl">ðŸš¢</div>
                </div>
              </div>
              <div class="grid grid-cols-3 gap-2 mt-3 pt-3 border-t border-ocean-200/60">
                <div>
                  <div class="text-[9px] text-ocean-500 uppercase font-bold">Flag</div>
                  <div class="text-xs font-semibold text-ocean-900 truncate" x-text="selectedVessel?.Flag || '-'"></div>
                </div>
                <div>
                  <div class="text-[9px] text-ocean-500 uppercase font-bold">IMO</div>
                  <div class="text-xs font-semibold text-ocean-900" x-text="selectedVessel?.IMO || selectedVessel?.IMONumber || '-'"></div>
                </div>
                <div>
                  <div class="text-[9px] text-ocean-500 uppercase font-bold">Built</div>
                  <div class="text-xs font-semibold text-ocean-900" x-text="selectedVessel?.YearBuilt || '-'"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 2. Voyage Configuration -->
        <div class="card p-5 animate-enter z-20" style="animation-delay: 0.1s;">
          <div class="flex items-center justify-between mb-5">
            <h3 class="font-bold text-slate-800">Voyage Details</h3>
            <div class="flex items-center gap-2">
              <span class="text-[10px] uppercase tracking-wider font-semibold text-ocean-600 bg-ocean-50 border border-ocean-100 px-2 py-1 rounded-full">
                Comprehensive (v2)
              </span>
              <button
                type="button"
                @click="clearVoyage"
                class="text-[11px] text-slate-400 hover:text-red-500"
              >
                Clear
              </button>
            </div>
          </div>

          <!-- Tabs -->
          <div class="flex border-b border-slate-200 mb-5">
            <button @click="activeTab = 'voyage'" :class="activeTab === 'voyage' ? 'border-ocean-500 text-ocean-600' : 'border-transparent text-slate-400 hover:text-slate-600'" class="flex-1 pb-2 text-sm font-medium border-b-2 transition-colors">Route & Dates</button>
            <button @click="activeTab = 'specs'" :class="activeTab === 'specs' ? 'border-ocean-500 text-ocean-600' : 'border-transparent text-slate-400 hover:text-slate-600'" class="flex-1 pb-2 text-sm font-medium border-b-2 transition-colors relative">
              Vessel Specs
              <span x-show="autoGT || autoNT" class="absolute top-0 right-4 w-1.5 h-1.5 bg-emerald-500 rounded-full"></span>
            </button>
          </div>

          <!-- Tab: Voyage -->
          <div x-show="activeTab === 'voyage'" class="space-y-5">
            
            <!-- Port Search -->
            <div class="relative" @click.away="showPortDropdown = false">
              <label class="label-text">Arrival Port / Terminal</label>
              <div class="relative">
                <input
                  x-model="portQuery"
                  @input="searchPorts(false, 'single')"
                  @focus="searchPorts(true, 'single')"
                  @keydown.enter.prevent="selectFirstPortResult()"
                  class="field pl-9"
                  placeholder="Search port name or code..."
                />
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  </svg>
                </div>
                <button x-show="portQuery" @click="clearPortQuery" class="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600">âœ•</button>
              </div>
              
              <!-- Port Dropdown -->
              <div x-show="showPortDropdown" class="absolute z-50 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-xl max-h-60 custom-scroll overflow-y-auto">
                <template x-for="p in filteredPorts" :key="`single-${p.zoneCode}-${p.portCode}-${p.terminalCode}`">
                  <button type="button" class="w-full text-left px-4 py-2.5 hover:bg-ocean-50 border-b border-slate-50 last:border-0 group" @click="selectPort(p)">
                    <div class="font-medium text-slate-800 text-sm group-hover:text-ocean-700" x-text="portResultTitle(p)"></div>
                    <div class="text-xs text-slate-500" x-text="portResultDescription(p)"></div>
                  </button>
                </template>
              </div>

              <!-- ECA Warning -->
              <div x-show="selectedPortIsEca()" class="mt-2 flex items-center gap-2 text-xs text-amber-700 bg-amber-50 border border-amber-100 px-3 py-2 rounded-md">
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                <span><strong>ECA Zone:</strong> Low Sulfur Fuel Required</span>
              </div>
            </div>

            <!-- Voyage itinerary (optional multi-port) -->
            <div class="mt-4 pt-3 border-t border-slate-200 space-y-2 text-xs text-slate-500">
              <div class="flex items-center justify-between">
                <div>
                  <span class="font-semibold text-slate-700">Voyage itinerary</span>
                  <span class="ml-1 text-[11px] text-slate-400">(optional additional stops)</span>
                </div>
              </div>

              <!-- Stop rows -->
              <div class="bg-slate-50 rounded-lg border border-slate-200 p-2 space-y-2 max-h-60 overflow-y-auto custom-scroll">
                <template x-if="!stops.length">
                  <div class="text-[11px] text-slate-400">
                    No additional stops added. Single-port estimate only uses the arrival port.
                  </div>
                </template>

                <template x-for="(stop, idx) in stops" :key="stop.id">
                  <div class="bg-white border border-slate-200 rounded-md px-2 py-2 space-y-1">
                    <div class="flex items-center justify-between gap-2">
                      <div class="flex-1">
                        <div class="text-[10px] text-slate-400 mb-0.5">
                          <span class="font-semibold uppercase">Stop <span x-text="idx + 1"></span></span>
                          <span class="ml-1 text-slate-400">
                            (from
                            <span x-text="idx === 0
                              ? (selectedPortContext?.label || 'arrival port')
                              : (stops[idx - 1]?.label || 'previous stop')"></span>)
                          </span>
                        </div>
                        <div class="relative" @click.away="stop.showDropdown = false">
                          <input
                            x-model="stop.query"
                            @input="searchStopPorts(idx)"
                            @focus="searchStopPorts(idx)"
                            @keydown.enter.prevent="selectFirstStopResult(idx)"
                            class="field pl-8 h-8 text-[11px]"
                            placeholder="Select stop port..."
                          />
                          <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none text-slate-400">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            </svg>
                          </div>

                          <!-- Dropdown for this stop -->
                          <div
                            x-show="stop.showDropdown"
                            class="absolute z-50 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-xl max-h-48 custom-scroll overflow-y-auto"
                          >
                            <template x-for="p in stop.matches" :key="`stop-${stop.id}-${p.zoneCode}-${p.portCode}-${p.terminalCode}`">
                              <button
                                type="button"
                                class="w-full text-left px-3 py-2 hover:bg-ocean-50 border-b border-slate-50 last:border-0 group"
                                @click="selectStopPort(idx, p)"
                              >
                                <div class="font-medium text-[11px] text-slate-800 group-hover:text-ocean-700"
                                     x-text="portResultTitle(p)"></div>
                                <div class="text-[10px] text-slate-500" x-text="portResultDescription(p)"></div>
                              </button>
                            </template>
                          </div>
                        </div>
                        <div class="text-[10px] text-slate-400 mt-0.5" x-show="stop.label">
                          Selected: <span class="font-medium text-slate-600" x-text="stop.label"></span>
                        </div>
                      </div>

                      <!-- Days alongside for this stop -->
                      <div class="w-20">
                        <label class="label-text mb-1">Days</label>
                        <input
                          type="number"
                          min="1"
                          x-model.number="stop.daysInPort"
                          class="field h-8 text-[11px] text-center"
                        />
                      </div>

                      <!-- Remove -->
                      <button
                        type="button"
                        class="text-slate-400 hover:text-red-500 text-base leading-none self-start mt-5"
                        @click="removeStop(idx)"
                      >
                        Ã—
                      </button>
                    </div>
                  </div>
                </template>
              </div>

              <!-- Add stop button -->
              <div class="flex items-center justify-between pt-1">
                <button
                  type="button"
                  class="px-2.5 py-1 rounded-md border border-ocean-200 text-[11px] font-semibold text-ocean-700 hover:bg-ocean-50 disabled:opacity-40"
                  @click="addStop"
                  :disabled="!selectedPortContext || stops.length >= 5"
                >
                  + Add stop
                </button>
                <button
                  type="button"
                  class="px-2 py-1 rounded-md border border-slate-200 text-[11px] text-slate-500 hover:bg-slate-100 disabled:opacity-40"
                  @click="clearItinerary"
                  :disabled="!stops.length && !mpResult"
                >
                  Clear itinerary
                </button>
              </div>
            </div>

            <!-- Route -->
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
              <label class="label-text mb-2">Voyage Route (UN/LOCODE)</label>
              <div class="flex items-center gap-2">
                <div class="flex-1 relative" @click.away="unlocPrev = []">
                  <input x-model="previousPortCode" 
                         @input.debounce.300ms="searchUnloc('prev')" 
                         @focus="searchUnloc('prev')"
                         placeholder="PREV" 
                         class="field text-center font-mono uppercase text-sm" />
                  <!-- Unloc Dropdown Prev -->
                  <div x-show="unlocPrev.length" class="absolute bottom-full mb-1 left-0 w-48 bg-white shadow-xl rounded-lg border border-slate-200 text-xs z-50 max-h-40 overflow-y-auto custom-scroll">
                      <div class="px-2 py-1 text-[10px] font-bold text-slate-400 uppercase bg-slate-50">Suggestions</div>
                      <template x-for="p in unlocPrev">
                          <div @click="previousPortCode=p.locode; unlocPrev=[]; loadDocumentRequirements()" class="px-3 py-2 hover:bg-ocean-50 cursor-pointer border-b border-slate-50 last:border-0">
                              <span class="font-bold text-ocean-600" x-text="p.locode"></span> <span class="text-slate-600" x-text="p.port_name"></span>
                          </div>
                      </template>
                  </div>
                </div>
                
                <div class="text-slate-300">â†’</div>
                
                <div class="w-16 h-9 flex items-center justify-center bg-white border border-slate-300 rounded-md text-xs font-bold text-ocean-600 shadow-sm">
                  <span x-text="selectedPortContext?.portCode || selectedPortContext?.zoneCode || 'ARR'"></span>
                </div>
                
                <div class="text-slate-300">â†’</div>
                
                <div class="flex-1 relative" @click.away="unlocNext = []">
                  <input x-model="nextPortCode" 
                         @input.debounce.300ms="searchUnloc('next')" 
                         @focus="searchUnloc('next')"
                         placeholder="NEXT" 
                         class="field text-center font-mono uppercase text-sm" />
                   <!-- Unloc Dropdown Next -->
                  <div x-show="unlocNext.length" class="absolute bottom-full mb-1 right-0 w-48 bg-white shadow-xl rounded-lg border border-slate-200 text-xs z-50 max-h-40 overflow-y-auto custom-scroll">
                   <div class="px-2 py-1 text-[10px] font-bold text-slate-400 uppercase bg-slate-50">Suggestions</div>
                   <template x-for="p in unlocNext">
                       <div @click="nextPortCode=p.locode; unlocNext=[]" class="px-3 py-2 hover:bg-ocean-50 cursor-pointer border-b border-slate-50 last:border-0">
                           <span class="font-bold text-ocean-600" x-text="p.locode"></span> <span class="text-slate-600" x-text="p.port_name"></span>
                       </div>
                   </template>
               </div>
               </div>
              </div>
              <div class="mt-2 flex items-center gap-2 text-xs" x-show="derivedArrivalType()">
                <span class="uppercase tracking-wide text-slate-400 font-semibold">Arrival Type</span>
                <span
                  class="inline-flex items-center px-2 py-0.5 rounded-full font-semibold"
                  :class="derivedArrivalType() === 'COASTWISE'
                    ? 'bg-emerald-50 text-emerald-700 border border-emerald-100'
                    : 'bg-sky-50 text-sky-700 border border-sky-100'"
                  x-text="derivedArrivalType()"
                ></span>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="label-text">ETA</label>
                <input x-model="eta" type="date" class="field" />
              </div>
              <div>
                <label class="label-text">Days Alongside</label>
                <input x-model.number="daysAlongside" type="number" min="1" class="field" />
              </div>
            </div>
          </div>

          <!-- Tab: Specs -->
          <div x-show="activeTab === 'specs'" class="space-y-4">
            <div class="bg-blue-50 text-blue-800 text-xs p-3 rounded-md border border-blue-100 flex items-start gap-2">
              <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              <p>Vessel particulars are auto-filled. Please verify current drafts before calculation.</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div class="relative">
                <label class="label-text">Gross Tonnage</label>
                <input x-model.number="grossTonnage" type="number" class="field" @input="autoGT=false" />
                <div x-show="autoGT" class="absolute right-2 top-8 w-2 h-2 bg-emerald-500 rounded-full" title="Autofilled"></div>
              </div>
              <div class="relative">
                <label class="label-text">Net Tonnage</label>
                <input x-model.number="netTonnage" type="number" class="field" @input="autoNT=false" />
                <div x-show="autoNT" class="absolute right-2 top-8 w-2 h-2 bg-emerald-500 rounded-full" title="Autofilled"></div>
              </div>
              <div class="relative">
                <label class="label-text">LOA (m)</label>
                <input x-model.number="loaMeters" type="number" step="0.1" class="field" @input="autoLOA=false" />
                <div x-show="autoLOA" class="absolute right-2 top-8 w-2 h-2 bg-emerald-500 rounded-full" title="Autofilled"></div>
              </div>
              <div class="relative">
                <label class="label-text">Beam (m)</label>
                <input x-model.number="beamMeters" type="number" step="0.1" class="field" @input="autoBeam=false" />
                <div x-show="autoBeam" class="absolute right-2 top-8 w-2 h-2 bg-emerald-500 rounded-full" title="Autofilled"></div>
              </div>
            </div>

            <div class="pt-2">
              <label class="label-text mb-2">Draft Configuration (Meters)</label>
              <div class="flex rounded-md shadow-sm">
                <input x-model.number="draftForwardMeters" type="number" step="0.1" placeholder="Fwd" class="field rounded-r-none border-r-0 text-center" />
                <input x-model.number="draftAftMeters" type="number" step="0.1" placeholder="Aft" class="field rounded-none text-center" />
                <input x-model.number="airDraftMeters" type="number" step="0.1" placeholder="Air" class="field rounded-l-none border-l-0 text-center" />
              </div>
            </div>
          </div>

          <!-- Action Button -->
          <div class="mt-6 pt-4 border-t border-slate-100">
            <button
              @click="calculateVoyage()"
              :disabled="!selectedPort || !previousPortCode.trim() || estimateLoading"
              class="w-full bg-ocean-600 hover:bg-ocean-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-bold py-3.5 px-4 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2">
              <span x-show="!estimateLoading">Calculate Port Fees & Itinerary</span>
              <svg x-show="estimateLoading" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
            
            <!-- History Dropdown -->
            <div class="relative mt-3 text-center" @click.away="historyDropdownOpen = false">
                <button @click="historyDropdownOpen = !historyDropdownOpen" class="text-xs text-slate-500 hover:text-ocean-600 underline">Load Previous Estimate</button>
                <div x-show="historyDropdownOpen" class="absolute bottom-full left-0 w-full bg-white border border-slate-200 rounded-lg shadow-xl z-50 mb-1 text-left max-h-56 overflow-y-auto custom-scroll">
                    <template x-for="item in estimateHistory" :key="item.id">
                        <button @click="applyEstimateHistory(item)" class="w-full px-4 py-2 hover:bg-slate-50 border-b border-slate-50 text-xs group">
                            <div class="flex justify-between items-center mb-0.5">
                                <span class="font-bold text-slate-700" x-text="item.portLabel"></span>
                                <span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 rounded" x-text="formatIsoDate(item.timestamp)"></span>
                            </div>
                            <div class="text-slate-500 truncate" x-text="item.vesselName"></div>
                            <div class="mt-1 font-mono text-ocean-600 font-semibold" x-text="formatCurrency(item.totals?.total_high || item.totals?.mandatory || 0)"></div>
                        </button>
                    </template>
                    <div x-show="!estimateHistory.length" class="p-3 text-xs text-slate-400 text-center">No history found</div>
                </div>
            </div>
          </div>
        </div>

      </div> <!-- End Left Column -->

      <!-- RIGHT COLUMN: Results (Span 8) -->
      <div class="lg:col-span-8 space-y-6">

        <!-- Alerts -->
        <div x-show="liveData && liveData.alerts && liveData.alerts.length" class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg shadow-sm animate-enter no-print">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-amber-800">Compliance Alerts</h3>
                    <div class="mt-2 text-sm text-amber-700">
                        <ul class="list-disc pl-5 space-y-1">
                            <template x-for="a in liveData.alerts" :key="a"><li x-text="a"></li></template>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div x-show="!estimateV2 && !mpResult" class="h-96 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center text-slate-400 bg-slate-50/50 no-print">
            <svg class="w-16 h-16 mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <h3 class="text-lg font-semibold text-slate-600">Ready to Calculate</h3>
            <p class="text-sm max-w-xs text-center mt-2">Select a vessel and configure the voyage details on the left to generate a fee estimate.</p>
        </div>

        <!-- RESULT: V2 Estimate -->
        <template x-if="!!estimateV2">
            <div class="card overflow-hidden animate-enter">
                <!-- Header -->
                <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">Proforma Estimate</h2>
                        <div class="text-sm text-slate-500 mt-1 flex items-center gap-2">
                            <span x-text="selectedPortContext?.label || selectedPort"></span>
                            <span>â€¢</span>
                            <span x-text="formatIsoDate(estimateV2?.voyage?.eta)"></span>
                            <span>â€¢</span>
                            <span
                              class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold uppercase tracking-wide"
                              :class="(estimateV2?.meta?.arrival_type || '').toUpperCase() === 'COASTWISE'
                                ? 'bg-emerald-50 text-emerald-700 border border-emerald-100'
                                : 'bg-sky-50 text-sky-700 border border-sky-100'"
                              x-text="(estimateV2?.meta?.arrival_type || 'FOREIGN')"
                            ></span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 no-print">
                        <div class="flex flex-col items-end gap-2">
                            <div class="flex bg-white border border-slate-200 rounded-full text-xs overflow-hidden">
                                <button
                                  type="button"
                                  @click="audienceProfile = 'agent'"
                                  :class="audienceProfile === 'agent' ? 'bg-ocean-600 text-white' : 'text-slate-500 hover:bg-slate-50'"
                                  class="px-3 py-1 font-medium">
                                  Agent
                                </button>
                                <button
                                  type="button"
                                  @click="audienceProfile = 'owner'"
                                  :class="audienceProfile === 'owner' ? 'bg-ocean-600 text-white' : 'text-slate-500 hover:bg-slate-50'"
                                  class="px-3 py-1 font-medium">
                                  Owner
                                </button>
                                <button
                                  type="button"
                                  @click="audienceProfile = 'full'"
                                  :class="audienceProfile === 'full' ? 'bg-ocean-600 text-white' : 'text-slate-500 hover:bg-slate-50'"
                                  class="px-3 py-1 font-medium">
                                  Full
                                </button>
                            </div>
                            <div class="text-[10px] text-slate-400 uppercase tracking-wide">
                              View profile
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button @click="clientExport('csv')" class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-white border border-slate-300 rounded hover:bg-slate-50">CSV</button>
                            <button @click="printEstimate" class="px-3 py-1.5 text-xs font-medium text-white bg-slate-800 border border-slate-800 rounded hover:bg-slate-700">Print PDF</button>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-slate-900 text-white rounded-xl p-5 shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10 blur-xl"></div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">
                          Profile Total Â· <span class="capitalize" x-text="audienceProfile"></span>
                        </p>
                        <p class="text-3xl font-bold tracking-tight" x-text="formatCurrency(profileTotals().total_high)"></p>
                        <p class="text-xs text-slate-400 mt-2">
                          Sum of all visible items for the current view (agent / owner / full).
                        </p>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-xl p-5">
                        <p class="text-xs font-bold text-ocean-600 uppercase tracking-wider mb-2">
                          Breakdown
                        </p>
                        <div class="space-y-1 text-xs text-slate-600">
                          <div class="flex items-center justify-between">
                            <span>Regulatory (CBP / APHIS / tonnage / MISP)</span>
                            <span class="font-mono" x-text="formatCurrency(regOpsTotals().regulatory)"></span>
                          </div>
                          <div class="flex items-center justify-between">
                            <span>Port &amp; operations</span>
                            <span class="font-mono" x-text="formatCurrency(regOpsTotals().portOps)"></span>
                          </div>
                        </div>
                        <p class="text-[11px] text-slate-400 mt-2">
                          Uses the same filtered list as the current profile view.
                        </p>
                    </div>
                </div>

                <!-- Details Table -->
                <div class="px-6 pb-6">
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Item</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Amount</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-200">
                                <template x-for="c in filteredCalculations()" :key="c.code">
                                    <tr class="hover:bg-slate-50/50 transition-colors">
                                        <td class="px-6 py-3">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm font-medium text-slate-900" x-text="c.name"></span>
                                                <span x-show="c.is_optional" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-800">Optional</span>
                                            </div>
                                            <div class="text-xs text-slate-500 mt-0.5 font-mono" x-text="c.details"></div>
                                        </td>
                                        <td class="px-6 py-3 text-right whitespace-nowrap text-sm text-slate-600 font-mono" x-text="formatCurrency(c.final_amount)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-6 text-center">
                        <p class="text-xs text-slate-400" x-text="estimateV2?.disclaimer"></p>
                    </div>
                </div>
                
                <!-- Print Footer -->
                <div class="print-only border-t border-slate-200 p-4 text-center text-xs text-slate-400">
                    Generated by Maritime MVP on <span x-text="formatIsoDate(new Date())"></span>
                </div>
            </div>
        </template>

        <!-- RESULT: Multi-Port -->
        <div x-show="mpResult" class="card overflow-hidden animate-enter">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-200">
                <h2 class="text-lg font-bold text-slate-800">Voyage Itinerary Plan</h2>
            </div>
            <div class="p-0 overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Leg</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Route</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">ETA</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase">Costs</th>
                        </tr>
                    </thead>
                <tbody class="bg-white divide-y divide-slate-100">
                  <!-- If the API for some reason returns no legs, make that obvious -->
                  <template x-if="!(mpResult?.legs && mpResult.legs.length)">
                    <tr>
                      <td colspan="4" class="px-6 py-4 text-xs text-slate-400">
                        No voyage legs returned from the multi-port API. Check the backend response for this itinerary.
                      </td>
                    </tr>
                  </template>

                  <!-- Normal case: one summary row + expandable breakdown per leg -->
                  <template x-for="leg in (mpResult?.legs || [])" :key="leg.leg">
                    <!-- Summary row -->
                  <tr
                    class="cursor-pointer hover:bg-slate-50"
                    @click="
                      mpExpandedLeg === leg.leg ? mpExpandedLeg = null : mpExpandedLeg = leg.leg
                    "
                  >
                    <td class="px-6 py-3 text-sm text-slate-500">
                      <div class="flex items-center gap-2">
                        <svg
                          class="w-4 h-4 text-slate-400 transform transition-transform duration-150"
                          :class="mpExpandedLeg === leg.leg ? 'rotate-90' : 'rotate-0'"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                        <span x-text="leg.leg"></span>
                      </div>
                    </td>
                    <td class="px-6 py-3 text-sm font-medium text-slate-800"
                        x-text="`${leg.from_port} â†’ ${leg.to_port}`"></td>
                    <td class="px-6 py-3 text-sm text-slate-500"
                        x-text="formatIsoDate(leg.eta)"></td>
                    <td class="px-6 py-3 text-right text-sm font-mono font-bold text-ocean-600">
                      <span
                        x-text="formatCurrency(
                          Number(leg.fees?.mandatory || 0) +
                          Number(leg.fees?.optional_high || 0)
                        )"
                      ></span>
                    </td>
                  </tr>
                  <!-- Expanded breakdown row -->
                  <tr
                    x-show="mpExpandedLeg === leg.leg"
                    class="bg-slate-50/80"
                  >
                    <td colspan="4" class="px-6 py-3">
                        <div class="space-y-3">
                          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 text-[11px] text-slate-600">
                            <div class="bg-white border border-slate-200 rounded-lg p-3 flex items-start gap-2">
                              <div class="w-8 h-8 rounded-full bg-ocean-50 text-ocean-600 flex items-center justify-center font-bold text-xs">AT</div>
                              <div class="space-y-1">
                                <div class="text-[10px] font-semibold uppercase text-slate-400">Arrival Type</div>
                                <div
                                  class="inline-flex items-center px-2 py-0.5 rounded-full font-semibold text-[11px]"
                                  :class="leg.arrival_type === 'COASTWISE'
                                    ? 'bg-emerald-50 text-emerald-700 border border-emerald-100'
                                    : 'bg-sky-50 text-sky-700 border border-sky-100'"
                                  x-text="leg.arrival_type || 'Unknown'"
                                ></div>
                              </div>
                            </div>

                            <div class="bg-white border border-slate-200 rounded-lg p-3 flex items-start gap-2">
                              <div class="w-8 h-8 rounded-full bg-amber-50 text-amber-600 flex items-center justify-center font-bold text-xs">WE</div>
                              <div class="space-y-1">
                                <div class="text-[10px] font-semibold uppercase text-slate-400">Weekend Arrival</div>
                                <div class="text-sm font-semibold" :class="leg.weekend_arrival ? 'text-amber-700' : 'text-slate-700'">
                                  <span x-text="leg.weekend_arrival ? 'Yes â€” overtime may apply' : 'No'" ></span>
                                </div>
                              </div>
                            </div>

                            <div class="bg-white border border-slate-200 rounded-lg p-3 flex items-start gap-2">
                              <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-xs">DOC</div>
                              <div class="space-y-1">
                                <div class="text-[10px] font-semibold uppercase text-slate-400">Documents</div>
                                <div class="text-sm font-semibold text-slate-800" x-text="leg.documents_required ? `${leg.documents_required} required` : 'None reported'"></div>
                                <div class="text-[10px] text-slate-500">Based on arrival port + prior port.</div>
                              </div>
                            </div>

                            <div class="bg-white border border-slate-200 rounded-lg p-3 flex items-start gap-2">
                              <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-700 flex items-center justify-center font-bold text-xs">ETD</div>
                              <div class="space-y-1">
                                <div class="text-[10px] font-semibold uppercase text-slate-400">Time in Port</div>
                                <div class="text-sm font-semibold text-slate-800" x-text="legDurationDays(leg) ? `${legDurationDays(leg)} day(s) in port` : 'Duration not provided'" ></div>
                                <div class="text-[10px] text-slate-500">ETA: <span x-text="formatLocalTime(leg.eta)"></span> Â· ETD: <span x-text="formatLocalTime(leg.etd)"></span></div>
                              </div>
                            </div>
                          </div>

                          <div class="flex items-center justify-between">
                            <div class="text-xs font-semibold text-slate-500">Fee breakdown for this port</div>
                            <div class="flex items-center gap-2 text-[11px] text-slate-500">
                              <span>ETA</span>
                              <input
                                type="date"
                                class="field py-0.5 px-2 text-[11px] h-7"
                                :value="formatIsoDate(leg.eta)"
                                @change="updateLegEta(leg, $event.target.value)"
                              />
                            </div>
                          </div>
                        </div>

                        <template x-if="leg.fee_breakdown && leg.fee_breakdown.length">
                          <div class="border border-slate-200 rounded-lg overflow-hidden bg-white">
                              <table class="min-w-full divide-y divide-slate-100">
                                <thead class="bg-slate-50">
                                  <tr>
                                    <th class="px-3 py-2 text-left text-[11px] font-bold text-slate-500 uppercase">Fee</th>
                                    <th class="px-3 py-2 text-right text-[11px] font-bold text-slate-500 uppercase">Amount</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <template x-for="item in leg.fee_breakdown" :key="item.code + item.name">
                                    <tr class="text-xs">
                                      <td class="px-3 py-1.5">
                                        <span class="font-medium text-slate-800" x-text="item.name"></span>
                                        <span
                                          x-show="item.is_optional"
                                          class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-slate-100 text-slate-700"
                                        >
                                          Optional
                                        </span>
                                      </td>
                                      <td class="px-3 py-1.5 text-right font-mono text-slate-700" x-text="formatCurrency(item.final_amount)"></td>
                                    </tr>
                                  </template>
                                  <tr class="bg-slate-50">
                                    <td class="px-3 py-2 text-[11px] font-bold text-slate-600">Leg Total (mandatory)</td>
                                    <td class="px-3 py-2 text-right font-mono text-ocean-700 font-semibold"
                                        x-text="formatCurrency(leg.totals?.mandatory || leg.fees?.mandatory || 0)"></td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </template>

                          <template x-if="!(leg.fee_breakdown && leg.fee_breakdown.length)">
                            <div class="bg-white border border-dashed border-slate-200 rounded-lg p-4 text-xs text-slate-600 space-y-2">
                              <div class="flex items-center justify-between">
                                <span class="font-semibold text-slate-700">Leg total (mandatory):</span>
                                <span class="font-mono text-ocean-700 font-semibold" x-text="formatCurrency(leg.totals?.mandatory || leg.fees?.mandatory || 0)"></span>
                              </div>
                              <div class="text-[11px] text-slate-500">Detailed per-fee breakdown was not provided by the API for this leg.</div>
                            </div>
                          </template>
                      </td>
                    </tr>
                  </template>
                </tbody>
                </table>
            </div>
            <div class="bg-slate-900 text-white p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div class="flex items-center gap-3">
                <span class="text-sm font-medium opacity-80">Total Voyage Cost</span>
              </div>
              <div class="flex flex-wrap gap-4 items-center justify-end">
                <div class="text-right">
                  <div class="text-[11px] uppercase font-semibold text-ocean-200">Mandatory</div>
                  <div class="text-2xl font-bold" x-text="formatCurrency(mpResult?.total_voyage_cost?.mandatory || 0)"></div>
                </div>
                <div class="w-px h-10 bg-white/20"></div>
                <div class="text-right">
                  <div class="text-[11px] uppercase font-semibold text-ocean-200">With optional</div>
                  <div class="text-2xl font-bold" x-text="formatCurrency(mpResult?.total_voyage_cost?.with_optional || mpResult?.total_voyage_cost?.mandatory || 0)"></div>
                </div>
              </div>
            </div>
        </div>

        <!-- Port Documents -->
        <div
          x-show="portDocuments().length"
          class="card p-4 no-print"
        >
          <h3 class="text-sm font-bold text-slate-800 mb-2">Required Documents</h3>
          <ul class="text-xs text-slate-600 space-y-1">
            <template x-for="doc in portDocuments()" :key="doc.document_code || doc.document_name || doc.name || doc.title || doc.code">
              <li>
                <span class="font-semibold" x-text="doc.document_name || doc.name || doc.title || doc.code || 'Document'"></span>
                <span x-show="doc.authority || doc.note || doc.notes" class="ml-1 text-slate-400" x-text="'Â· ' + (doc.authority || doc.note || doc.notes)"></span>
                <span x-show="doc.lead_time_hours || doc.lead_time || doc.leadTime" class="ml-1 text-slate-400" x-text="'Â· ' + (doc.lead_time_hours || doc.lead_time || doc.leadTime) + 'h prior'"></span>
              </li>
            </template>
          </ul>
        </div>

        <!-- Footer Actions -->
        <div class="flex justify-end gap-4 pt-4 border-t border-slate-200 no-print">
            <button @click="refreshAll" class="text-xs text-slate-500 hover:text-ocean-600">Refresh Data</button>
            <button @click="clearCache" class="text-xs text-slate-500 hover:text-red-600">Clear Cache</button>
        </div>

      </div> <!-- End Right Column -->
    </div>
  </main>

  <!-- Logic Script -->
  <script>
    function portCallApp() {
      return {
        // --- State ---
        activeTab: 'voyage',
        apiStatus: 'Checkingâ€¦',
        cacheStats: '',
        audienceProfile: 'agent', // 'agent' | 'owner' | 'full'

        // search & paging
        vesselQuery: '',
        vesselSearched: false,
        searchLoading: false,
        searchError: null,
        vesselResults: [],
        vesselPage: 1,
        vesselLimit: 25,
        vesselPages: 1,
        vesselTotal: 0,
        vesselStart: 0,
        vesselEnd: 0,
  
        // selection & forms
        selectedVessel: null,
        zones: [],
        portSearchIndex: [],
        zoneLookup: {},
        portLookup: {},
        terminalLookup: {},
        zoneLabels: {},
        portLabels: {},
        terminalLabels: {},
        selectedPortContext: null,
        selectedPort: '',
        selectedPortDetails: null,
        selectedPortHolidays: [],
        documentRequirements: [],
        portDetailCache: {},
        portQuery: '',
        filteredPorts: [],
        showPortDropdown: false,
        portSearchTimeout: null,
        eta: new Date().toISOString().split('T')[0],
        netTonnage: '',
        ytdCbpPaid: '0',

        // v2 fields
        previousPortCode: '',
        nextPortCode: '',
        etd: '',
        daysAlongside: 2,
        laytimeAllowedDays: 2,
        demurrageRate: 0,
        vesselType: 'general_cargo',
        grossTonnage: 0,
        loaMeters: 0,
        beamMeters: 0,
        draftForwardMeters: 0,
        draftAftMeters: 0,
        airDraftMeters: 0,

        // autofill flags
        autoGT: false,
        autoNT: false,
        autoLOA: false,
        autoBeam: false,
  
        // UN/LOCODE suggestions
        unlocPrev: [],
        unlocNext: [],
  
        // multi-port
        mpVesselName: '',
        stops: [],
        mpResult: null,
        mpHistory: [],
        mpExpandedLeg: null,

        // results
        estimateV2: null,
        estimateLoading: false,
        liveData: null,
        estimateHistory: [],
        historyDropdownOpen: false,
  
        async init() {
          await this.checkHealth();
          await this.loadPorts();
          this.loadEstimateHistory();
          this.initMpHistory();
        },
  
        async checkHealth() {
          try {
            const r = await fetch(`${API_BASE}/health`);
            const d = await r.json();
            this.apiStatus = d.ok ? 'Online' : 'Offline';
            this.cacheStats = d.cache_stats ? `${d.cache_stats.active_entries} active` : '';
          } catch (e) {
            this.apiStatus = 'Error';
            console.error('Health failed:', e);
          }
        },
  
        async loadPorts() {
          try {
            const r = await fetch(`${API_BASE}/ports`);
            const payload = await r.json();
            const zones = Array.isArray(payload) ? payload : Array.isArray(payload.zones) ? payload.zones : Array.isArray(payload.data) ? payload.data : [];
            this.buildPortCaches(zones);
            this.filteredPorts = [];
            this.showPortDropdown = false;
            this.syncPortQueryWithSelection();
          } catch (e) {
            console.error('Ports load failed:', e);
          }
        },

        buildPortCaches(zones) {
          const allowedStates = new Set(['CA', 'OR', 'WA', 'AK', 'HI']);
          const isWestCoastZone = (zone) => {
            const state = String(zone?.primary_state || '').trim().toUpperCase();
            const region = String(zone?.region || '').toLowerCase();
            const country = String(zone?.country || '').trim().toUpperCase();
            if (region.includes('west')) return true;
            if (country === 'US' && allowedStates.has(state)) return true;
            return false;
          };

          const tokenize = (...values) => {
            const tokens = new Set();
            const push = (value) => {
              if (Array.isArray(value)) { value.forEach(push); return; }
              if (value == null) return;
              String(value).toLowerCase().split(/[^a-z0-9]+/i).filter(Boolean).forEach((token) => tokens.add(token));
            };
            values.forEach(push);
            return Array.from(tokens).join(' ');
          };

          const filteredZones = zones.filter(isWestCoastZone);
          this.zones = filteredZones;
          this.zoneLookup = {};
          this.portLookup = {};
          this.terminalLookup = {};
          this.zoneLabels = {};
          this.portLabels = {};
          this.terminalLabels = {};

          const index = [];

          for (const zone of filteredZones) {
            const zoneCode = String(zone?.zone_code || '').trim().toUpperCase();
            const zoneName = zone?.zone_name || zoneCode || 'Unknown Zone';
            this.zoneLookup[zoneCode] = zone;
            this.zoneLabels[zoneCode] = zoneCode ? `${zoneName} (${zoneCode})` : zoneName;

            const zoneTokenCollector = [zoneCode, zoneName, zone?.region, zone?.primary_state, zone?.country];
            const zoneEntries = [];
            const ports = Array.isArray(zone?.ports) ? zone.ports : [];
            
            for (const port of ports) {
              const portCode = String(port?.code || '').trim().toUpperCase();
              const portName = port?.name || portCode || 'Unnamed Port';
              if (portCode) this.portLookup[portCode] = { zoneCode, zoneName, port };
              if (portCode) this.portLabels[`${zoneCode}::${portCode}`] = `${zoneName} â€¢ ${portName}`;

              zoneTokenCollector.push(portCode, portName, port?.state, port?.country, port?.region);
              const location = [port?.state || zone?.primary_state, port?.country || zone?.country].filter(Boolean).join(', ');

              // Deduplication: If ZoneCode == PortCode and it's the only port, skip the port entry
              const isSelfZone = ports.length === 1 && zoneCode && portCode && zoneCode === portCode;

              const portEntry = {
                type: 'port', zoneCode, zoneName, portCode, portName, terminalCode: null, terminalName: null, zone, port, terminal: null,
                label: `${zoneName} â€¢ ${portName}`,
                description: [zoneCode ? `Zone ${zoneCode}` : null, portCode ? `Port ${portCode}` : null, location || null].filter(Boolean).join(' Â· '),
                operator: '',
                haystack: tokenize(zoneCode, zoneName, zone?.region, zone?.primary_state, zone?.country, portCode, portName, port?.state, port?.country, port?.region),
              };
              
              if (!isSelfZone) {
                  zoneEntries.push(portEntry);
              }

              const terminals = Array.isArray(port?.public_terminals) ? port.public_terminals : [];
              for (const term of terminals) {
                const termCodeRaw = term?.code ? String(term.code).trim() : '';
                const termCode = termCodeRaw.toUpperCase();
                const termName = term?.name || termCode || 'Terminal';
                const operator = term?.operator_name || '';
                const notes = term?.notes || '';
                zoneTokenCollector.push(termCode, termName, operator);
                const terminalEntry = {
                  type: 'terminal', zoneCode, zoneName, portCode, portName, terminalCode: termCode || null, terminalName: termName, zone, port, terminal: term,
                  label: `${zoneName} â€¢ ${portName} â€¢ ${termName}`,
                  description: [zoneCode ? `Zone ${zoneCode}` : null, portCode ? `Port ${portCode}` : null, termCode ? `Terminal ${termCode}` : null, operator || null, location || null].filter(Boolean).join(' Â· '),
                  operator,
                  haystack: tokenize(zoneCode, zoneName, zone?.region, zone?.primary_state, zone?.country, portCode, portName, port?.state, port?.country, port?.region, termCode, termName, operator, notes),
                };
                zoneEntries.push(terminalEntry);
                if (termCode) {
                  this.terminalLookup[`${zoneCode}::${termCode}`] = { zoneCode, portCode, terminal: term, port, zone };
                  this.terminalLabels[`${zoneCode}::${termCode}`] = terminalEntry.label;
                }
                if (termName) {
                  this.terminalLookup[`${zoneCode}::name::${termName.toLowerCase()}`] = { zoneCode, portCode, terminal: term, port, zone };
                }
              }
            }
            const portCount = ports.length;
            const zoneEntry = {
              type: 'zone', zoneCode, zoneName, portCode: null, portName: null, terminalCode: null, terminalName: null, zone, port: null, terminal: null,
              label: zoneName,
              description: [zoneCode ? `Zone ${zoneCode}` : null, [zone?.primary_state, zone?.country].filter(Boolean).join(', ') || null, portCount ? `${portCount} port${portCount === 1 ? '' : 's'}` : null].filter(Boolean).join(' Â· '),
              operator: '',
              haystack: tokenize(zoneTokenCollector),
            };
            index.push(zoneEntry, ...zoneEntries);
          }
          
          // Sort index: Zones first, then Ports, then Terminals, then Alphabetical
          index.sort((a, b) => {
              const typeScore = { zone: 1, port: 2, terminal: 3 };
              if (typeScore[a.type] !== typeScore[b.type]) return typeScore[a.type] - typeScore[b.type];
              return (a.label || '').localeCompare(b.label || '');
          });

          this.portSearchIndex = index;
        },

        makeSelectionContext(entry) {
          if (!entry) return null;
          const zone = this.zoneLookup[entry.zoneCode] || entry.zone || null;
          const port = entry.port || (entry.portCode ? this.portLookup[entry.portCode]?.port : null);
          let terminal = entry.terminal || null;
          if (!terminal && entry.terminalCode && port) {
            terminal = (Array.isArray(port?.public_terminals) ? port.public_terminals : []).find(
              (t) => String(t?.code || '').trim().toUpperCase() === entry.terminalCode
            ) || null;
          }
          const labelParts = [entry.zoneName || entry.zoneCode];
          if (entry.portName) labelParts.push(entry.portName);
          if (entry.terminalName) labelParts.push(entry.terminalName);
          const descriptionParts = [
            entry.zoneCode ? `Zone ${entry.zoneCode}` : null,
            entry.portCode ? `Port ${entry.portCode}` : null,
            entry.terminalCode ? `Terminal ${entry.terminalCode}` : null,
            [port?.state || zone?.primary_state, port?.country || zone?.country].filter(Boolean).join(', ') || null,
          ].filter(Boolean);
          if (terminal?.operator_name) descriptionParts.push(terminal.operator_name);

          return {
            ...entry, zone, port, terminal,
            label: labelParts.join(' â€¢ '),
            description: descriptionParts.join(' Â· '),
            operator: terminal?.operator_name || entry.operator || '',
          };
        },

        selectedPortIsEca() {
          const ctx = this.selectedPortContext;
          if (!ctx) return false;
          if (ctx.port && typeof ctx.port.is_eca === 'boolean') return ctx.port.is_eca;
          const zonePorts = Array.isArray(ctx.zone?.ports) ? ctx.zone.ports : [];
          if (!zonePorts.length) return false;
          const zoneCode = String(ctx.zoneCode || '').toUpperCase();
          const match = zoneCode ? zonePorts.find((p) => String(p.code || '').toUpperCase() === zoneCode) : null;
          if (match && typeof match.is_eca === 'boolean') return match.is_eca;
          return zonePorts.some((p) => p.is_eca !== false);
        },

        getRepresentativePort() {
          const ctx = this.selectedPortContext;
          if (ctx?.port && (ctx.port.latitude || ctx.port.longitude)) return ctx.port;
          const zonePorts = Array.isArray(ctx?.zone?.ports) ? ctx.zone.ports : [];
          if (!zonePorts.length) return null;
          const zoneCode = String(ctx?.zoneCode || '').toUpperCase();
          if (zoneCode) {
            const direct = zonePorts.find((p) => String(p.code || '').toUpperCase() === zoneCode);
            if (direct) return direct;
          }
          return zonePorts[0] || null;
        },

        getSelectedCoordinates() {
          const port = this.getRepresentativePort() || (Array.isArray(this.selectedPortDetails?.ports) ? this.selectedPortDetails.ports[0] : null);
          if (!port) return null;
          const lat = Number(port.latitude);
          const lon = Number(port.longitude);
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
          return { lat, lon };
        },

        derivedArrivalType() {
          const prev = (this.previousPortCode || '').trim().toUpperCase();
          if (!prev) return null;
          return prev.startsWith('US') ? 'COASTWISE' : 'FOREIGN';
        },

        formatCurrency(value) {
          const n = Number(value);
          if (!Number.isFinite(n)) return '$0.00';
          return n.toLocaleString(undefined, { style: 'currency', currency: 'USD', minimumFractionDigits: 2 });
        },

        isRegulatoryFee(c) {
          const code = (c.code || '').toUpperCase();
          return [
            'CBP_USER_FEE',
            'CBP_COMMERCIAL_VESSEL_ARRIVAL_FEE',
            'APHIS_AQI',
            'APHIS_COMMERCIAL_VESSEL',
            'TONNAGE_TAX',
            'TONNAGE_TAX_PER_TON',
            'CA_MISP',
            'CA_MISP_PER_VOYAGE',
          ].includes(code);
        },

        isCorePortFee(c) {
          const code = (c.code || '').toUpperCase();
          return [
            'PILOTAGE',
            'MARINE_EXCHANGE',
            'MX_VTS_PER_CALL',
            'DOCKAGE',
          ].includes(code);
        },

        isOperationalExtra(c) {
          const code = (c.code || '').toUpperCase();
          const operationalCodes = [
            'TOWAGE',
            'TUGBOAT',
            'LINE_HANDLING',
            'LAUNCH_SERVICE',
            'GARBAGE',
            'FRESH_WATER',
          ];

          if (operationalCodes.includes(code)) return true;

          // Catch common variants so towage/line-handling style extras are consistently identified
          return [
            'TUG',
            'TOW',
            'LINEHANDLING',
            'LAUNCH',
          ].some((keyword) => code.includes(keyword));
        },

        filteredCalculations() {
          const calcs = this.estimateV2?.calculations || [];
          if (!calcs.length) return [];

          if (this.audienceProfile === 'full') {
            return calcs;
          }

          if (this.audienceProfile === 'agent') {
            // Show regulatory + core port fees only
            return calcs.filter((c) =>
              this.isRegulatoryFee(c) || this.isCorePortFee(c)
            );
          }

          if (this.audienceProfile === 'owner') {
            // Hide towage/line-handling style operational extras
            return calcs.filter((c) => !this.isOperationalExtra(c));
          }

          return calcs;
        },

        profileTotals() {
          const calcs = this.filteredCalculations();
          if (!calcs.length) return { mandatory: '0.00', total_high: '0.00' };

          let mandatory = 0;
          let best = 0;

          for (const c of calcs) {
            const n = Number(c.final_amount);
            if (!Number.isFinite(n)) continue;

            if (c.is_optional && !c.manual_entry) {
              // only contributes to best-case
              best += n;
            } else {
              // mandatory shows up in both
              mandatory += n;
              best += n;
            }
          }

          return {
            mandatory: mandatory.toFixed(2),
            total_high: best.toFixed(2),
          };
        },

        regOpsTotals() {
          const calcs = this.filteredCalculations();
          let regulatory = 0;
          let portOps = 0;

          for (const c of calcs) {
            const n = Number(c.final_amount);
            if (!Number.isFinite(n)) continue;

            if (this.isRegulatoryFee(c)) {
              regulatory += n;
            } else {
              portOps += n;
            }
          }

          return {
            regulatory,
            portOps,
          };
        },

        potentialDemurrage() {
          const days = Number(this.daysAlongside) || 0;
          const allowed = Number(this.laytimeAllowedDays) || 0;
          const rate = Number(this.demurrageRate) || 0;
          const excess = Math.max(0, days - allowed);
          return Math.max(0, excess * rate);
        },

        formatIsoDate(dateString) {
          if (!dateString) return '';
          const d = new Date(dateString);
          if (Number.isNaN(d.getTime())) return dateString;
          return d.toISOString().slice(0, 10);
        },
        formatIsoTime(dateString) {
          if (!dateString) return '';
          const d = new Date(dateString);
          if (Number.isNaN(d.getTime())) return dateString;
          const hh = String(d.getHours()).padStart(2, '0');
          const mm = String(d.getMinutes()).padStart(2, '0');
          return `${hh}:${mm}`;
        },

        formatDate(dateString) {
          if (!dateString) return '';
          const d = new Date(dateString);
          if (Number.isNaN(d.getTime())) return dateString;
          return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        },

        formatIsoDate(dateString) {
          if (!dateString) return '';
          if (typeof dateString === 'string' && dateString.includes('T')) {
            return dateString.split('T')[0];
          }

          const d = new Date(dateString);
          if (!Number.isNaN(d.getTime())) {
            try { return d.toISOString().split('T')[0]; } catch (e) { /* ignore */ }
          }
          return dateString;
        },

        formatLocalTime(isoString) {
          if (!isoString) return '';
          const d = new Date(isoString);
          if (Number.isNaN(d.getTime())) return isoString;
          return d.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        },

        legDurationDays(leg) {
          if (!leg || !leg.eta || !leg.etd) return null;
          const start = new Date(leg.eta);
          const end = new Date(leg.etd);
          if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return null;
          const ms = end - start;
          if (ms <= 0) return null;
          const days = Math.round(ms / (1000 * 60 * 60 * 24));
          return Math.max(days, 1);
        },

        async loadDocumentRequirements() {
          // Pull structured doc requirements from the v2 API, not from /ports
          if (!this.selectedPortContext) {
            this.documentRequirements = [];
            return;
          }

          // Prefer the zone / internal code for document lookup
          const portCode =
            (this.selectedPortContext.zoneCode || this.selectedPort || '').toString().trim().toUpperCase();
          if (!portCode) {
            this.documentRequirements = [];
            return;
          }

          const params = new URLSearchParams({ port_code: portCode });
          if (this.vesselType) params.set('vessel_type', this.vesselType);
          if (this.previousPortCode && this.previousPortCode.trim()) {
            params.set('previous_port', this.previousPortCode.trim());
          }

          try {
            const r = await fetch(`${API_BASE}/api/v2/documents/requirements?${params.toString()}`);
            if (!r.ok) throw new Error('documents request failed');
            const data = await r.json();
            this.documentRequirements = Array.isArray(data) ? data : [];
          } catch (e) { console.error('Document requirements load failed:', e); this.documentRequirements = []; }
        },

        portDocuments() {
          if (!this.selectedPortDetails) return [];
          // Now driven by /api/v2/documents/requirements instead of /ports
          return Array.isArray(this.documentRequirements) ? this.documentRequirements : [];
        },

        portResultTitle(entry) { return entry ? (entry.label || '') : ''; },
        portResultDescription(entry) { return entry ? (entry.description || '') : ''; },

        async afterPortSelection() {
          if (!this.selectedPort) {
            this.selectedPortDetails = null;
            this.selectedPortHolidays = [];
            this.documentRequirements = [];
            return;
          }
          try {
            this.loadLiveData();
            // Use the zone code for /ports/{code}, not the internal port code
            const insightCode = this.selectedPortContext?.zoneCode || this.selectedPort;
            if (insightCode) {
              await this.fetchPortInsights(insightCode);
            } else {
              this.selectedPortDetails = null;
              this.selectedPortHolidays = [];
            }
            await this.loadDocumentRequirements();
          } catch (e) { console.error('afterPortSelection failed:', e); }
        },

        resetWeather() {
          // Just clear weather/tide; keep liveData (alerts/docs) intact
          this.weatherSnapshot = null;
          this.weatherError = null;
          this.weatherLoading = false;
        },

        syncPortQueryWithSelection() {
          if (!this.selectedPort) {
            this.selectedPortContext = null;
            this.portQuery = '';
            this.resetWeather();
            return;
          }

          const code = this.selectedPort;

          if (
            !this.selectedPortContext ||
            (this.selectedPortContext.portCode !== code && this.selectedPortContext.zoneCode !== code)
          ) {
            const fallback =
              this.portSearchIndex.find(e => e.portCode === code && e.type === 'port') ||
              this.portSearchIndex.find(e => e.zoneCode === code && e.type === 'zone');
            this.selectedPortContext = this.makeSelectionContext(fallback ?? null);
          }

          if (this.selectedPortContext) {
            this.portQuery = this.selectedPortContext.label;
            this.afterPortSelection();
          } else {
            this.portQuery = this.zoneLabels[code] || code;
            this.resetWeather();
          }
        },

        clearPortQuery() {
          if (this.portSearchTimeout) { clearTimeout(this.portSearchTimeout); this.portSearchTimeout = null; }
          this.portQuery = '';
          this.filteredPorts = [];
          this.showPortDropdown = false;
          if (this.selectedPort) { this.selectedPort = ''; this.selectedPortContext = null; }
          this.selectedPortDetails = null;
          this.selectedPortHolidays = [];
        },

        clearVoyage() {
          this.previousPortCode = '';
          this.nextPortCode = '';
          this.eta = new Date().toISOString().split('T')[0];
          this.etd = '';
          this.daysAlongside = 2;
          this.laytimeAllowedDays = 2;
          this.demurrageRate = 0;

          this.selectedPort = '';
          this.selectedPortContext = null;
          this.portQuery = '';
          this.filteredPorts = [];
          this.showPortDropdown = false;

          this.selectedPortDetails = null;
          this.selectedPortHolidays = [];
          this.stops = [];
          this.mpResult = null;
          this.mpExpandedLeg = null;
          this.liveData = null;
        },

        rankPortMatches(tokens) {
          const matches = [];
          for (const entry of this.portSearchIndex) {
            if (!entry?.haystack) continue;
            const haystack = entry.haystack;
            const allMatch = tokens.every((token) => haystack.includes(token));
            if (!allMatch) continue;
            let score = 0;
            const qExact = (value) => value && tokens.length === 1 && value === tokens[0];
            if (qExact(entry.zoneCode?.toLowerCase())) score += 6;
            if (qExact(entry.portCode?.toLowerCase())) score += 5;
            if (qExact(entry.terminalCode?.toLowerCase())) score += 5;
            const primaryMatches = [entry.zoneName, entry.portName, entry.terminalName].map((value) => (value || '').toLowerCase());
            for (const token of tokens) {
              if (entry.zoneCode?.toLowerCase().includes(token)) score += 2;
              if (entry.portCode?.toLowerCase().includes(token)) score += 2;
              if ((entry.terminalCode || '').toLowerCase().includes(token)) score += 2;
              if (primaryMatches.some((v) => v && v.includes(token))) score += 1;
            }
            if (entry.type === 'zone') score += 1;
            if (entry.type === 'port') score += 2;
            if (entry.type === 'terminal') score += 3;
            matches.push({ entry, score });
          }
          matches.sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            return (a.entry.label || '').localeCompare(b.entry.label || '');
          });

          const prioritized = [
            ...matches.filter((m) => m.entry.type === 'terminal' || m.entry.type === 'port'),
            ...matches.filter((m) => m.entry.type !== 'terminal' && m.entry.type !== 'port'),
          ];

          return prioritized.slice(0, 12).map((m) => m.entry);
        },

        searchPorts(immediate = false) {
          if (!Array.isArray(this.portSearchIndex) || this.portSearchIndex.length === 0) {
            this.filteredPorts = [];
            this.showPortDropdown = false;
            return;
          }
          if (this.portSearchTimeout) { clearTimeout(this.portSearchTimeout); this.portSearchTimeout = null; }

          const run = () => {
            this.portSearchTimeout = null;
            const query = (this.portQuery || '').trim().toLowerCase();
            if (!query) { this.filteredPorts = this.portSearchIndex.slice(0, 12); this.showPortDropdown = this.filteredPorts.length > 0; return; }
            const tokens = query.split(/[^a-z0-9]+/g).filter(Boolean);
            if (!tokens.length) { this.filteredPorts = this.portSearchIndex.slice(0, 12); this.showPortDropdown = this.filteredPorts.length > 0; return; }
            const matches = this.rankPortMatches(tokens);
            this.filteredPorts = matches;
            this.showPortDropdown = matches.length > 0;
          };
          if (immediate) run(); else this.portSearchTimeout = setTimeout(run, 180);
        },

        selectFirstPortResult(target = 'single') {
          const results = this.filteredPorts;
          if (results.length) {
            if (target === 'multi') this.selectStopPort(0, results[0]);
            else this.selectPort(results[0]);
          }
        },

        async selectPort(entry) {
          if (!entry) return;
          const context = this.makeSelectionContext(entry);
          this.selectedPortContext = context;
          // Use the actual port code for API calls; fall back to zone if we ever select a pure zone row.
          this.selectedPort = context?.portCode || context?.zoneCode || '';
          this.portQuery = context?.label || '';
          this.filteredPorts = [];
          this.showPortDropdown = false;
          await this.afterPortSelection();
        },

        // ---------- Normalizer ----------
        augment(v) {
          const src = (v && typeof v === 'object') ? { ...v } : {};
          const scanDeep = (obj, keyRegex, accept = (val) => ((typeof val === 'string' && val.trim() !== '') || typeof val === 'number'), depth = 0) => {
            if (!obj || depth > 4) return null;
            for (const [k, val] of Object.entries(obj)) {
              if (val == null) continue;
              if (keyRegex.test(k)) { const s = String(val).trim(); if (accept(s)) return s; }
              if (val && typeof val === 'object' && !Array.isArray(val)) { const found = scanDeep(val, keyRegex, accept, depth + 1); if (found != null) return found; }
            }
            return null;
          };
          const scan = (re, accept) => scanDeep(src, re, accept);
          const pick = (...cands) => {
            for (const c of cands) { if (c in src && src[c] != null) { const s = String(src[c]).trim(); if (s && s.toLowerCase() !== 'none') return s; } }
            return null;
          };
          const toNumber = (val) => { if (val == null) return null; const n = Number(String(val).replace(/[^0-9.+-]/g, '')); return Number.isFinite(n) ? n : null; };
          const toMetersGeneric = (val) => {
            if (val == null) return null; const s = String(val).toLowerCase(); const n = toNumber(s); if (n == null) return null;
            if (s.includes('ft') || s.includes('feet') || s.includes("'")) return n * 0.3048; return n;
          };
          const feetToMeters = (val) => { const n = toNumber(val); return n == null ? null : n * 0.3048; };
          const num7 = (x) => (x ? String(x).match(/\b\d{6,7}\b/)?.[0] : null);

          const VesselID = pick('VesselID','vesselid','VesselId','ID','id') ?? scan(/(^|[\W_])vessel\s*id$/i);
          const VesselName = pick('VesselName','vesselname','Name','name') ?? scan(/vessel.*name|^name$/i);
          const CallSign = pick('VesselCallSign','CallSign','Call_Sign','RadioCallSign','radio_callsign','callSign') ?? scan(/call.?sign|radio.?call/i);
          const Flag = pick('CountryLookupName','Flag','FlagName','FlagOfRegistry','FlagState','FlagCountry','FlagCode','flag') ?? scan(/(flag|country)(.*(name|lookup|state|country))?/i, v => isNaN(v));
          const VesselType = pick('ServiceType','VesselType','VesselTypeDescription','VesselService','Service','ShipType','vesseltype') ?? scan(/(service|type)/i, v => isNaN(v) && String(v).length < 80);
          const imoRaw = pick('IMONumber','IMO','ImoNumber','IMO_Number','IMONo','IMOShipNo','imo') || pick('PrimaryVesselNumber','Primary_Vessel_Number','Primary_Vessel_No') || scanDeep(src, /(^|[\W_])imo([\W_]|$)/i, v => /\d{6,7}/.test(String(v)));
          const IMONumber = num7(imoRaw);
          const OfficialNumber = pick('OfficialNumber','OfficialNumberText','Official_No','USOfficialNumber','US_Official_Number') ?? scan(/official.?number/i);
          const YearBuilt = (() => { const y = pick('ConstructionCompletedYear','YearBuilt','BuildYear','build_year') ?? scan(/(year.*built|build.*year|construction.*(year|completed))/i); const n = Number(String(y ?? '').replace(/\D/g,'')); return Number.isFinite(n) ? n : null; })();
          const gtRaw = pick('GrossTonnage','GrossRegisteredTonnage','GrossTons','GT','Gross_Tonnage','grosstonnage') ?? scan(/gross.*ton|(^|\b)gt\b/i);
          const ntRaw = pick('NetTonnage','NetRegisteredTonnage','NetTons','NT','Net_Tonnage','nettonnage') ?? scan(/net.*ton|(^|\b)nt\b/i);
          const GrossTonnage = (toNumber(gtRaw) ?? gtRaw) ?? null;
          const NetTonnage = (toNumber(ntRaw) ?? ntRaw) ?? null;
          const lenMetersRaw = pick('LOA_m','LengthInMeters','LOAInMeters','OverallLengthInMeters','loa_m','length_m');
          const lenFeetRaw = pick('LengthInFeet','LOAInFeet','OverallLengthInFeet','Length (ft)');
          const lenGeneric = pick('LOA','Length','LengthOverall','OverallLength','loa','length_overall') ?? scan(/(length|loa)/i);
          const LOA_m = toNumber(lenMetersRaw) ?? (feetToMeters(lenFeetRaw)) ?? toMetersGeneric(lenGeneric);
          const beamMetersRaw = pick('Beam_m','BreadthInMeters','BeamInMeters','OverallBreadthInMeters','MouldedBreadthInMeters','beam_m','breadth_m');
          const beamFeetRaw = pick('BreadthInFeet','BeamInFeet','OverallBreadthInFeet','MouldedBreadthInFeet','Breadth (ft)');
          const beamGeneric = pick('Beam','Breadth','MouldedBreadth','MoldedBreadth','Width','beam','breadth') ?? scan(/(beam|breadth|width)/i);
          const Beam_m = toNumber(beamMetersRaw) ?? (feetToMeters(beamFeetRaw)) ?? toMetersGeneric(beamGeneric);
          const depthMetersRaw = pick('Depth_m','DepthInMeters','MouldedDepthInMeters','depth_m');
          const depthFeetRaw = pick('DepthInFeet','MouldedDepthInFeet','Depth (ft)');
          const depthGeneric = pick('Depth','depth') ?? scan(/(^|\b)depth\b/i);
          const Depth_m = toNumber(depthMetersRaw) ?? (feetToMeters(depthFeetRaw)) ?? toMetersGeneric(depthGeneric);
          const draftFwdMetersRaw = pick('DraftForward_m','ForwardDraft_m','ForwardDraftInMeters','ForwardDraftMeters','forward_draft_m','draft_forward_meters');
          const draftFwdFeetRaw = pick('ForwardDraftInFeet','ForwardDraftFeet','forward_draft_ft');
          const draftFwdGeneric = scan(/forward.*draft/i);
          const DraftForward_m = toNumber(draftFwdMetersRaw) ?? (feetToMeters(draftFwdFeetRaw)) ?? toMetersGeneric(draftFwdGeneric);
          const draftAftMetersRaw = pick('DraftAft_m','AftDraft_m','AftDraftInMeters','AftDraftMeters','aft_draft_m','draft_aft_meters');
          const draftAftFeetRaw = pick('AftDraftInFeet','AftDraftFeet','aft_draft_ft');
          const draftAftGeneric = scan(/aft.*draft|draft.*aft/i);
          const DraftAft_m = toNumber(draftAftMetersRaw) ?? (feetToMeters(draftAftFeetRaw)) ?? toMetersGeneric(draftAftGeneric);
          const airDraftMetersRaw = pick('AirDraft_m','AirDraftInMeters','AirDraftMeters','air_draft_m');
          const airDraftFeetRaw = pick('AirDraftInFeet','AirDraftFeet','air_draft_ft');
          const airDraftGeneric = scan(/air.*draft/i);
          const AirDraft_m = toNumber(airDraftMetersRaw) ?? (feetToMeters(airDraftFeetRaw)) ?? toMetersGeneric(airDraftGeneric);
          const draftMetersRaw = pick('Draft_m','DraftInMeters','MaxDraftInMeters','draft_m');
          const draftFeetRaw = pick('DraftInFeet','MaxDraftInFeet','Draft (ft)');
          const draftGeneric = pick('Draft','SummerDraft','draft') ?? scan(/(^|\b)draft\b|(^|\b)summer.*draft\b/i);
          const Draft_m = toNumber(draftMetersRaw) ?? (feetToMeters(draftFeetRaw)) ?? toMetersGeneric(draftGeneric);

          return { ...src, VesselID, VesselName, CallSign, Flag, VesselType, IMONumber, OfficialNumber, YearBuilt, GrossTonnage, NetTonnage, LOA_m, Beam_m, Draft_m, Depth_m, DraftForward_m, DraftAft_m, AirDraft_m };
        }, 

        // --- Vessel search ---
        async searchVessel(page = 1) {
          if (!this.vesselQuery.trim()) return;
          this.vesselSearched = true; this.searchLoading = true; this.searchError = null; this.vesselPage = page;
          try {
            const params = new URLSearchParams({ name: this.vesselQuery, page: String(this.vesselPage), limit: String(this.vesselLimit) });
            const r = await fetch(`${API_BASE}/vessels/search?${params}`);
            if (!r.ok) throw new Error('Search failed');
            const data = await r.json();
            const raw = Array.isArray(data?.Table) ? data.Table : Array.isArray(data?.rows) ? data.rows : Array.isArray(data) ? data : [];
            const augmented = raw.map(this.augment.bind(this));
            this.vesselTotal = (typeof data.total === 'number') ? data.total : augmented.length;
            this.vesselPages = (typeof data.pages === 'number') ? data.pages : Math.max(Math.ceil(this.vesselTotal / this.vesselLimit), 1);
            this.vesselResults = augmented;
            if (this.vesselResults.length === 0) this.searchError = 'No vessels found';
          } catch (e) { this.searchError = e.message || 'Search failed'; console.error('Vessel search failed:', e); } finally { this.searchLoading = false; }
        },
  
        async selectVessel(v) {
          const prevSelected = this.selectedVessel || null;
          const makeToken = (obj) => {
            if (!obj) return '';
            const parts = [obj.VesselID ?? obj.vessel_id ?? obj.id ?? '', obj.CallSign ?? obj.VesselCallSign ?? '', obj.VesselName ?? obj.Name ?? ''].map(val => String(val || '').trim().toUpperCase()).filter(Boolean);
            return parts.join('|');
          };
          const prevToken = makeToken(prevSelected);
          const normalized = this.augment(v) || {};
          const nextToken = makeToken(normalized) || makeToken(v);
          const vesselChanged = !prevSelected || prevToken !== nextToken;
          this.selectedVessel = normalized;

          if (vesselChanged) {
            this.autoGT = false; this.autoNT = false; this.autoLOA = false; this.autoBeam = false;
            this.grossTonnage = null; this.netTonnage = null; this.loaMeters = null; this.beamMeters = null;
            this.draftForwardMeters = null; this.draftAftMeters = null; this.airDraftMeters = null;
          }

          const s = (normalized.VesselType || '').toLowerCase();
          const guess = s.includes('container') ? 'container' : s.includes('tanker') ? 'tanker' : s.includes('bulk') ? 'bulk_carrier' : (s.includes('cruise') || s.includes('passenger')) ? 'cruise' : (s.includes('roro') || s.includes('ro-ro')) ? 'roro' : s.includes('lng') ? 'lng' : (s.includes('vehicle') || s.includes('car carrier')) ? 'vehicle_carrier' : 'general_cargo';
          if (this.vesselType === 'general_cargo' && guess !== 'general_cargo') this.vesselType = guess;

          const prefer = (field, next, flag, dp = 2) => {
            const curr = this[field]; const n = Number(next); const currNum = Number(curr);
            const currValid = Number.isFinite(currNum) && currNum > 0; const nextValid = Number.isFinite(n) && n > 0;
            if (!nextValid) return curr;
            if (vesselChanged || !currValid || this[flag]) { this[flag] = true; return dp ? Number(n.toFixed(dp)) : n; }
            return curr;
          };
          if (normalized.GrossTonnage != null) this.grossTonnage = prefer('grossTonnage', normalized.GrossTonnage, 'autoGT', 0);
          if (normalized.NetTonnage != null) this.netTonnage = prefer('netTonnage', normalized.NetTonnage, 'autoNT', 0);
          if (normalized.LOA_m != null) this.loaMeters = prefer('loaMeters', normalized.LOA_m, 'autoLOA', 2);
          if (normalized.Beam_m != null) this.beamMeters = prefer('beamMeters', normalized.Beam_m, 'autoBeam', 2);

          const setDraftField = (field, value, dp = 2) => {
            const n = Number(value); if (!Number.isFinite(n) || n <= 0) return;
            if (!vesselChanged && Number(this[field]) > 0) return;
            this[field] = dp ? Number(n.toFixed(dp)) : n;
          };
          setDraftField('draftForwardMeters', normalized.DraftForward_m ?? normalized.Draft_m);
          setDraftField('draftAftMeters', normalized.DraftAft_m ?? normalized.Draft_m);
          setDraftField('airDraftMeters', normalized.AirDraft_m);

          await this.enrichVesselDimensions();
          if (this.selectedPort) this.loadLiveData();
        },
  
        // ----- v2 estimator -----
        async getEstimateV2() {
          if (!this.selectedPort || !this.eta || !this.previousPortCode.trim()) { alert('Previous port (UN/LOCODE), arrival port, and ETA are required for v2.'); return; }
          this.estimateLoading = true; this.estimateV2 = null;
          const fwdDraft = Number(this.draftForwardMeters) || 0; const aftDraft = Number(this.draftAftMeters) || 0; const airDraft = Number(this.airDraftMeters) || 0;
          const draftSamples = [fwdDraft, aftDraft].filter(v => v > 0);
          const representativeDraft = draftSamples.length ? Number((draftSamples.reduce((sum, v) => sum + v, 0) / draftSamples.length).toFixed(2)) : (fwdDraft || aftDraft || 0);
          const draftString = (val) => (val > 0 ? String(val) : null);

          const body = {
            vessel_name: this.selectedVessel?.VesselName || this.vesselQuery || 'Unknown Vessel',
            vessel_type: this.vesselType,
            gross_tonnage: String(this.grossTonnage || 0), net_tonnage: String(this.netTonnage || 0),
            loa_meters: String(this.loaMeters || 0), draft_meters: String(representativeDraft || 0), beam_meters: String(this.beamMeters || 0),
            forward_draft_meters: draftString(fwdDraft), aft_draft_meters: draftString(aftDraft), air_draft_meters: draftString(airDraft),
            previous_port_code: this.previousPortCode.trim().toUpperCase(), arrival_port_code: this.selectedPort, next_port_code: this.nextPortCode ? this.nextPortCode.trim().toUpperCase() : null,
            eta: this.eta ? new Date(this.eta).toISOString() : null, etd: this.etd ? new Date(this.etd).toISOString() : null,
            days_alongside: Number(this.daysAlongside) || 2, ytd_cbp_paid: String(this.ytdCbpPaid || 0), tonnage_year_paid: "0"
          };
   
          try {
            const r = await fetch(`${API_BASE}/v2/estimate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (!r.ok) throw new Error(await r.text() || 'v2 estimate failed');
            this.estimateV2 = await r.json();
            this.saveEstimateToHistory(this.estimateV2, body);
            if (this.selectedVessel) await this.loadLiveData();
          } catch (e) { console.error('v2 estimate failed:', e); alert('Failed to calculate v2 estimate.'); } finally { this.estimateLoading = false; }
        },
  
        // ----- PSIX Enrichment -----
        async enrichVesselDimensions() {
          const hasDraftInfo = (Number(this.draftForwardMeters) > 0) || (Number(this.draftAftMeters) > 0) || (Number(this.airDraftMeters) > 0);
          const needsDims = !(Number(this.loaMeters) > 0 && Number(this.beamMeters) > 0) || !hasDraftInfo;
          const needsTons = !(Number(this.grossTonnage) > 0) || !(Number(this.netTonnage) > 0);
          if (!needsDims && !needsTons && !this.autoGT && !this.autoNT && !this.autoLOA && !this.autoBeam) return;
        
          const sv = this.selectedVessel || {};
          const selToken = (sv.VesselID || sv.VesselName || '') + ':' + (sv.CallSign || '');
          const stillSelected = () => ((this.selectedVessel?.VesselID || this.selectedVessel?.VesselName || '') + ':' + (this.selectedVessel?.CallSign || '')) === selToken;
        
          const setIf = (curr, next, flag, dp = 2) => {
            if (Number(curr) > 0 && !this[flag]) return curr;
            const n = Number(next);
            if (Number.isFinite(n) && n > 0) { this[flag] = true; return dp ? Number(n.toFixed(dp)) : n; }
            return curr;
          };
          const setDraftIf = (field, value, dp = 2) => {
            if (Number(this[field]) > 0) return;
            const n = Number(value);
            if (Number.isFinite(n) && n > 0) { this[field] = dp ? Number(n.toFixed(dp)) : n; }
          };
        
          const qs = (obj) => Object.entries(obj).map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
          const unify = (payload) => {
            if (!payload) return [];
            if (Array.isArray(payload?.Table)) return payload.Table;
            if (Array.isArray(payload?.rows)) return payload.rows;
            if (Array.isArray(payload)) return payload;
            if (Array.isArray(payload?.data?.rows)) return payload.data.rows;
            if (payload?.data && typeof payload.data === 'object') return [payload.data];
            if (payload?.result && typeof payload.result === 'object') return [payload.result];
            return [payload];
          };
        
          const tryFetch = async (urls) => {
            for (const u of urls) {
              try { const r = await fetch(u); if (!r.ok) continue; const j = await r.json(); return j; } catch (_) { }
            }
            return null;
          };
        
          let vesselId = sv.VesselID || null;
          if (!vesselId) {
            const idParamSets = [{ id: sv.id }, { vessel_id: sv.id }, { VesselID: sv.id }].filter(p => Object.values(p)[0]);
            const keyParamSets = [];
            const cs = (sv.CallSign || sv.VesselCallSign || '').trim();
            const nm = (sv.VesselName || '').trim();
            if (cs) keyParamSets.push({ callsign: cs }, { CallSign: cs }, { call_sign: cs });
            if (nm) keyParamSets.push({ vessel_name: nm }, { name: nm }, { VesselName: nm });
        
            const idUrls = [];
            for (const p of idParamSets) {
              idUrls.push(`${API_BASE}/vessels/summary?${qs(p)}`);
              idUrls.push(`${API_BASE}/vessels/details?${qs(p)}`);
              idUrls.push(`${API_BASE}/api/v2/vessels/details?${qs(p)}`);
            }
            let summary = idUrls.length ? await tryFetch(idUrls) : null;
            if (!summary && keyParamSets.length) {
              const keyUrls = [];
              for (const p of keyParamSets) {
                keyUrls.push(`${API_BASE}/vessels/summary?${qs(p)}`);
                keyUrls.push(`${API_BASE}/vessels/details?${qs(p)}`);
                keyUrls.push(`${API_BASE}/api/v2/vessels/details?${qs(p)}`);
              }
              summary = await tryFetch(keyUrls);
            }
            const rows = unify(summary);
            if (rows.length) {
              const row = (cs && rows.find(r => String(r.VesselCallSign || r.CallSign || '').trim().toUpperCase() === cs.toUpperCase())) || rows[0];
              vesselId = row?.VesselID ?? row?.vessel_id ?? row?.ID ?? null;
              if (vesselId && !sv.VesselID) this.selectedVessel.VesselID = vesselId;
            }
          }
        
          if (!stillSelected()) return;
        
          const detailUrls = [];
          if (vesselId) {
            detailUrls.push(`${API_BASE}/vessels/details?${qs({ vessel_id: vesselId })}`);
            detailUrls.push(`${API_BASE}/api/v2/vessels/details?${qs({ vessel_id: vesselId })}`);
            detailUrls.push(`${API_BASE}/vessels/summary?${qs({ vessel_id: vesselId })}`);
          } else {
            const cs = (sv.CallSign || sv.VesselCallSign || '').trim();
            const nm = (sv.VesselName || '').trim();
            if (cs) {
              detailUrls.push(`${API_BASE}/vessels/details?${qs({ callsign: cs })}`);
              detailUrls.push(`${API_BASE}/api/v2/vessels/details?${qs({ callsign: cs })}`);
            }
            if (nm) {
              detailUrls.push(`${API_BASE}/vessels/details?${qs({ vessel_name: nm })}`);
              detailUrls.push(`${API_BASE}/api/v2/vessels/details?${qs({ name: nm })}`);
              detailUrls.push(`${API_BASE}/api/v2/vessels/details?${qs({ vessel_name: nm, service: 'ALL' })}`);
            }
          }
        
          let merged = {};
          for (const u of detailUrls) {
            try {
              const r = await fetch(u); if (!r.ok) continue; const j = await r.json(); const rows = unify(j); if (!rows.length) continue;
              const pickRow = rows.find(rw => rw.LengthInFeet || rw.GrossTonnage || rw.NetTonnage || rw.LOA_m || rw.Beam_m || rw.Draft_m) || rows[0];
              const extra = {};
              if (pickRow.LengthInFeet != null)  extra.LOA_m  = Number(pickRow.LengthInFeet)  * 0.3048;
              if (pickRow.BreadthInFeet != null) extra.Beam_m = Number(pickRow.BreadthInFeet) * 0.3048;
              if (pickRow.DepthInFeet != null)   extra.Depth_m = Number(pickRow.DepthInFeet)  * 0.3048;
              if (pickRow.ForwardDraftInFeet != null) extra.DraftForward_m = Number(pickRow.ForwardDraftInFeet) * 0.3048;
              if (pickRow.ForwardDraftInMeters != null) extra.DraftForward_m = Number(pickRow.ForwardDraftInMeters);
              if (pickRow.AftDraftInFeet != null) extra.DraftAft_m = Number(pickRow.AftDraftInFeet) * 0.3048;
              if (pickRow.AftDraftInMeters != null) extra.DraftAft_m = Number(pickRow.AftDraftInMeters);
              if (pickRow.AirDraftInFeet != null) extra.AirDraft_m = Number(pickRow.AirDraftInFeet) * 0.3048;
              if (pickRow.AirDraftInMeters != null) extra.AirDraft_m = Number(pickRow.AirDraftInMeters);
              merged = { ...merged, ...pickRow, ...extra };
              if (!vesselId) vesselId = pickRow.VesselID ?? pickRow.vessel_id ?? pickRow.ID ?? vesselId;
            } catch (_) {}
          }
        
          if (!stillSelected()) return;
          const aug = this.augment(merged || {});
          this.selectedVessel = { ...this.selectedVessel, ...aug };
        
          if (needsTons) {
            this.grossTonnage = setIf(this.grossTonnage, aug.GrossTonnage, 'autoGT', 0);
            this.netTonnage   = setIf(this.netTonnage,   aug.NetTonnage,   'autoNT', 0);
          }
          if (needsDims) {
            this.loaMeters  = setIf(this.loaMeters,  aug.LOA_m,  'autoLOA', 2);
            this.beamMeters = setIf(this.beamMeters, aug.Beam_m, 'autoBeam', 2);
            setDraftIf('draftForwardMeters', aug.DraftForward_m ?? aug.Draft_m, 2);
            setDraftIf('draftAftMeters', aug.DraftAft_m ?? aug.Draft_m, 2);
            setDraftIf('airDraftMeters', aug.AirDraft_m, 2);
          }
        },

        // Live bundle
        async loadLiveData() {
          if (!this.selectedVessel || !this.selectedPort) return;
          const params = new URLSearchParams({ vessel_name: this.selectedVessel.VesselName || '', port_code: this.selectedPort });
          if (this.selectedVessel.VesselID) params.set('vessel_id', this.selectedVessel.VesselID);
          try {
            const r = await fetch(`${API_BASE}/live/portbundle?${params}`);
            if (!r.ok) throw new Error('Live data failed');
            this.liveData = await r.json();
          } catch (e) { console.error('Live data failed:', e); }
        },

        async fetchPortInsights(zoneCode) {
          const code = (zoneCode || '').trim().toUpperCase();
          if (!code) { this.selectedPortDetails = null; this.selectedPortHolidays = []; return; }
          if (this.portDetailCache[code]) { this.selectedPortDetails = this.portDetailCache[code]; this.selectedPortHolidays = Array.isArray(this.portDetailCache[code]?.upcoming_holidays) ? this.portDetailCache[code].upcoming_holidays : []; return; }
          try {
            const r = await fetch(`${API_BASE}/ports/${code}`);
            if (!r.ok) throw new Error(await r.text());
            const data = await r.json();
            this.portDetailCache[code] = data; this.selectedPortDetails = data; this.selectedPortHolidays = Array.isArray(data?.upcoming_holidays) ? data.upcoming_holidays : [];
          } catch (e) { console.error('Port detail load failed:', e); this.selectedPortDetails = null; this.selectedPortHolidays = []; }
        },

        // UN/LOCODE typeahead
        async searchUnloc(current = 'prev') {
          const base = current === 'prev' ? this.previousPortCode : this.nextPortCode;
          const q = (base || '').trim();

          // Default suggestions if empty
          if (q.length === 0) {
            const defaults = [
              { locode: 'USLAX', port_name: 'Los Angeles' },
              { locode: 'USLGB', port_name: 'Long Beach' },
              { locode: 'USOAK', port_name: 'Oakland' },
              { locode: 'USSFO', port_name: 'San Francisco' },
              { locode: 'USSEA', port_name: 'Seattle' },
              { locode: 'USTAC', port_name: 'Tacoma' },
              { locode: 'USPDX', port_name: 'Portland' },
              { locode: 'USAST', port_name: 'Astoria' },
            ];
            if (current === 'prev') this.unlocPrev = defaults;
            else this.unlocNext = defaults;
            return;
          }

          if (q.length < 2) {
            if (current === 'prev') this.unlocPrev = []; else this.unlocNext = [];
            return;
          }
          try {
            // IMPORTANT:
            //  - previousPortCode must allow foreign ports so arrival_type/docs work
            //  - for nextPortCode we still *prefer* West Coast, but don't hard-block others
            const r = await fetch(`${API_BASE}/imo_ports/search?q=${encodeURIComponent(q)}&limit=50`);
            if (!r.ok) throw new Error('UN/LOCODE search failed');
            const rows = await r.json() || [];

            if (current === 'prev') {
              // global: foreign + US, since this drives FOREIGN vs COASTWISE + docs
              this.unlocPrev = rows;
            } else {
              // nextPort: prefer US West Coast, fall back to all rows if none match
              const allowed = new Set([
                'USLAX','USLGB','USOAK','USSFO',
                'USSEA','USTAC','USPDX','USAST',
              ]);
              const preferred = rows.filter(r => allowed.has(String(r.locode || '').toUpperCase()));
              this.unlocNext = preferred.length ? preferred : rows;
            }
          } catch (e) { console.error('UN/LOCODE search error:', e); }
        },
  
        // Client-side export
        clientExport(format = 'csv') {
          if (!this.estimateV2) return;
          if (format === 'json') {
            const blob = new Blob([JSON.stringify(this.estimateV2, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `estimate_v2_${this.selectedPort}_${this.eta}.json`; a.click(); return;
          }
          const rows = [['Code','Name','Final Amount','Base','Confidence','Optional','Details']];
          for (const c of (this.estimateV2.calculations || [])) {
            rows.push([c.code, c.name, c.final_amount, c.base_amount, c.confidence, c.is_optional ? 'yes' : 'no', (c.details || '').replace(/\n/g, ' ')]);
          }
          const t = this.estimateV2?.totals || {};
          rows.push(['', 'TOTAL MANDATORY', t.mandatory ?? '', '', '', '', '']);
          rows.push(['', 'TOTAL BEST CASE', t.total_high ?? '', '', '', '', '']);
          const csv = rows.map(r => r.map(x => `"${String(x ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `estimate_v2_${this.selectedPort}_${this.eta}.csv`; a.click();
        },

        loadEstimateHistory() {
          try {
            const raw = localStorage.getItem('maritime_estimate_history');
            this.estimateHistory = raw ? JSON.parse(raw) : [];
          } catch (e) { console.warn('History load failed', e); this.estimateHistory = []; }
        },

        persistEstimateHistory() {
          try { localStorage.setItem('maritime_estimate_history', JSON.stringify(this.estimateHistory)); } catch (e) { console.warn('History persist failed', e); }
        },

        saveEstimateToHistory(estimate, requestBody) {
          if (!estimate || !this.selectedPort) return;
          const req = requestBody || {};

          // Try very hard to get a real vessel name
          const fromSelected =
            (this.selectedVessel && (this.selectedVessel.VesselName || this.selectedVessel.name)) || null;

          const fromRequest =
            (req.vessel_name && req.vessel_name !== 'Unknown Vessel')
              ? String(req.vessel_name).trim()
              : null;

          const fromQuery =
            (this.vesselQuery && this.vesselQuery.trim().length)
              ? this.vesselQuery.trim()
              : null;

          const vesselName = fromSelected || fromRequest || fromQuery || null;

          const entry = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            portCode: this.selectedPort,
            portLabel: this.selectedPortContext?.label || this.selectedPort,
            vesselName: vesselName || 'Unknown Vessel',
            totals: estimate?.totals || null,
            request: { ...req },
          };

          this.estimateHistory = [entry, ...this.estimateHistory].slice(0, 5);
          this.persistEstimateHistory();
        },

        applyEstimateHistory(entry) {
          if (!entry) return;
          this.historyDropdownOpen = false;
          const req = entry.request || {};

          // restore vessel info for UX clarity
          this.vesselQuery = entry.vesselName || req.vessel_name || '';

          this.previousPortCode = req.previous_port_code || '';
          this.nextPortCode = req.next_port_code || '';
          this.eta = req.eta ? req.eta.split('T')[0] : this.eta;
          this.etd = req.etd ? req.etd.split('T')[0] : this.etd;
          this.daysAlongside = Number(req.days_alongside) || this.daysAlongside;
          this.grossTonnage = Number(req.gross_tonnage) || this.grossTonnage;
          this.netTonnage = Number(req.net_tonnage) || this.netTonnage;
          this.loaMeters = Number(req.loa_meters) || this.loaMeters;
          this.beamMeters = Number(req.beam_meters) || this.beamMeters;

          this.selectedPort = entry.portCode || '';
          this.syncPortQueryWithSelection();

          if (this.selectedPort) {
            const insightCode = this.selectedPortContext?.zoneCode || this.selectedPort;
            if (insightCode) {
              this.fetchPortInsights(insightCode);
            } else {
              this.selectedPortDetails = null;
            }
            this.loadDocumentRequirements();
          }
        },

        // Multi-port History
        initMpHistory() {
            try {
                const raw = localStorage.getItem('maritime_mp_history');
                this.mpHistory = raw ? JSON.parse(raw) : [];
            } catch (e) { this.mpHistory = []; }
        },
        saveMpHistory(ports = []) {
            const zones = ports.map(p => (typeof p === 'string' ? p : (p?.zoneCode || p?.portCode))).filter(Boolean);
            const label = zones.join('â†’');
            const entry = { id: Date.now(), label, zones };
            this.mpHistory = [entry, ...this.mpHistory].slice(0, 3);
            localStorage.setItem('maritime_mp_history', JSON.stringify(this.mpHistory));
        },
        applyMpHistory(entry) {
            const zones = entry?.zones || [];
            if (!zones.length) return;

            const findCtx = (code) => {
              const match = this.portSearchIndex.find(e => (e.zoneCode === code || e.portCode === code));
              return match ? this.makeSelectionContext(match) : null;
            };

            const arrivalCtx = findCtx(zones[0]);
            if (arrivalCtx) {
              this.selectedPortContext = arrivalCtx;
              this.selectedPort = arrivalCtx.zoneCode || arrivalCtx.portCode || '';
              this.portQuery = arrivalCtx.label || '';
              this.afterPortSelection();
            }

            this.stops = zones.slice(1).map((code) => {
              const ctx = findCtx(code);
              const stop = this.createStop();
              if (ctx) {
                stop.zoneCode = ctx.zoneCode || null;
                stop.portCode = ctx.portCode || null;
                stop.label = ctx.label || '';
                stop.description = ctx.description || '';
                stop.query = ctx.label || '';
              }
              return stop;
            });

            this.mpResult = null;
            this.mpExpandedLeg = null;
        },

        printEstimate() { window.print(); },

        // Multi-port methods
        createStop() {
          return {
            id: Date.now() + Math.random(),
            zoneCode: null,
            portCode: null,
            label: '',
            description: '',
            query: '',
            matches: [],
            showDropdown: false,
            daysInPort: 2,
          };
        },
        addStop() {
          if (!this.selectedPortContext) {
            alert('Select an arrival port first.');
            return;
          }
          if (this.stops.length >= 5) return;
          this.stops.push(this.createStop());
        },
        removeStop(idx) {
          this.stops.splice(idx, 1);
        },
        clearItinerary() {
          this.stops = [];
          this.mpResult = null;
          this.mpExpandedLeg = null;
        },
        searchStopPorts(idx) {
          const stop = this.stops[idx];
          if (!stop || !Array.isArray(this.portSearchIndex) || !this.portSearchIndex.length) return;

          const q = (stop.query || '').trim().toLowerCase();
          if (!q) {
            stop.matches = this.portSearchIndex.slice(0, 10);
            stop.showDropdown = true;
            return;
          }

          const tokens = q.split(/[^a-z0-9]+/g).filter(Boolean);
          if (!tokens.length) {
            stop.matches = this.portSearchIndex.slice(0, 10);
            stop.showDropdown = true;
            return;
          }

          const matches = this.rankPortMatches(tokens);
          stop.matches = matches;
          stop.showDropdown = matches.length > 0;
        },
        selectStopPort(idx, entry) {
          const stop = this.stops[idx];
          if (!stop || !entry) return;

          const ctx = this.makeSelectionContext(entry);
          stop.zoneCode = ctx.zoneCode || null;
          stop.portCode = ctx.portCode || null;
          stop.label = ctx.label || '';
          stop.description = ctx.description || '';
          stop.query = ctx.label || '';
          stop.matches = [];
          stop.showDropdown = false;
        },
        selectFirstStopResult(idx) {
          const stop = this.stops[idx];
          if (!stop || !stop.matches || !stop.matches.length) return;
          this.selectStopPort(idx, stop.matches[0]);
        },
        async submitMultiPort() {
          if (!this.selectedPortContext) {
            alert('Select an arrival port first.');
            return;
          }

          const initialCode = this.selectedPortContext.zoneCode || this.selectedPortContext.portCode;
          if (!initialCode) {
            alert('Could not resolve arrival port code.');
            return;
          }

          const stopCodes = this.stops
            .map(s => s.zoneCode || s.portCode)
            .filter(Boolean);

          if (!stopCodes.length) {
            alert('Add at least one stop to build a voyage.');
            return;
          }

          const ports = [initialCode, ...stopCodes];

          const mpFwdDraft = Number(this.draftForwardMeters) || 0;
          const mpAftDraft = Number(this.draftAftMeters) || 0;
          const mpAirDraft = Number(this.airDraftMeters) || 0;
          const mpDrafts = [mpFwdDraft, mpAftDraft].filter(v => v > 0);
          const mpRepresentativeDraft = mpDrafts.length
            ? Number((mpDrafts.reduce((sum, v) => sum + v, 0) / mpDrafts.length).toFixed(2))
            : (mpFwdDraft || mpAftDraft || 0);
          const toDraftString = (val) => (val > 0 ? String(val) : null);

          const vessel = {
            name: this.mpVesselName || this.selectedVessel?.VesselName || 'Unknown Vessel',
            imo_number: this.selectedVessel?.IMONumber || null,
            vessel_type: this.vesselType,
            gross_tonnage: String(this.grossTonnage || 0),
            net_tonnage: String(this.netTonnage || 0),
            loa_meters: String(this.loaMeters || 0),
            beam_meters: String(this.beamMeters || 0),
            draft_meters: String(mpRepresentativeDraft || 0),
            forward_draft_meters: toDraftString(mpFwdDraft),
            aft_draft_meters: toDraftString(mpAftDraft),
            air_draft_meters: toDraftString(mpAirDraft),
          };

          const request = {
            vessel_name: vessel.name,
            ports,
            start_date: this.eta || new Date().toISOString().split('T')[0],
            days_in_port: Number(this.daysAlongside) || 2,
          };

          try {
            this.mpExpandedLeg = null;
            const r = await fetch(`${API_BASE}/api/v2/voyage/multi-port`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ request, vessel })
            });
            if (!r.ok) throw new Error(await r.text());

            const raw = await r.json();

            let mp = raw;
            if (!Array.isArray(mp.legs)) {
              if (Array.isArray(raw?.voyage?.legs)) {
                mp = raw.voyage;
              } else if (Array.isArray(raw?.result?.legs)) {
                mp = raw.result;
              }
            }

            this.mpResult = mp;
            this.mpExpandedLeg = null;
            this.saveMpHistory(ports);
          } catch (e) {
            console.error('Multi-port failed:', e);
            alert('Failed to calculate multi-port voyage.');
          }
        },
        async calculateVoyage() {
          if (!this.selectedPort || !this.eta || !this.previousPortCode.trim()) {
            alert('Previous port, arrival port, and ETA are required.');
            return;
          }

          this.estimateLoading = true;
          try {
            await this.getEstimateV2();
            if (this.stops.length > 0) {
              await this.submitMultiPort();
            } else {
              this.mpResult = null;
            }
          } finally {
            this.estimateLoading = false;
          }
        },
        updateLegEta(leg, newDate) {
          if (!this.mpResult || !Array.isArray(this.mpResult.legs)) return;
          if (!newDate) return;

          const idx = this.mpResult.legs.findIndex(l => l.leg === leg.leg);
          if (idx === -1) return;

          const d = new Date(newDate);
          if (Number.isNaN(d.getTime())) return;

          let iso;
          try {
            const old = new Date(this.mpResult.legs[idx].eta);
            if (!Number.isNaN(old.getTime())) {
              old.setFullYear(d.getFullYear(), d.getMonth(), d.getDate());
              iso = old.toISOString();
            } else {
              iso = d.toISOString();
            }
          } catch (e) {
            iso = d.toISOString();
          }

          this.mpResult.legs[idx].eta = iso;
        },

        applyLegToVoyage(leg) {
          if (!leg) return;
          if (leg.eta) this.eta = this.formatIsoDate(leg.eta);
        },
        async refreshAll() {
          await this.checkHealth();
          if (this.selectedPort && this.eta) {
            await this.getEstimateV2();
            const insightCode = this.selectedPortContext?.zoneCode || this.selectedPort;
            if (insightCode) {
              await this.fetchPortInsights(insightCode);
            }
          }
        },
  
        async clearCache() {
          try { const r = await fetch(`${API_BASE}/admin/cache/clear`, { method: 'POST' }); if (r.ok) { await this.checkHealth(); alert('Cache cleared successfully'); } } catch (e) { console.error('Clear cache failed:', e); }
        }
      }
    }
  </script>
</body>
</html>
