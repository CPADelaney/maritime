<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Maritime MVP — Port Call Intelligence Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind + Alpine -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    @keyframes slideUp { from { transform: translateY(8px); opacity:.0 } to { transform: translateY(0); opacity:1 } }
    .animate-slide-up { animation: slideUp .25s ease-out forwards }
    .glass { background: rgba(255,255,255,.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px) }
    .card { border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,.06) }
    .chip { border-radius: 999px; padding: .125rem .5rem; font-size: .75rem }
    .btn { border-radius: .5rem; font-weight: 600; }
    .btn-primary { background:#4f46e5; color:#fff }
    .btn-primary:hover { background:#4338ca }
    .btn-soft { background:#eef2ff; color:#4338ca }
    .btn-soft:hover { background:#e0e7ff }
    .btn-outline { border:1px solid #e5e7eb; background:#fff }
    .btn-outline:hover { background:#f9fafb }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .75rem; background:#f3f4f6; padding:.125rem .375rem; border-radius:.375rem; border:1px solid #e5e7eb }
    .badge { display:inline-flex; align-items:center; gap:.375rem; padding:.25rem .5rem; border-radius:999px; font-size:.75rem; background:#f1f5f9; color:#334155 }
    .field { border:1px solid #e5e7eb; border-radius:.5rem; padding:.5rem .75rem }
    .field:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.15) }
    .list-scroll { max-height: 240px; overflow-y:auto }
    /* Tailwind line-clamp equivalent without plugin */
    .line-clamp-3 { display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-white min-h-screen text-slate-900">

  <script>
    // 1) Default to same-origin API; 2) set OVERRIDE_API_BASE to hard-code a remote API if needed.
    const OVERRIDE_API_BASE = ""; // e.g., "https://maritime-ee6i.onrender.com"
    const API_BASE = OVERRIDE_API_BASE || window.location.origin;
  </script>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6" x-data="portCallApp()" x-init="init()">

    <!-- Topbar -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold">⛴</div>
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold">Port Call Intelligence Platform</h1>
          <p class="text-slate-600 text-sm">Vessel search, fee estimation, and live compliance checks</p>
        </div>
      </div>
      <div class="text-sm text-right">
        <div>API: <span class="font-medium" :class="apiStatus === 'Online' ? 'text-green-600' : 'text-red-600'" x-text="apiStatus"></span></div>
        <div class="text-slate-500">Cache: <span x-text="cacheStats"></span></div>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Left Column -->
      <div class="space-y-4">

        <!-- Vessel Search -->
        <div class="glass card p-5 animate-slide-up">
          <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-5.5-5.5M10 18a8 8 0 100-16 8 8 0 000 16z"/></svg>
            Vessel Search
          </h2>

          <div class="space-y-3">
            <div class="flex gap-2">
              <input
                x-model="vesselQuery"
                @keyup.enter="searchVessel(1)"
                class="w-full field"
                placeholder="Enter vessel name…"
                :disabled="searchLoading"
              />
              <button
                @click="searchVessel(1)"
                :disabled="searchLoading || !vesselQuery.trim()"
                class="btn btn-primary px-3 py-2 disabled:opacity-50">
                <span x-show="!searchLoading">Search</span>
                <span x-show="searchLoading" class="inline-flex items-center gap-1">
                  <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                  Loading
                </span>
              </button>
            </div>

            <!-- Results -->
            <div x-show="vesselResults.length > 0" class="list-scroll space-y-2">
              <template x-for="(v, idx) in vesselResults" :key="v.VesselID ?? v.vesselid ?? idx">
                <button
                  @click="selectVessel(v)"
                  class="w-full text-left border border-gray-200 rounded-lg px-3 py-2 hover:bg-indigo-50 hover:border-indigo-300 transition-colors">
                  <div class="font-medium" x-text="v.VesselName || v.vesselname || '(unnamed)'"></div>
                  <div class="text-xs text-gray-500">
                    <span x-text="v.CallSign || '—'"></span> •
                    <span x-text="v.Flag || '—'"></span> •
                    <span x-text="v.VesselType || '—'"></span>
                  </div>
                </button>
              </template>
            </div>

            <!-- Empty / Error -->
            <div x-show="!searchLoading && vesselResults.length === 0 && vesselSearched" class="text-sm text-gray-500">
              No vessels found.
            </div>
            <div x-show="searchError" class="text-sm text-red-600" x-text="searchError"></div>

            <!-- Summary + Pagination -->
            <div class="flex items-center justify-between">
              <div x-show="vesselTotal > 0" class="text-xs text-gray-500">
                Showing <span x-text="vesselStart"></span>–<span x-text="vesselEnd"></span> of
                <span x-text="vesselTotal"></span>
              </div>
              <div x-show="vesselPages > 1" class="flex items-center gap-2">
                <button @click="prevVesselPage" :disabled="vesselPage <= 1" class="btn btn-outline px-2 py-1 disabled:opacity-50">Prev</button>
                <template x-if="vesselPage > 3"><button @click="goToVesselPage(1)" class="btn btn-outline px-2 py-1">1</button></template>
                <template x-if="vesselPage > 4"><span class="text-gray-400">…</span></template>
                <template x-for="p in pageWindow()" :key="p">
                  <button @click="goToVesselPage(p)" class="px-2 py-1 btn-outline btn"
                          :class="p === vesselPage ? 'bg-indigo-600 text-white border-indigo-600' : ''" x-text="p"></button>
                </template>
                <template x-if="vesselPage < vesselPages - 3"><span class="text-gray-400">…</span></template>
                <template x-if="vesselPage < vesselPages - 2">
                  <button @click="goToVesselPage(vesselPages)" class="btn btn-outline px-2 py-1" x-text="vesselPages"></button>
                </template>
                <button @click="nextVesselPage" :disabled="vesselPage >= vesselPages" class="btn btn-outline px-2 py-1 disabled:opacity-50">Next</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Selected Vessel -->
        <div x-show="selectedVessel" class="glass card p-5 animate-slide-up">
          <h3 class="text-lg font-semibold mb-3">Selected Vessel</h3>
          <div class="space-y-2 text-sm">
            <div><span class="text-gray-500">Name:</span> <span class="font-medium" x-text="selectedVessel?.VesselName"></span></div>
            <div><span class="text-gray-500">Call Sign:</span> <span x-text="selectedVessel?.CallSign || '—'"></span></div>
            <div><span class="text-gray-500">Flag:</span> <span x-text="selectedVessel?.Flag || '—'"></span></div>
            <div><span class="text-gray-500">Type:</span> <span x-text="selectedVessel?.VesselType || '—'"></span></div>
            <div x-show="selectedVessel?.YearBuilt"><span class="text-gray-500">Year Built:</span> <span x-text="selectedVessel.YearBuilt"></span></div>
            <div x-show="selectedVessel?.PrimaryIdentification"><span class="text-gray-500">Identification:</span> <span x-text="selectedVessel.PrimaryIdentification"></span></div>
            <div x-show="selectedVessel?.GrossTonnage"><span class="text-gray-500">Gross Tonnage:</span> <span x-text="selectedVessel.GrossTonnage"></span></div>
          </div>
        </div>

        <!-- Port & ETA + v1/v2 controls -->
        <div class="glass card p-5">
          <h3 class="text-lg font-semibold mb-3">Port & ETA</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Port (internal)</label>
              <select x-model="selectedPort" @change="loadLiveData" class="w-full field">
                <option value="">Select a port…</option>
                <template x-for="p in ports" :key="p.code">
                  <option :value="p.code" x-text="`${p.name} (${p.state || p.country})`"></option>
                </template>
              </select>
              <div class="text-xs text-slate-500 mt-1">Tip: LALB, SFBAY, PUGET, COLRIV, STKN</div>
              
              <!-- Show resolved internal code to reassure the user -->
              <div x-show="selectedPort" class="mt-1">
                <span class="chip bg-slate-100">Internal: <span x-text="selectedPort"></span></span>
              </div>

            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ETA</label>
              <input x-model="eta" type="date" class="w-full field" />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Arrival Type (v1)</label>
                <select x-model="arrivalType" class="w-full field">
                  <option value="FOREIGN">FOREIGN</option>
                  <option value="COASTWISE">COASTWISE</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Net Tonnage (v1)</label>
                <input x-model="netTonnage" type="number" class="w-full field" placeholder="Optional" />
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">YTD CBP Paid</label>
              <input x-model="ytdCbpPaid" type="number" step="0.01" class="w-full field" placeholder="0.00" />
            </div>

            <div class="pt-3 border-t">
              <div class="flex items-center gap-2 mb-3">
                <input id="useV2" type="checkbox" x-model="useV2" class="h-4 w-4">
                <label for="useV2" class="text-sm">Use comprehensive v2 estimator</label>
                <span class="kbd ml-2">New</span>
              </div>

              <div x-show="useV2" class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Previous Port (UN/LOCODE)</label>
                  <div class="relative">
                    <input x-model="previousPortCode" @input.debounce.250ms="searchUnloc('prev')" placeholder="e.g., USLAX or CNSHA" class="w-full field">
                    <!-- Clear previous UN/LOCODE -->
                    <button x-show="previousPortCode" @click="previousPortCode=''; unlocPrev=[]" type="button"
                            class="absolute right-2 top-2 text-gray-400 hover:text-gray-600" aria-label="Clear previous port">×</button>
                    <div x-show="unlocPrev.length" class="absolute z-10 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg w-full">
                      <template x-for="p in unlocPrev" :key="p.locode">
                        <div @click="previousPortCode = p.locode; unlocPrev=[]" class="px-3 py-2 hover:bg-gray-50 cursor-pointer text-sm">
                          <span class="font-medium" x-text="p.port_name"></span>
                          <span class="ml-2 chip bg-slate-100" x-text="p.locode"></span>
                          <span class="ml-2 text-xs text-gray-500" x-text="p.country_code"></span>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Next Port (UN/LOCODE)</label>
                  <div class="relative">
                    <input x-model="nextPortCode" @input.debounce.250ms="searchUnloc('next')" placeholder="Optional" class="w-full field">
                    <!-- Clear next UN/LOCODE -->
                    <button x-show="nextPortCode" @click="nextPortCode=''; unlocNext=[]" type="button"
                            class="absolute right-2 top-2 text-gray-400 hover:text-gray-600" aria-label="Clear next port">×</button>
                    <div x-show="unlocNext.length" class="absolute z-10 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg w-full">
                      <template x-for="p in unlocNext" :key="p.locode">
                        <div @click="nextPortCode = p.locode; unlocNext=[]" class="px-3 py-2 hover:bg-gray-50 cursor-pointer text-sm">
                          <span class="font-medium" x-text="p.port_name"></span>
                          <span class="ml-2 chip bg-slate-100" x-text="p.locode"></span>
                          <span class="ml-2 text-xs text-gray-500" x-text="p.country_code"></span>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ETD (optional)</label>
                    <input x-model="etd" type="date" class="w-full field" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Days Alongside</label>
                    <input x-model.number="daysAlongside" min="1" type="number" class="w-full field" />
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Vessel Type</label>
                  <select x-model="vesselType" class="w-full field">
                    <option value="general_cargo">General Cargo</option>
                    <option value="container">Container</option>
                    <option value="tanker">Tanker</option>
                    <option value="bulk_carrier">Bulk Carrier</option>
                    <option value="cruise">Cruise</option>
                    <option value="roro">Ro-Ro</option>
                    <option value="lng">LNG</option>
                    <option value="vehicle_carrier">Vehicle Carrier</option>
                  </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gross Tonnage</label>
                    <input x-model.number="grossTonnage" type="number" step="1" class="w-full field" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Net Tonnage</label>
                    <input x-model.number="netTonnage" type="number" step="1" class="w-full field" />
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">LOA (m)</label>
                    <input x-model.number="loaMeters" type="number" step="0.1" class="w-full field" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Draft (m)</label>
                    <input x-model.number="draftMeters" type="number" step="0.1" class="w-full field" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <button
            @click="useV2 ? getEstimateV2() : getEstimate()"
            :disabled="!selectedPort || !eta || estimateLoading || (useV2 && (!previousPortCode.trim() || !Number(grossTonnage) || !Number(netTonnage)))"
            class="w-full mt-4 px-4 py-2 btn btn-primary disabled:opacity-50">
            <span x-show="!estimateLoading">Calculate Estimate</span>
            <span x-show="estimateLoading">Calculating…</span>
          </button>
        </div>
      </div>

      <!-- Right Column -->
      <div class="lg:col-span-2 space-y-4">

        <!-- Alerts -->
        <div x-show="liveData?.alerts && liveData.alerts.length" class="bg-amber-50 border-l-4 border-amber-400 rounded-lg p-4 animate-slide-up">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-amber-800">Compliance Alerts</h4>
            <span class="badge">live</span>
          </div>
          <ul class="text-sm text-amber-800 space-y-1 mt-1">
            <template x-for="a in liveData.alerts" :key="a"><li x-text="a"></li></template>
          </ul>
        </div>

        <!-- Estimate v1 -->
        <div x-show="estimate && !estimateV2" class="glass card p-6 animate-slide-up">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold">Fee Estimate (v1)</h3>
            <div class="flex gap-2">
              <button @click="clientExport('csv')" class="text-sm btn btn-outline px-3 py-1.5">Export CSV</button>
              <button @click="clientExport('json')" class="text-sm btn btn-outline px-3 py-1.5">Export JSON</button>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Fee</th>
                  <th class="px-4 py-2 text-right text-xs font-semibold text-gray-600 uppercase">Amount</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                <template x-for="item in estimate.line_items" :key="item.code">
                  <tr>
                    <td class="px-4 py-2">
                      <div class="font-medium" x-text="item.name"></div>
                      <div class="text-xs text-gray-500" x-text="item.code"></div>
                    </td>
                    <td class="px-4 py-2 text-right font-mono" x-text="`$${item.amount}`"></td>
                  </tr>
                </template>
              </tbody>
              <tfoot class="border-t-2 border-gray-300">
                <tr>
                  <td class="px-4 py-2 font-semibold">Total Mandatory</td>
                  <td class="px-4 py-2 text-right font-bold text-lg" x-text="`$${estimate.total}`"></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div x-show="estimate.optional_services?.length" class="mt-4 pt-4 border-t">
            <h4 class="font-semibold mb-2">Optional Services (Estimates)</h4>
            <div class="space-y-2">
              <template x-for="s in estimate.optional_services" :key="s.service">
                <div class="flex justify-between text-sm">
                  <span>
                    <span x-text="s.service"></span>
                    <span class="text-xs text-gray-500" x-text="`(${s.note})`"></span>
                  </span>
                  <span class="font-mono" x-text="`$${Number(s.estimated_low).toLocaleString()} - $${Number(s.estimated_high).toLocaleString()}`"></span>
                </div>
              </template>
            </div>
            <div class="mt-3 pt-3 border-t flex justify-between font-semibold">
              <span>Total with Optional</span>
              <span x-text="`$${estimate.total_with_optional_low} - $${estimate.total_with_optional_high}`"></span>
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-4" x-text="estimate.disclaimer"></p>
        </div>

        <!-- Estimate v2 -->
        <div x-show="estimateV2" class="glass card p-6 animate-slide-up">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold">Fee Estimate (v2)</h3>
            <div class="text-xs text-slate-500">
              conf ~ <span x-text="estimateV2?.confidence"></span>
            </div>
          </div>

          <div class="text-sm text-gray-600 mb-3 grid sm:grid-cols-2 gap-x-6">
            <div>
              <div><span class="font-medium">Arrival:</span> <span x-text="estimateV2?.port?.name"></span> (<span x-text="estimateV2?.port?.resolved_internal_code"></span>)</div>
              <div><span class="font-medium">LOCODE:</span> <span x-text="estimateV2?.port?.arrival_unlocode || 'internal only'"></span></div>
            </div>
            <div>
              <div><span class="font-medium">Prev → Arr → Next:</span>
                <span x-text="estimateV2?.voyage?.previous_port"></span> →
                <span x-text="estimateV2?.voyage?.arrival_port"></span> →
                <span x-text="estimateV2?.voyage?.next_port || '—'"></span>
              </div>
              <div><span class="font-medium">ETA:</span> <span x-text="estimateV2?.voyage?.eta"></span></div>
            </div>
          </div>

          <div class="divide-y">
            <template x-for="c in (estimateV2?.calculations || [])" :key="c.code">
              <div class="py-2 flex items-start justify-between">
                <div class="pr-4">
                  <div class="font-medium" x-text="c.name"></div>
                  <div class="text-xs text-gray-500" x-text="c.details"></div>
                </div>
                <div class="text-right">
                  <div class="font-mono" x-text="'$' + c.final_amount"></div>
                  <div class="text-xs text-gray-500">conf: <span x-text="c.confidence"></span></div>
                </div>
              </div>
            </template>
          </div>

          <div class="mt-3 border-t pt-3 space-y-1">
            <div class="flex justify-between"><span>Mandatory</span><span class="font-mono" x-text="'$' + (estimateV2?.totals?.mandatory || '0.00')"></span></div>
            <div class="flex justify-between"><span>Optional (low)</span><span class="font-mono" x-text="'$' + (estimateV2?.totals?.optional_low || '0.00')"></span></div>
            <div class="flex justify-between"><span>Optional (high)</span><span class="font-mono" x-text="'$' + (estimateV2?.totals?.optional_high || '0.00')"></span></div>
            <div class="flex justify-between font-bold border-t pt-2">
              <span>Total (low)</span><span class="font-mono" x-text="'$' + (estimateV2?.totals?.total_low || '0.00')"></span>
            </div>
            <div class="flex justify-between font-bold">
              <span>Total (high)</span><span class="font-mono" x-text="'$' + (estimateV2?.totals?.total_high || '0.00')"></span>
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-4" x-text="estimateV2?.disclaimer"></p>
        </div>

        <!-- Live Data Tabs -->
        <div x-show="liveData" class="glass card p-6 animate-slide-up">
          <h3 class="text-xl font-semibold mb-4">Live Verification & References</h3>

          <div class="border-b border-gray-200">
            <nav class="flex space-x-6">
              <button @click="activeTab='documents'" :class="activeTab==='documents' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-gray-800'" class="pb-2 font-medium text-sm">Documents</button>
              <button @click="activeTab='pilotage'"  :class="activeTab==='pilotage'  ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-gray-800'" class="pb-2 font-medium text-sm">Pilotage</button>
              <button @click="activeTab='marine_exchange'" :class="activeTab==='marine_exchange' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-gray-800'" class="pb-2 font-medium text-sm">Marine Exchange</button>
              <button @click="activeTab='cofr'" :class="activeTab==='cofr' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-gray-800'" class="pb-2 font-medium text-sm">COFR</button>
              <button x-show="liveData.misp && Object.keys(liveData.misp).length" @click="activeTab='misp'"
                :class="activeTab==='misp' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-gray-800'" class="pb-2 font-medium text-sm">CA MISP</button>
            </nav>
          </div>

          <div class="mt-4">
            <!-- Documents -->
            <div x-show="activeTab==='documents'" class="space-y-3">
              <template x-for="d in liveData.documents" :key="d.name">
                <div class="border-l-4 border-blue-400 pl-3 py-2">
                  <div class="font-medium" x-text="d.name"></div>
                  <div class="text-sm text-gray-600">
                    <span x-show="d.expires_on">Expires: <span x-text="d.expires_on"></span></span>
                    <span x-show="d.status" class="ml-3">Status: <span x-text="d.status"></span></span>
                    <span class="ml-3 text-xs">Source: <span x-text="d.source"></span></span>
                  </div>
                </div>
              </template>
              <div x-show="!liveData.documents?.length" class="text-gray-500">No documents found in PSIX</div>
            </div>

            <!-- Pilotage -->
            <div x-show="activeTab==='pilotage'" class="space-y-3">
              <template x-for="(pilot, key) in liveData.pilotage" :key="key">
                <div class="border rounded-lg p-3">
                  <div class="font-medium" x-text="pilot.provider || pilot.title"></div>
                  <a :href="pilot.url" target="_blank" class="text-sm text-indigo-600 hover:text-indigo-800 underline" x-text="pilot.url"></a>
                  <div class="text-sm text-gray-600 mt-2">
                    <span x-show="pilot.vhf_channel">VHF: Ch <span x-text="pilot.vhf_channel"></span></span>
                    <span x-show="pilot.boarding_grounds" class="ml-3">Boarding: <span x-text="pilot.boarding_grounds"></span></span>
                    <span x-show="pilot.max_draft" class="ml-3">Max Draft: <span x-text="pilot.max_draft"></span></span>
                  </div>
                  <div x-show="pilot.pdf_links?.length" class="mt-2">
                    <span class="text-xs text-gray-500">PDFs:</span>
                    <template x-for="pdf in pilot.pdf_links" :key="pdf">
                      <a :href="pdf" target="_blank" class="text-xs text-indigo-600 hover:text-indigo-800 underline ml-2" x-text="pdf.split('/').pop()"></a>
                    </template>
                  </div>
                </div>
              </template>
            </div>

            <!-- Marine Exchange -->
            <div x-show="activeTab==='marine_exchange'" class="space-y-3">
              <template x-for="(mx, key) in liveData.marine_exchange" :key="key">
                <div class="border rounded-lg p-3">
                  <div class="font-medium" x-text="mx.provider || mx.title"></div>
                  <a :href="mx.url" target="_blank" class="text-sm text-indigo-600 hover:text-indigo-800 underline" x-text="mx.url"></a>
                  <div x-show="mx.text_sample" class="text-sm text-gray-600 mt-2 line-clamp-3" x-text="mx.text_sample"></div>
                </div>
              </template>
            </div>

            <!-- COFR -->
            <div x-show="activeTab==='cofr'" class="space-y-3">
              <div class="border rounded-lg p-3">
                <div class="font-medium">Certificate of Financial Responsibility</div>
                <a :href="liveData.cofr?.entrypoint" target="_blank" class="text-sm text-indigo-600 hover:text-indigo-800 underline">COFR Vessel Search</a>
                <div x-show="liveData.cofr?.search_guidance?.length" class="mt-2 text-sm text-gray-600">
                  <div class="font-medium">Search Guidance:</div>
                  <ul class="list-disc list-inside">
                    <template x-for="g in liveData.cofr.search_guidance" :key="g"><li x-text="g"></li></template>
                  </ul>
                </div>
                <div class="mt-2 text-sm text-gray-600">
                  <div class="font-medium">Requirements:</div>
                  <ul class="list-disc list-inside">
                    <li>Tankers over 300 GT: Required</li>
                    <li>All vessels over 400 GT: Required</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- MISP -->
            <div x-show="activeTab==='misp'" class="space-y-3">
              <div class="border rounded-lg p-3">
                <div class="font-medium" x-text="liveData.misp?.program"></div>
                <div class="text-sm text-gray-600 mt-2">
                  <div>Current Fee: <span class="font-mono" x-text="liveData.misp?.current_fee"></span></div>
                  <div x-show="liveData.misp?.exemptions?.length" class="mt-2">
                    Exemptions:
                    <ul class="list-disc list-inside">
                      <template x-for="ex in liveData.misp.exemptions" :key="ex"><li x-text="ex"></li></template>
                    </ul>
                  </div>
                </div>
                <div x-show="liveData.misp?.pages?.length" class="mt-3">
                  <div class="text-xs text-gray-500">Resources:</div>
                  <template x-for="pg in liveData.misp.pages" :key="pg.url">
                    <a :href="pg.url" target="_blank" class="text-sm text-indigo-600 hover:text-indigo-800 underline block" x-text="pg.title || pg.url"></a>
                  </template>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="flex gap-2 justify-end">
          <button @click="refreshAll" class="text-sm btn btn-outline px-3 py-1.5">Refresh All Data</button>
          <button @click="clearCache" class="text-sm btn btn-outline px-3 py-1.5">Clear Cache</button>
        </div>
      </div>
    </div>

    <footer class="mt-12 pt-8 border-t border-gray-200 text-center text-sm text-gray-500">
      <p>Maritime MVP v2.x | Data sources: USCG PSIX, CBP, APHIS, CA SLC</p>
      <p class="mt-1">Estimates are for reference only. Verify with official sources.</p>
    </footer>
  </div>

  <!-- Single, clean JS block -->
  <script>
    function portCallApp() {
      return {
        // status
        apiStatus: 'Checking…',
        cacheStats: '',

        // search & paging
        vesselQuery: '',
        vesselSearched: false,
        searchLoading: false,
        searchError: null,
        vesselResults: [],
        vesselPage: 1,
        vesselLimit: 25,
        vesselPages: 1,
        vesselTotal: 0,
        vesselStart: 0,
        vesselEnd: 0,

        // selection & forms
        selectedVessel: null,
        ports: [],
        selectedPort: '',
        eta: new Date().toISOString().split('T')[0],
        arrivalType: 'FOREIGN',
        netTonnage: '',
        ytdCbpPaid: '0',

        // v2 fields
        useV2: false,
        previousPortCode: '',
        nextPortCode: '',
        etd: '',
        daysAlongside: 2,
        vesselType: 'general_cargo',
        grossTonnage: 0,
        loaMeters: 0,
        draftMeters: 0,

        // UN/LOCODE suggestions
        unlocPrev: [],
        unlocNext: [],

        // results
        estimate: null,
        estimateV2: null,
        estimateLoading: false,
        liveData: null,
        activeTab: 'documents',

        async init() {
          await this.checkHealth();
          await this.loadPorts();
        },

        async checkHealth() {
          try {
            const r = await fetch(`${API_BASE}/health`);
            const d = await r.json();
            this.apiStatus = d.ok ? 'Online' : 'Offline';
            this.cacheStats = d.cache_stats ? `${d.cache_stats.active_entries} cached` : '';
          } catch (e) {
            this.apiStatus = 'Error';
            console.error('Health failed:', e);
          }
        },

        async loadPorts() {
          try {
            const r = await fetch(`${API_BASE}/ports`);
            this.ports = await r.json();
          } catch (e) {
            console.error('Ports load failed:', e);
          }
        },

        // Normalize/augment vessel row so UI keys always exist
        augment(v) {
          const out = { ...v };
          const pick = (...cands) => {
            for (const c of cands) {
              if (c in out && out[c] != null) {
                const s = String(out[c]).trim();
                if (s && s.toLowerCase() !== 'none') return s;
              }
            }
            return null;
          };
          const scanByKey = (obj, keyRegex, accept = (val) => String(val).trim() !== '') => {
            for (const [k, val] of Object.entries(obj)) {
              if (val == null) continue;
              if (keyRegex.test(k)) {
                const s = String(val).trim();
                if (accept(s)) return s;
              }
            }
            return null;
          };

          out.VesselID   = pick('VesselID','vesselid','ID','id');
          out.VesselName = pick('VesselName','vesselname','Name','name') ?? '(unnamed)';
          out.CallSign   = pick('VesselCallSign','CallSign','Call_Sign','RadioCallSign','radio_callsign','callSign')
                           ?? scanByKey(out, /(call.?sign|radio.?call)/i);
          out.Flag       = pick('CountryLookupName','Flag','FlagName','FlagOfRegistry','FlagState','FlagCountry','FlagCode','flag')
                           ?? scanByKey(out, /(flag|country).*(name|lookup|state|country)?/i, v => isNaN(v));
          out.VesselType = pick('ServiceType','VesselType','VesselTypeDescription','VesselService','Service','ShipType','vesseltype')
                           ?? scanByKey(out, /(service|type)/i, v => isNaN(v) && String(v).length < 80);
          out.GrossTonnage = pick('GrossTonnage','GT','Gross_Tonnage','grosstonnage','GrossTons','GrossTonnageText')
                             ?? scanByKey(out, /(gross.*ton|^gt$)/i);
          out.NetTonnage   = pick('NetTonnage','nettonnage','NT','Net_Tonnage')
                             ?? scanByKey(out, /(net.*ton|^nt$)/i);
          out.YearBuilt    = pick('ConstructionCompletedYear','YearBuilt','BuildYear','build_year');
          out.Status       = pick('StatusLookupName','Status','VesselStatus');
          out.PrimaryIdentification = pick('PrimaryIdentification','Identification','primary_identification');
          out.OfficialNumber        = pick('OfficialNumber','OfficialNumberText','Official_No','USOfficialNumber');
          out.IMONumber             = pick('IMONumber','IMO','IMONo','ImoNumber','IMO_Number');
          return out;
        },

        // --- Vessel search with server pagination + augmentation ---
        async searchVessel(page = 1) {
          if (!this.vesselQuery.trim()) return;

          this.vesselSearched = true;
          this.searchLoading = true;
          this.searchError = null;
          this.vesselPage = page;

          try {
            const params = new URLSearchParams({
              name: this.vesselQuery,
              page: String(this.vesselPage),
              limit: String(this.vesselLimit),
            });

            const r = await fetch(`${API_BASE}/vessels/search?${params}`);
            if (!r.ok) throw new Error('Search failed');
            const data = await r.json();

            const raw = Array.isArray(data.Table) ? data.Table : [];
            const augmented = raw.map(this.augment.bind(this));

            this.vesselTotal = (typeof data.total === 'number') ? data.total : augmented.length;
            this.vesselPages = (typeof data.pages === 'number')
              ? data.pages
              : Math.max(Math.ceil(this.vesselTotal / this.vesselLimit), 1);

            // API returns already paginated rows; just assign
            this.vesselResults = augmented;

            // Human bounds
            const startIdx = (this.vesselPage - 1) * this.vesselLimit;
            this.vesselStart = this.vesselTotal ? (data.start ?? startIdx + 1) : 0;
            this.vesselEnd = data.end ?? Math.min(startIdx + this.vesselResults.length, this.vesselTotal);

            if (this.vesselResults.length === 0) this.searchError = 'No vessels found';
          } catch (e) {
            this.searchError = e.message || 'Search failed';
            console.error('Vessel search failed:', e);
          } finally {
            this.searchLoading = false;
          }
        },

        prevVesselPage() { if (this.vesselPage > 1) this.searchVessel(this.vesselPage - 1); },
        nextVesselPage() { if (this.vesselPage < this.vesselPages) this.searchVessel(this.vesselPage + 1); },
        goToVesselPage(p) { if (p >= 1 && p <= this.vesselPages) this.searchVessel(p); },
        pageWindow() {
          const win = 2; // current ±2
          const start = Math.max(1, this.vesselPage - win);
          const end = Math.min(this.vesselPages, this.vesselPage + win);
          const arr = [];
          for (let i = start; i <= end; i++) arr.push(i);
          return arr;
        },

        selectVessel(v) {
          this.selectedVessel = this.augment(v);
          if (this.selectedPort) this.loadLiveData();
        },

        // ----- v1 estimator (GET /estimate) -----
        async getEstimate() {
          if (!this.selectedPort || !this.eta) return;
          this.estimateLoading = true;
          this.estimate = null;
          this.estimateV2 = null;

          const params = new URLSearchParams({
            port_code: this.selectedPort,
            eta: this.eta,
            arrival_type: this.arrivalType,
            include_optional: 'true'
          });
          if (this.netTonnage) params.set('net_tonnage', this.netTonnage);
          if (this.ytdCbpPaid) params.set('ytd_cbp_paid', this.ytdCbpPaid);

          try {
            const r = await fetch(`${API_BASE}/estimate?${params}`);
            if (!r.ok) throw new Error('Estimate failed');
            this.estimate = await r.json();
            if (this.selectedVessel) await this.loadLiveData();
          } catch (e) {
            console.error('Estimate failed:', e);
            alert('Failed to calculate estimate: ' + (e.message || 'request error'));
          } finally {
            this.estimateLoading = false;
          }
        },

        // ----- v2 estimator (POST /v2/estimate) -----
        async getEstimateV2() {
          if (!this.selectedPort || !this.eta || !this.previousPortCode.trim()) {
            alert('Previous port (UN/LOCODE), arrival port, and ETA are required for v2.');
            return;
          }
          this.estimateLoading = true;
          this.estimate = null;
          this.estimateV2 = null;

          const body = {
            vessel_name: this.selectedVessel?.VesselName || this.vesselQuery || 'Unknown Vessel',
            vessel_type: this.vesselType,
            gross_tonnage: String(this.grossTonnage || 0),
            net_tonnage: String(this.netTonnage || 0),
            loa_meters: String(this.loaMeters || 0),
            draft_meters: String(this.draftMeters || 0),
            previous_port_code: this.previousPortCode.trim().toUpperCase(),  // UN/LOCODE
            arrival_port_code: this.selectedPort,                              // internal code from /ports
            next_port_code: this.nextPortCode ? this.nextPortCode.trim().toUpperCase() : null,
            eta: this.eta ? new Date(this.eta).toISOString() : null,
            etd: this.etd ? new Date(this.etd).toISOString() : null,
            days_alongside: Number(this.daysAlongside) || 2,
            ytd_cbp_paid: String(this.ytdCbpPaid || 0),
            tonnage_year_paid: "0"
          };

          try {
            const r = await fetch(`${API_BASE}/v2/estimate`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });
            if (!r.ok) {
              const t = await r.text();
              throw new Error(t || 'v2 estimate failed');
            }
            this.estimateV2 = await r.json();
            if (this.selectedVessel) await this.loadLiveData();
          } catch (e) {
            console.error('v2 estimate failed:', e);
            alert('Failed to calculate v2 estimate.');
          } finally {
            this.estimateLoading = false;
          }
        },

        // Live bundle (pilotage, marine exchange, docs, COFR, MISP)
        async loadLiveData() {
          if (!this.selectedVessel || !this.selectedPort) return;

          const params = new URLSearchParams({
            vessel_name: this.selectedVessel.VesselName || '',
            port_code: this.selectedPort
          });
          const vid = this.selectedVessel.VesselID;
          if (vid) params.set('vessel_id', vid);

          try {
            const r = await fetch(`${API_BASE}/live/portbundle?${params}`);
            if (!r.ok) throw new Error('Live data failed');
            this.liveData = await r.json();
          } catch (e) {
            console.error('Live data failed:', e);
          }
        },

        // UN/LOCODE typeahead for previous/next ports
        async searchUnloc(current = 'prev') {
          const q = (current === 'prev' ? this.previousPortCode : this.nextPortCode).trim();
          if (q.length < 2) {
            if (current === 'prev') this.unlocPrev = [];
            else this.unlocNext = [];
            return;
          }
          try {
            const r = await fetch(`${API_BASE}/imo_ports/search?q=${encodeURIComponent(q)}&limit=8`);
            if (!r.ok) throw new Error('UN/LOCODE search failed');
            const rows = await r.json();
            if (current === 'prev') this.unlocPrev = rows;
            else this.unlocNext = rows;
          } catch (e) {
            console.error('UN/LOCODE search error:', e);
          }
        },

        // Client-side export (CSV/JSON) of the current estimate
        clientExport(format = 'csv') {
          // Prefer v2 if available
          if (this.estimateV2) {
            if (format === 'json') {
              const blob = new Blob([JSON.stringify(this.estimateV2, null, 2)], { type: 'application/json' });
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = `estimate_v2_${this.selectedPort}_${this.eta}.json`;
              a.click();
              return;
            }
            // CSV for v2
            const rows = [['Code','Name','Final Amount','Base','Confidence','Optional','Details']];
            for (const c of (this.estimateV2.calculations || [])) {
              rows.push([
                c.code, c.name, c.final_amount, c.base_amount, c.confidence,
                c.is_optional ? 'yes' : 'no',
                (c.details || '').replace(/\n/g, ' ')
              ]);
            }
            
            // Totals (if present)
            const t = this.estimateV2?.totals;
            if (t && Object.keys(t).length) {
              rows.push(['', 'TOTAL MANDATORY', t.mandatory ?? '', '', '', '', '']);
              rows.push(['', 'TOTAL LOW', t.total_low ?? '', '', '', '', '']);
              rows.push(['', 'TOTAL HIGH', t.total_high ?? '', '', '', '', '']);
            }
            
            // Quick totals (if present)
            const q = this.estimateV2?.quick_totals;
            if (q && Object.keys(q).length) {
              rows.push(['', 'QUICK MANDATORY', q.mandatory ?? '', '', '', '', '']);
              rows.push(['', 'QUICK WITH OPTIONAL LOW', q.with_optional_low ?? '', '', '', '', '']);
              rows.push(['', 'QUICK WITH OPTIONAL HIGH', q.with_optional_high ?? '', '', '', '', '']);
            }
            
            const csv = rows.map(r => r.map(x => `"${String(x ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `estimate_v2_${this.selectedPort}_${this.eta}.csv`;
            a.click();
            return;

          }

          // v1 export
          if (!this.estimate) return;
          if (format === 'json') {
            const blob = new Blob([JSON.stringify(this.estimate, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `estimate_v1_${this.selectedPort}_${this.eta}.json`;
            a.click();
            return;
          }
          const rows = [['Code','Name','Amount']];
          for (const item of (this.estimate.line_items || [])) {
            rows.push([item.code, item.name, item.amount]);
          }
          rows.push(['TOTAL','','' + (this.estimate.total || '0.00')]);
          const csv = rows.map(r => r.map(x => `"${String(x ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `estimate_v1_${this.selectedPort}_${this.eta}.csv`;
          a.click();
        },

        async refreshAll() {
          await this.checkHealth();
          if (this.selectedPort && this.eta) {
            if (this.useV2) await this.getEstimateV2();
            else await this.getEstimate();
          }
        },

        async clearCache() {
          try {
            const r = await fetch(`${API_BASE}/admin/cache/clear`, { method: 'POST' });
            if (r.ok) {
              await this.checkHealth();
              alert('Cache cleared successfully');
            }
          } catch (e) {
            console.error('Clear cache failed:', e);
          }
        }
      }
    }
  </script>

</body>
</html>
